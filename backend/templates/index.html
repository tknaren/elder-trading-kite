<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Trading System v2</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0a0f1a; font-family: 'Inter', sans-serif; font-size: 14px; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        /* Consistent table base sizing */
        table th, table td { font-size: inherit; }
        input, select, textarea { font-size: inherit; }
    </style>
</head>
<body class="bg-[#0a0f1a] text-gray-100 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-56 bg-[#111827] border-r border-gray-700 h-screen fixed flex flex-col">
            <div class="p-4 border-b border-gray-700 flex-shrink-0">
                <h1 class="font-bold text-lg flex items-center gap-2">üìà Elder Trading</h1>
                <p class="text-xs text-gray-500">Triple Screen v2.0</p>
            </div>
            <nav class="p-2 overflow-y-auto flex-1" id="nav"></nav>
        </aside>

        <!-- Main -->
        <main class="ml-56 flex-1 min-h-screen">
            <header class="h-14 bg-[#111827] border-b border-gray-700 px-6 flex items-center justify-between sticky top-0 z-10">
                <div id="header-stats" class="flex gap-6 text-sm"></div>
                <div class="flex items-center gap-4">
                    <div id="market-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400"></div>
                    <div id="kite-status" class="text-xs px-2 py-1 rounded cursor-pointer"></div>
                    <button onclick="switchTab('market-engine')" class="relative text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 cursor-pointer" title="Engine Notifications">
                        üîî <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center"></span>
                    </button>
                    <span class="text-xs text-gray-500">üáÆüá≥ NSE</span>
                </div>
                <!-- Hidden market field for backward compatibility -->
                <input type="hidden" id="market" value="IN">
            </header>
            <div class="p-6" id="content"></div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 z-50"></div>
    <div id="modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#111827] rounded-xl border border-gray-700 max-w-4xl w-full max-h-[90vh] overflow-auto" id="modal-body"></div>
    </div>

    <script>
    const API = '/api';
    let currentTab = 'journal-dashboard';
    let selectedStock = null;  // Store stock for trade bill creation
    let settings = [];
    let weeklyData = null;
    let checklist = {};
    let isLoading = false;  // Track loading state

    const tabs = [
        {id:'journal-dashboard', icon:'üìà', label:'Dashboard'},
        {section: 'Market Monitor', items: [
            {id:'trading-watchlist', icon:'üëÅÔ∏è', label:'Watchlist'},
            {id:'alert-manager', icon:'üîî', label:'Alerts'},
            {id:'market-engine', icon:'‚ö°', label:'Engine'}
        ]},
        {section: 'Screeners', items: [
            {id:'screener', icon:'üîç', label:'Screener'},
            {id:'backtest', icon:'üìä', label:'Signal Scanner'},
            {id:'candlestick-screener', icon:'üïØÔ∏è', label:'Candlestick'},
            {id:'rsi-macd-screener', icon:'üìà', label:'RSI+MACD'},
            {id:'gss-screener', icon:'üéØ', label:'GSS'}
        ]},
        {section: 'Trade Bill', items: [
            {id:'trade-bill', icon:'üíº', label:'Trade Bill'},
            {id:'trade-bills', icon:'üìã', label:'Trade Bills'}
        ]},
        {section: 'Trade Journal', items: [
            {id:'trade-log', icon:'üìù', label:'Trade Log'},
            {id:'trade-summary', icon:'üìä', label:'Trade Summary'}
        ]},
        {id:'orders', icon:'üì¶', label:'Orders'},
        {id:'positions-holdings', icon:'üè¶', label:'Portfolio'},
        {id:'pnl-tracker', icon:'üíµ', label:'P&L Tracker'},
        {id:'mistakes', icon:'‚ö†Ô∏è', label:'Mistakes'},
        {id:'favorites', icon:'‚≠ê', label:'Favorites'},
        {id:'account', icon:'üí∞', label:'Account'},
        {id:'checklist', icon:'‚úÖ', label:'Checklist'},
        {id:'settings', icon:'‚öôÔ∏è', label:'Settings'}
    ];

    async function api(method, url, data) {
        const opts = {method, headers:{'Content-Type':'application/json'}};
        if(data) opts.body = JSON.stringify(data);
        return (await fetch(API+url, opts)).json();
    }

    // Sound alert using Web Audio API
    function playAlertSound(type='info') {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.value = 0.15;

            if (type === 'success') {
                osc.frequency.value = 880; // High A - pleasant
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            } else if (type === 'error') {
                osc.frequency.value = 220; // Low A - alert
                osc.type = 'square';
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } else if (type === 'alert') {
                // Triple beep for alerts
                for (let i = 0; i < 3; i++) {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g);
                    g.connect(ctx.destination);
                    o.frequency.value = 1200;
                    o.type = 'sine';
                    g.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.2);
                    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.2 + 0.12);
                    o.start(ctx.currentTime + i * 0.2);
                    o.stop(ctx.currentTime + i * 0.2 + 0.12);
                }
            } else {
                osc.frequency.value = 660; // E - neutral
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.2);
            }
        } catch(e) { /* Audio not supported */ }
    }

    function toast(msg, type='info') {
        const el = document.createElement('div');
        el.className = `px-4 py-2 rounded-lg mb-2 ${type==='success'?'bg-green-600':type==='error'?'bg-red-600':type==='alert'?'bg-yellow-600':'bg-blue-600'}`;
        el.textContent = msg;
        document.getElementById('toast').appendChild(el);
        setTimeout(() => el.remove(), type === 'alert' ? 6000 : 3000);
        // Play sound for important notifications
        if (type === 'error' || type === 'alert' || type === 'success') {
            playAlertSound(type);
        }
    }

    // Export trades to CSV
    async function exportTrades() {
        await exportCSVData('trade-journal');
    }

    // ========== UNIVERSAL CSV IMPORT / EXPORT ==========
    async function exportCSVData(entity) {
        try {
            const resp = await fetch(`/api/v2/export/${entity}`);
            if (!resp.ok) { const err = await resp.json(); toast(err.error || 'Export failed', 'error'); return; }
            const csv = await resp.text();
            if (!csv.trim()) { toast('No data to export', 'error'); return; }
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${entity}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            toast(`${entity} exported!`, 'success');
        } catch(e) {
            toast('Export error: ' + e.message, 'error');
        }
    }

    async function importCSVData(entity) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            try {
                const resp = await fetch(`/api/v2/import/${entity}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/csv'},
                    body: text
                });
                const result = await resp.json();
                if (result.success) {
                    toast(`Imported ${result.imported} records!`, 'success');
                    await render();
                } else {
                    toast(result.error || 'Import failed', 'error');
                }
            } catch(err) {
                toast('Import error: ' + err.message, 'error');
            }
        };
        input.click();
    }

    // ========== AUTO-FILL DAY HIGH/LOW ==========
    async function autoFillDayRange(type, index) {
        // type = 'entry' or 'exit'
        const dateEl = document.getElementById(`tl-new-${type}-date`);
        const ticker = document.getElementById('tl-ticker')?.value;
        if (!ticker || !dateEl?.value) return;

        const dateVal = dateEl.value.split('T')[0]; // extract date from datetime-local
        try {
            const resp = await fetch(`/api/v2/ohlcv/day-range/${encodeURIComponent(ticker)}?date=${dateVal}`);
            const data = await resp.json();
            if (data.high && data.low) {
                document.getElementById(`tl-new-${type}-high`).value = data.high;
                document.getElementById(`tl-new-${type}-low`).value = data.low;
                // Auto-calculate grade after filling day range
                autoCalcGradeLocal(type);
                toast(`Day range filled: H=${data.high} L=${data.low}`, 'info');
            }
        } catch(e) { /* silently fail - OHLCV data may not be available */ }
    }

    // ========== AUTO-CALCULATE GRADE ==========
    function autoCalcGradeLocal(type) {
        const priceEl = document.getElementById(`tl-new-${type}-fillprice`) || document.getElementById(`tl-new-${type}-ordprice`);
        const highEl = document.getElementById(`tl-new-${type}-high`);
        const lowEl = document.getElementById(`tl-new-${type}-low`);
        const gradeEl = document.getElementById(`tl-new-${type}-grade`);
        const directionEl = document.getElementById('tl-direction');

        const price = parseFloat(priceEl?.value);
        const high = parseFloat(highEl?.value);
        const low = parseFloat(lowEl?.value);
        const direction = directionEl?.value || 'Long';

        if (!price || !high || !low || high <= low) return;

        const range = high - low;
        const position = (price - low) / range; // 0 = bottom, 1 = top

        let grade;
        if (direction === 'Long') {
            // Long: A = bottom 33%, B = middle 33%, C = top 33%
            grade = position <= 0.33 ? 'A' : position <= 0.66 ? 'B' : 'C';
        } else {
            // Short: A = top 33%, B = middle 33%, C = bottom 33%
            grade = position >= 0.66 ? 'A' : position >= 0.33 ? 'B' : 'C';
        }

        if (gradeEl) gradeEl.value = grade;
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadIndicatorFilters();
    });

    // Track which nav sections are expanded (default: all collapsed except active section)
    let navExpanded = {};

    function toggleNavSection(section) {
        navExpanded[section] = !navExpanded[section];
        renderNav();
    }

    function renderNav() {
        // Auto-expand the section containing the current tab
        tabs.forEach(t => {
            if (t.section && t.items) {
                const hasActive = t.items.some(item => item.id === currentTab);
                if (hasActive && navExpanded[t.section] === undefined) {
                    navExpanded[t.section] = true;
                }
            }
        });

        const navHtml = tabs.map(t => {
            if (t.section) {
                const isExpanded = navExpanded[t.section] || false;
                const hasActive = t.items.some(item => item.id === currentTab);
                const arrow = isExpanded ? '‚ñæ' : '‚ñ∏';
                return `
                    <div class="mb-1">
                        <button onclick="toggleNavSection('${t.section}')" class="w-full text-left px-3 py-1.5 flex items-center justify-between text-xs uppercase font-semibold ${hasActive ? 'text-blue-400' : 'text-gray-500'} hover:text-gray-300">
                            <span>${t.section}</span>
                            <span class="text-[10px]">${arrow}</span>
                        </button>
                        ${isExpanded ? t.items.map(item => `
                            <button onclick="switchTab('${item.id}')" class="w-full text-left px-3 py-1.5 pl-5 rounded-lg mb-0.5 flex items-center gap-2 text-sm ${currentTab===item.id?'bg-blue-600/30 text-blue-400':'text-gray-400 hover:bg-gray-700/50'}">
                                ${item.icon} ${item.label}
                            </button>
                        `).join('') : ''}
                    </div>
                `;
            } else {
                return `
                    <button onclick="switchTab('${t.id}')" class="w-full text-left px-3 py-1.5 rounded-lg mb-0.5 flex items-center gap-2 text-sm ${currentTab===t.id?'bg-blue-600/30 text-blue-400':'text-gray-400 hover:bg-gray-700/50'}">
                        ${t.icon} ${t.label}
                    </button>
                `;
            }
        }).join('');
        document.getElementById('nav').innerHTML = navHtml;
    }

    function renderHeader() {
        const s = settings[0] || {trading_capital:500000, risk_per_trade:2, currency:'INR'};
        const sym = '‚Çπ';  // Always INR for NSE
        document.getElementById('header-stats').innerHTML = `
            <div><span class="text-gray-500">Capital:</span> <span class="font-mono text-blue-400">${sym}${s.trading_capital?.toLocaleString()}</span></div>
            <div><span class="text-gray-500">Max Risk:</span> <span class="font-mono text-red-400">${sym}${(s.trading_capital*s.risk_per_trade/100).toFixed(0)}</span></div>
        `;
    }

    async function switchTab(tab) { currentTab = tab; renderNav(); await render(); }

    async function render() {
        const c = document.getElementById('content');
        if(currentTab==='screener') c.innerHTML = screenView();
        else if(currentTab==='backtest') c.innerHTML = await backtestView();
        else if(currentTab==='candlestick-screener') c.innerHTML = candlestickScreenerView();
        else if(currentTab==='rsi-macd-screener') c.innerHTML = rsiMacdScreenerView();
        else if(currentTab==='gss-screener') c.innerHTML = gssScreenerView();
        else if(currentTab==='trading-watchlist') c.innerHTML = await tradingWatchlistView();
        else if(currentTab==='alert-manager') c.innerHTML = await alertManagerView();
        else if(currentTab==='market-engine') c.innerHTML = await marketEngineView();
        else if(currentTab==='trade-bill') { c.innerHTML = tradeBillView(); triggerTradeBillCalc(); }
        else if(currentTab==='trade-bills') c.innerHTML = await tradeBillsView();
        else if(currentTab==='journal-dashboard') c.innerHTML = await journalDashboardView();
        else if(currentTab==='trade-log') { c.innerHTML = await tradeLogView(); fetchNotionalPnL(); }
        else if(currentTab==='trade-summary') c.innerHTML = await tradeSummaryView();
        else if(currentTab==='orders') c.innerHTML = await ordersView();
        else if(currentTab==='positions-holdings') c.innerHTML = await positionsHoldingsView();
        else if(currentTab==='pnl-tracker') c.innerHTML = await pnlTrackerView();
        else if(currentTab==='mistakes') c.innerHTML = await mistakesView();
        else if(currentTab==='favorites') c.innerHTML = await favoritesView();
        else if(currentTab==='account') c.innerHTML = await accountView();
        else if(currentTab==='checklist') c.innerHTML = checklistView();
        else if(currentTab==='settings') { c.innerHTML = settingsView(); loadDataStatus(); loadMistakesList(); loadStrategiesList(); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MARKET MONITOR ‚Äî Trading Watchlist + Alerts + Engine
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function tradingWatchlistView() {
        let html = '';
        try {
            const resp = await fetch('/api/v2/trading-watchlist');
            const data = await resp.json();
            const wl = data.watchlist;
            const symbols = data.symbols || [];
            const rows = data.data || [];

            html = `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold">Trading Watchlist</h2>
                        <p class="text-gray-500 text-sm">Multi-timeframe indicator dashboard ‚Äî ${symbols.length} symbols</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportCSVData('watchlist')" class="px-3 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600">üì• Export</button>
                        <button onclick="importCSVData('watchlist')" class="px-3 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600">üì§ Import</button>
                        <input id="wl-add-symbol" type="text" placeholder="Add symbol (e.g. RELIANCE)"
                            class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-sm w-48"
                            onkeydown="if(event.key==='Enter') addWatchlistSymbol()">
                        <button onclick="addWatchlistSymbol()" class="px-3 py-2 bg-blue-600 rounded-lg text-sm hover:bg-blue-700">+ Add</button>
                        <button onclick="refreshWatchlistData()" class="px-3 py-2 bg-purple-600/30 border border-purple-500 rounded-lg text-sm hover:bg-purple-600/50">üîÑ Refresh Data</button>
                    </div>
                </div>

                ${symbols.length === 0 ? `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-12 text-center">
                        <div class="text-4xl mb-4">üëÅÔ∏è</div>
                        <h3 class="text-lg font-semibold mb-2">No Symbols in Trading Watchlist</h3>
                        <p class="text-gray-500 mb-4">Add stocks you want to monitor for trading alerts.</p>
                        <p class="text-gray-600 text-sm">Type a symbol above and click Add, or use your Favorites to populate.</p>
                        <button onclick="populateFromFavorites()" class="mt-4 px-4 py-2 bg-yellow-600/30 border border-yellow-500 rounded-lg hover:bg-yellow-600/50 text-sm">
                            ‚≠ê Import from Favorites
                        </button>
                    </div>
                ` : `
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400">${symbols.length}</div>
                            <div class="text-xs text-gray-400">Symbols</div>
                        </div>
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-400">${rows.filter(r => r.day_impulse === 'green').length}</div>
                            <div class="text-xs text-gray-400">Daily Green</div>
                        </div>
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-red-400">${rows.filter(r => r.day_impulse === 'red').length}</div>
                            <div class="text-xs text-gray-400">Daily Red</div>
                        </div>
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-400">${rows.reduce((s, r) => s + (r.active_alerts || 0), 0)}</div>
                            <div class="text-xs text-gray-400">Active Alerts</div>
                        </div>
                    </div>

                    <!-- Multi-Timeframe Table -->
                    <div class="bg-gray-800/50 border border-gray-700 rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="px-3 py-2 text-left text-gray-400" rowspan="2">Symbol</th>
                                        <th class="px-3 py-2 text-right text-gray-400" rowspan="2">LTP</th>
                                        <th class="px-2 py-1 text-center text-blue-400 border-l border-gray-600" colspan="4">Daily</th>
                                        <th class="px-2 py-1 text-center text-purple-400 border-l border-gray-600" colspan="4">75 Min</th>
                                        <th class="px-2 py-1 text-center text-cyan-400 border-l border-gray-600" colspan="4">15 Min</th>
                                        <th class="px-2 py-1 text-center text-gray-400 border-l border-gray-600" rowspan="2">Alerts</th>
                                        <th class="px-2 py-1 text-center text-gray-400" rowspan="2">Actions</th>
                                    </tr>
                                    <tr class="border-b border-gray-600 text-xs">
                                        <th class="px-2 py-1 text-center text-blue-300 border-l border-gray-600">Impulse</th>
                                        <th class="px-2 py-1 text-center text-blue-300">RSI</th>
                                        <th class="px-2 py-1 text-center text-blue-300">ATR</th>
                                        <th class="px-2 py-1 text-center text-blue-300">KC Pos</th>
                                        <th class="px-2 py-1 text-center text-purple-300 border-l border-gray-600">Impulse</th>
                                        <th class="px-2 py-1 text-center text-purple-300">RSI</th>
                                        <th class="px-2 py-1 text-center text-purple-300">ATR</th>
                                        <th class="px-2 py-1 text-center text-purple-300">KC Pos</th>
                                        <th class="px-2 py-1 text-center text-cyan-300 border-l border-gray-600">Impulse</th>
                                        <th class="px-2 py-1 text-center text-cyan-300">RSI</th>
                                        <th class="px-2 py-1 text-center text-cyan-300">ATR</th>
                                        <th class="px-2 py-1 text-center text-cyan-300">KC Pos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows.map(r => {
                                        const sym = r.symbol.replace('NSE:', '');
                                        return `
                                        <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                                            <td class="px-3 py-2 font-mono font-semibold text-white">${sym}</td>
                                            <td class="px-3 py-2 text-right font-mono">${r.ltp ? r.ltp.toFixed(2) : '‚Äî'}</td>
                                            ${renderTfCells(r, 'day')}
                                            ${renderTfCells(r, '75min')}
                                            ${renderTfCells(r, '15min')}
                                            <td class="px-2 py-2 text-center border-l border-gray-600">
                                                ${r.active_alerts > 0 ? `<span class="text-yellow-400 font-semibold">${r.active_alerts}</span>` : '<span class="text-gray-600">0</span>'}
                                            </td>
                                            <td class="px-2 py-2 text-center">
                                                <div class="flex gap-1 justify-center">
                                                    <button onclick="openCreateAlert('${r.symbol}')" class="px-2 py-1 text-xs bg-yellow-600/30 rounded hover:bg-yellow-600/50" title="Create Alert">üîî</button>
                                                    <button onclick="openWatchlistDetail('${r.symbol}')" class="px-2 py-1 text-xs bg-blue-600/30 rounded hover:bg-blue-600/50" title="View Details">üìä</button>
                                                    <button onclick="removeWatchlistSymbol('${r.symbol}')" class="px-2 py-1 text-xs bg-red-600/30 rounded hover:bg-red-600/50" title="Remove">‚úï</button>
                                                </div>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `}
            </div>`;
        } catch (e) {
            html = `<div class="text-red-400">Error loading watchlist: ${e.message}</div>`;
        }
        return html;
    }

    function renderTfCells(r, tf) {
        const impulse = r[tf + '_impulse'];
        const rsi = r[tf + '_rsi'];
        const atr = r[tf + '_atr'];
        const kcUpper = r[tf + '_kc_upper'];
        const kcLower = r[tf + '_kc_lower'];
        const ltp = r.ltp;

        // Impulse color badge
        const impColor = impulse === 'green' ? 'bg-green-500' : impulse === 'red' ? 'bg-red-500' : 'bg-blue-500';
        const impLabel = impulse ? impulse.charAt(0).toUpperCase() + impulse.slice(1) : '‚Äî';

        // RSI color
        const rsiColor = rsi > 70 ? 'text-red-400' : rsi < 30 ? 'text-green-400' : 'text-gray-300';

        // KC position: where is LTP relative to KC bands
        let kcPos = '‚Äî';
        if (ltp && kcUpper && kcLower) {
            const kcMid = (kcUpper + kcLower) / 2;
            if (ltp >= kcUpper) kcPos = 'Above';
            else if (ltp <= kcLower) kcPos = 'Below';
            else if (ltp >= kcMid) kcPos = 'Mid-Up';
            else kcPos = 'Mid-Lo';
        }
        const kcColor = kcPos === 'Below' ? 'text-green-400' : kcPos === 'Above' ? 'text-red-400' : 'text-gray-400';

        const borderClass = tf === 'day' || tf === '75min' || tf === '15min' ? 'border-l border-gray-600' : '';

        return `
            <td class="px-2 py-2 text-center ${borderClass}">
                <span class="inline-block w-2 h-2 rounded-full ${impColor}" title="${impLabel}"></span>
                <span class="text-xs ml-1">${impLabel}</span>
            </td>
            <td class="px-2 py-2 text-center ${rsiColor} font-mono text-xs">${rsi ? rsi.toFixed(0) : '‚Äî'}</td>
            <td class="px-2 py-2 text-center text-gray-400 font-mono text-xs">${atr ? atr.toFixed(1) : '‚Äî'}</td>
            <td class="px-2 py-2 text-center ${kcColor} text-xs">${kcPos}</td>
        `;
    }

    async function addWatchlistSymbol() {
        const input = document.getElementById('wl-add-symbol');
        const symbol = input.value.trim().toUpperCase();
        if (!symbol) return;

        try {
            const resp = await fetch('/api/v2/trading-watchlist/add-symbol', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol})
            });
            const data = await resp.json();
            if (data.success) {
                input.value = '';
                toast(`${symbol} added to watchlist`, 'success');
                render();
            } else {
                toast(data.error || 'Failed to add symbol', 'error');
            }
        } catch (e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function removeWatchlistSymbol(symbol) {
        if (!confirm(`Remove ${symbol} from trading watchlist?`)) return;
        try {
            const resp = await fetch(`/api/v2/trading-watchlist/remove-symbol/${encodeURIComponent(symbol)}`, {method: 'DELETE'});
            const data = await resp.json();
            if (data.success) {
                toast(`${symbol} removed`, 'success');
                render();
            } else {
                toast(data.error || 'Failed to remove', 'error');
            }
        } catch (e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function populateFromFavorites() {
        try {
            const resp = await fetch('/api/v2/favorites');
            const data = await resp.json();
            const favs = data.favorites || [];
            if (favs.length === 0) {
                toast('No favorites found. Add favorites first.', 'error');
                return;
            }
            const symbols = favs.map(f => f.symbol.replace('NSE:', '').trim().toUpperCase());
            const saveResp = await fetch('/api/v2/trading-watchlist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbols, name: 'Trading Watchlist'})
            });
            const saveData = await saveResp.json();
            if (saveData.success) {
                toast(`Imported ${symbols.length} favorites to watchlist`, 'success');
                render();
            }
        } catch (e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function refreshWatchlistData() {
        toast('Refreshing multi-timeframe data for all watchlist symbols (this may take a minute)...', 'info');
        try {
            const resp = await fetch('/api/v2/timeframe/refresh', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({}),
                signal: AbortSignal.timeout(300000) // 5 min timeout for large watchlists
            });
            const data = await resp.json();
            if (data.success) {
                const r = data.result || {};
                toast(`Data refreshed: ${r.success||0}/${r.total||0} symbols in ${r.elapsed_seconds||0}s`, 'success');
                render();
            } else {
                toast(data.error || 'Failed to refresh data', 'error');
            }
        } catch (e) {
            toast('Failed to refresh data: ' + e.message, 'error');
        }
    }

    function openCreateAlert(symbol) {
        // Switch to alert manager and pre-fill symbol
        window._prefillAlertSymbol = symbol;
        switchTab('alert-manager');
    }

    function openWatchlistDetail(symbol) {
        // Show detail modal with multi-TF chart data
        toast(`Detail view for ${symbol} ‚Äî coming in Phase 2`, 'info');
    }

    // ========== ALERT MANAGER ==========
    let alertEditId = null;

    async function alertManagerView() {
        const prefill = window._prefillAlertSymbol || '';
        window._prefillAlertSymbol = null;

        let alertsHtml = '';
        try {
            const resp = await fetch('/api/v2/alerts');
            const data = await resp.json();
            const alerts = data.alerts || [];

            const active = alerts.filter(a => a.status === 'active');
            const paused = alerts.filter(a => a.status === 'paused');
            const triggered = alerts.filter(a => a.status === 'triggered');

            alertsHtml = `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold">Alert Manager</h2>
                        <p class="text-gray-500 text-sm">${active.length} active, ${paused.length} paused, ${triggered.length} triggered</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportCSVData('alerts')" class="px-3 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600">üì• Export</button>
                        <button onclick="importCSVData('alerts')" class="px-3 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600">üì§ Import</button>
                        <button onclick="showCreateAlertForm('${prefill}')" class="px-4 py-2 bg-yellow-600 rounded-lg text-sm font-medium hover:bg-yellow-700">+ New Alert</button>
                        <button onclick="viewAlertHistory()" class="px-3 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600">üìú History</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-400">${active.length}</div>
                        <div class="text-xs text-gray-400">Active</div>
                    </div>
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-400">${paused.length}</div>
                        <div class="text-xs text-gray-400">Paused</div>
                    </div>
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-blue-400">${triggered.length}</div>
                        <div class="text-xs text-gray-400">Triggered</div>
                    </div>
                </div>

                <!-- Create Alert Form (hidden by default) -->
                <div id="alert-form-container" class="hidden"></div>

                <!-- Alerts Table -->
                ${alerts.length === 0 ? `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-12 text-center">
                        <div class="text-4xl mb-4">üîî</div>
                        <h3 class="text-lg font-semibold mb-2">No Alerts Yet</h3>
                        <p class="text-gray-500 mb-4">Create alerts to get notified when stocks hit your target prices.</p>
                        <button onclick="showCreateAlertForm('')" class="px-4 py-2 bg-yellow-600 rounded-lg hover:bg-yellow-700">+ Create First Alert</button>
                    </div>
                ` : `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-xl overflow-hidden">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="px-3 py-2 text-left text-gray-400">Symbol</th>
                                    <th class="px-3 py-2 text-left text-gray-400">Alert Name</th>
                                    <th class="px-3 py-2 text-left text-gray-400">Dir</th>
                                    <th class="px-3 py-2 text-left text-gray-400">Condition</th>
                                    <th class="px-3 py-2 text-center text-gray-400">Candle</th>
                                    <th class="px-3 py-2 text-center text-gray-400">Auto</th>
                                    <th class="px-3 py-2 text-center text-gray-400">SL / Target</th>
                                    <th class="px-3 py-2 text-center text-gray-400">Qty</th>
                                    <th class="px-3 py-2 text-center text-gray-400">Status</th>
                                    <th class="px-3 py-2 text-center text-gray-400">Triggers</th>
                                    <th class="px-3 py-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${alerts.map(a => {
                                    const sym = a.symbol.replace('NSE:','');
                                    const statusColor = a.status === 'active' ? 'text-green-400' : a.status === 'paused' ? 'text-yellow-400' : 'text-blue-400';
                                    return `
                                    <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                                        <td class="px-3 py-2 font-mono font-semibold">${sym}</td>
                                        <td class="px-3 py-2 text-gray-300">${a.alert_name || '‚Äî'}</td>
                                        <td class="px-3 py-2"><span class="${a.direction==='LONG'?'text-green-400':'text-red-400'}">${a.direction}</span></td>
                                        <td class="px-3 py-2 font-mono text-xs">${a.condition_operator || '<='} ${a.condition_value || '‚Äî'}</td>
                                        <td class="px-3 py-2 text-center">${a.candle_confirm ? '‚úÖ' : '‚Äî'}</td>
                                        <td class="px-3 py-2 text-center">${a.auto_trade ? '‚ö°' : '‚Äî'}</td>
                                        <td class="px-3 py-2 text-center font-mono text-xs">${a.stop_loss || '‚Äî'} / ${a.target_price || '‚Äî'}</td>
                                        <td class="px-3 py-2 text-center font-mono">${a.quantity || '‚Äî'}</td>
                                        <td class="px-3 py-2 text-center ${statusColor} font-semibold text-xs uppercase">${a.status}</td>
                                        <td class="px-3 py-2 text-center font-mono">${a.trigger_count || 0}</td>
                                        <td class="px-3 py-2 text-center">
                                            <div class="flex gap-1 justify-center">
                                                <button onclick="toggleAlert(${a.id})" class="px-2 py-1 text-xs ${a.status==='active'?'bg-yellow-600/30':'bg-green-600/30'} rounded hover:opacity-80" title="${a.status==='active'?'Pause':'Activate'}">${a.status==='active'?'‚è∏':'‚ñ∂'}</button>
                                                <button onclick="editAlert(${a.id})" class="px-2 py-1 text-xs bg-blue-600/30 rounded hover:bg-blue-600/50" title="Edit">‚úèÔ∏è</button>
                                                <button onclick="deleteAlert(${a.id})" class="px-2 py-1 text-xs bg-red-600/30 rounded hover:bg-red-600/50" title="Delete">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>`;

        } catch (e) {
            alertsHtml = `<div class="text-red-400">Error loading alerts: ${e.message}</div>`;
        }

        // Auto-show create form if prefill symbol given
        if (prefill) {
            setTimeout(() => showCreateAlertForm(prefill), 100);
        }

        return alertsHtml;
    }

    function showCreateAlertForm(symbol) {
        alertEditId = null;
        const container = document.getElementById('alert-form-container');
        if (!container) return;
        container.classList.remove('hidden');
        container.innerHTML = renderAlertForm({symbol: symbol || '', direction: 'LONG', condition_operator: '<=', cooldown_minutes: 60, timeframe: '15min'});
    }

    async function editAlert(id) {
        try {
            const resp = await fetch(`/api/v2/alerts/${id}`);
            const data = await resp.json();
            if (!data.success) { toast('Alert not found', 'error'); return; }
            alertEditId = id;
            const container = document.getElementById('alert-form-container');
            if (!container) return;
            container.classList.remove('hidden');
            container.innerHTML = renderAlertForm(data.alert);
            container.scrollIntoView({behavior: 'smooth'});
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    function renderAlertForm(a) {
        const isEdit = !!alertEditId;
        return `
        <div class="bg-gray-800/50 border border-yellow-500/50 rounded-xl p-4">
            <h3 class="text-lg font-semibold mb-3">${isEdit ? 'Edit Alert' : 'Create Alert'}</h3>
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Symbol</label>
                    <input id="af-symbol" value="${(a.symbol||'').replace('NSE:','')}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="RELIANCE">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Alert Name</label>
                    <input id="af-name" value="${a.alert_name||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="Buy at support">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Direction</label>
                    <select id="af-direction" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm">
                        <option value="LONG" ${a.direction==='LONG'?'selected':''}>LONG</option>
                        <option value="SHORT" ${a.direction==='SHORT'?'selected':''}>SHORT</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Timeframe</label>
                    <select id="af-timeframe" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm">
                        <option value="15min" ${a.timeframe==='15min'?'selected':''}>15 Min</option>
                        <option value="75min" ${a.timeframe==='75min'?'selected':''}>75 Min</option>
                        <option value="day" ${a.timeframe==='day'?'selected':''}>Daily</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-3 mt-3">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Operator</label>
                    <select id="af-operator" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm">
                        <option value="<=" ${a.condition_operator==='<='?'selected':''}>Price &lt;= (at or below)</option>
                        <option value=">=" ${a.condition_operator==='>='?'selected':''}>Price &gt;= (at or above)</option>
                        <option value="<" ${a.condition_operator==='<'?'selected':''}>Price &lt; (below)</option>
                        <option value=">" ${a.condition_operator==='>'?'selected':''}>Price &gt; (above)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Target Price</label>
                    <input id="af-value" type="number" step="0.05" value="${a.condition_value||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="2500.00">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Stop Loss</label>
                    <input id="af-sl" type="number" step="0.05" value="${a.stop_loss||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="SL price">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Take Profit</label>
                    <input id="af-tp" type="number" step="0.05" value="${a.target_price||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="Target price">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-3 mt-3">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Quantity</label>
                    <input id="af-qty" type="number" value="${a.quantity||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="Shares">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Cooldown (min)</label>
                    <input id="af-cooldown" type="number" value="${a.cooldown_minutes||60}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm">
                </div>
                <div class="flex items-end gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="af-candle" type="checkbox" ${a.candle_confirm?'checked':''} class="w-4 h-4">
                        <span class="text-sm">Candle Confirm</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="af-auto" type="checkbox" ${a.auto_trade?'checked':''} class="w-4 h-4">
                        <span class="text-sm">Auto Trade</span>
                    </label>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Candle Pattern</label>
                    <input id="af-pattern" value="${a.candle_pattern||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="e.g. hammer, engulfing">
                </div>
            </div>
            <div class="mt-3">
                <label class="block text-xs text-gray-400 mb-1">Notes</label>
                <input id="af-notes" value="${a.notes||''}" class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm" placeholder="Notes about this alert">
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveAlert()" class="px-4 py-2 bg-yellow-600 rounded-lg text-sm font-medium hover:bg-yellow-700">${isEdit ? 'Update Alert' : 'Create Alert'}</button>
                <button onclick="document.getElementById('alert-form-container').classList.add('hidden')" class="px-4 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600">Cancel</button>
            </div>
        </div>`;
    }

    async function saveAlert() {
        const payload = {
            symbol: document.getElementById('af-symbol').value.trim(),
            alert_name: document.getElementById('af-name').value.trim(),
            direction: document.getElementById('af-direction').value,
            timeframe: document.getElementById('af-timeframe').value,
            condition_operator: document.getElementById('af-operator').value,
            condition_value: parseFloat(document.getElementById('af-value').value) || null,
            condition_type: 'price_level',
            stop_loss: parseFloat(document.getElementById('af-sl').value) || null,
            target_price: parseFloat(document.getElementById('af-tp').value) || null,
            quantity: parseInt(document.getElementById('af-qty').value) || null,
            cooldown_minutes: parseInt(document.getElementById('af-cooldown').value) || 60,
            candle_confirm: document.getElementById('af-candle').checked,
            auto_trade: document.getElementById('af-auto').checked,
            candle_pattern: document.getElementById('af-pattern').value.trim(),
            notes: document.getElementById('af-notes').value.trim(),
            status: 'active'
        };

        if (!payload.symbol) { toast('Symbol is required', 'error'); return; }
        if (!payload.condition_value) { toast('Target price is required', 'error'); return; }

        try {
            const url = alertEditId ? `/api/v2/alerts/${alertEditId}` : '/api/v2/alerts';
            const method = alertEditId ? 'PUT' : 'POST';
            const resp = await fetch(url, {method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
            const data = await resp.json();
            if (data.success) {
                toast(alertEditId ? 'Alert updated' : 'Alert created', 'success');
                alertEditId = null;
                render();
            } else {
                toast(data.error || 'Failed', 'error');
            }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    async function toggleAlert(id) {
        try {
            const resp = await fetch(`/api/v2/alerts/${id}/toggle`, {method: 'POST'});
            const data = await resp.json();
            if (data.success) { toast(`Alert ${data.status}`, 'success'); render(); }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    async function deleteAlert(id) {
        if (!confirm('Delete this alert?')) return;
        try {
            const resp = await fetch(`/api/v2/alerts/${id}`, {method: 'DELETE'});
            const data = await resp.json();
            if (data.success) { toast('Alert deleted', 'success'); render(); }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    async function viewAlertHistory() {
        try {
            const resp = await fetch('/api/v2/alerts/history');
            const data = await resp.json();
            const history = data.history || [];
            document.getElementById('modal-body').innerHTML = `
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-4">Alert Trigger History</h3>
                    ${history.length === 0 ? '<p class="text-gray-500">No triggers recorded yet.</p>' : `
                        <table class="w-full text-sm">
                            <thead><tr class="border-b border-gray-700">
                                <th class="px-3 py-2 text-left">Time</th>
                                <th class="px-3 py-2 text-left">Symbol</th>
                                <th class="px-3 py-2 text-left">Alert</th>
                                <th class="px-3 py-2 text-right">Price</th>
                                <th class="px-3 py-2 text-left">Action</th>
                            </tr></thead>
                            <tbody>
                                ${history.map(h => `
                                    <tr class="border-b border-gray-700/50">
                                        <td class="px-3 py-2 text-xs text-gray-400">${h.trigger_time || '‚Äî'}</td>
                                        <td class="px-3 py-2 font-mono">${(h.symbol||'').replace('NSE:','')}</td>
                                        <td class="px-3 py-2">${h.alert_name || '‚Äî'}</td>
                                        <td class="px-3 py-2 text-right font-mono">${h.trigger_price ? h.trigger_price.toFixed(2) : '‚Äî'}</td>
                                        <td class="px-3 py-2 text-xs">${h.action_taken || '‚Äî'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                    <button onclick="document.getElementById('modal').classList.add('hidden')" class="mt-4 px-4 py-2 bg-gray-700 rounded-lg text-sm">Close</button>
                </div>`;
            document.getElementById('modal').classList.remove('hidden');
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    // ========== MARKET ENGINE ==========
    let _notificationPollTimer = null;

    async function marketEngineView() {
        let html = '';
        try {
            const resp = await fetch('/api/v2/engine/status');
            const s = await resp.json();

            const statusColor = s.status === 'running' ? 'text-green-400' : s.status === 'waiting' ? 'text-yellow-400' : 'text-gray-400';
            const statusIcon = s.running ? 'üü¢' : 'üî¥';

            html = `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold">Market Engine</h2>
                        <p class="text-gray-500 text-sm">Background daemon ‚Äî 5-minute refresh cycle</p>
                    </div>
                    <div class="flex gap-2">
                        ${s.running ? `
                            <button onclick="engineRefresh()" class="px-3 py-2 bg-blue-600/30 border border-blue-500 rounded-lg text-sm hover:bg-blue-600/50">üîÑ Refresh Now</button>
                            <button onclick="engineStop()" class="px-4 py-2 bg-red-600 rounded-lg text-sm font-medium hover:bg-red-700">‚èπ Stop Engine</button>
                        ` : `
                            <button onclick="engineStart()" class="px-4 py-2 bg-green-600 rounded-lg text-sm font-medium hover:bg-green-700">‚ñ∂ Start Engine</button>
                        `}
                    </div>
                </div>

                <!-- Status Dashboard -->
                <div class="grid grid-cols-6 gap-3">
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl">${statusIcon}</div>
                        <div class="text-xs text-gray-400 mt-1">Status</div>
                        <div class="text-sm font-semibold ${statusColor} uppercase">${s.status || 'stopped'}</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-blue-400">${s.cycles_completed || 0}</div>
                        <div class="text-xs text-gray-400">Cycles</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-purple-400">${s.symbols_count || 0}</div>
                        <div class="text-xs text-gray-400">Symbols</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-400">${s.alerts_triggered || 0}</div>
                        <div class="text-xs text-gray-400">Triggers</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                        <div class="text-sm font-mono text-gray-300">${s.last_cycle_duration ? s.last_cycle_duration + 's' : '‚Äî'}</div>
                        <div class="text-xs text-gray-400">Last Cycle</div>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-cyan-400">${s.pending_notifications || 0}</div>
                        <div class="text-xs text-gray-400">Notifications</div>
                    </div>
                </div>

                <!-- Timing Info -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Engine Details</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Started:</span>
                            <span class="text-gray-300 ml-2">${s.started_at ? new Date(s.started_at).toLocaleString() : '‚Äî'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Last Cycle:</span>
                            <span class="text-gray-300 ml-2">${s.last_cycle ? new Date(s.last_cycle).toLocaleString() : '‚Äî'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Thread Alive:</span>
                            <span class="${s.thread_alive ? 'text-green-400' : 'text-red-400'} ml-2">${s.thread_alive ? 'Yes' : 'No'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Alerts Evaluated:</span>
                            <span class="text-gray-300 ml-2">${s.alerts_evaluated || 0} cycles</span>
                        </div>
                    </div>
                </div>

                <!-- Pending Notifications -->
                <div id="engine-notifications-container"></div>

                <!-- Recent Errors -->
                ${s.errors_recent && s.errors_recent.length > 0 ? `
                    <div class="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-red-400 mb-2">Recent Errors</h3>
                        ${s.errors_recent.map(e => `
                            <div class="text-xs text-gray-400 mb-1">
                                <span class="text-red-400">${e.time}</span> ‚Äî ${e.error}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>`;

            // Load notifications after render
            setTimeout(loadEngineNotifications, 100);

        } catch (e) {
            html = `<div class="text-red-400">Error loading engine status: ${e.message}</div>`;
        }
        return html;
    }

    async function engineStart() {
        try {
            const resp = await fetch('/api/v2/engine/start', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({cycle_seconds: 300})});
            const data = await resp.json();
            toast(data.message, data.success ? 'success' : 'error');
            if (data.success) { startNotificationPolling(); render(); }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    async function engineStop() {
        try {
            const resp = await fetch('/api/v2/engine/stop', {method: 'POST'});
            const data = await resp.json();
            toast(data.message, data.success ? 'success' : 'error');
            stopNotificationPolling();
            render();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    async function engineRefresh() {
        try {
            const resp = await fetch('/api/v2/engine/refresh', {method: 'POST'});
            const data = await resp.json();
            toast(data.message, data.success ? 'success' : 'info');
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }

    async function loadEngineNotifications() {
        try {
            const resp = await fetch('/api/v2/engine/notifications');
            const data = await resp.json();
            const notifs = data.notifications || [];
            const container = document.getElementById('engine-notifications-container');
            if (!container) return;

            if (notifs.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="bg-gray-800/50 border border-yellow-500/30 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-yellow-400">Notifications (${notifs.length})</h3>
                        <button onclick="acknowledgeAllNotifications()" class="text-xs text-gray-500 hover:text-gray-300">Dismiss All</button>
                    </div>
                    ${notifs.map(n => {
                        const typeColor = n.type === 'alert_triggered' ? 'border-yellow-500' :
                                          n.type === 'trade_created' ? 'border-green-500' :
                                          n.type === 'error' ? 'border-red-500' : 'border-blue-500';
                        const typeIcon = n.type === 'alert_triggered' ? 'üîî' :
                                         n.type === 'trade_created' ? 'üìà' :
                                         n.type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                        return `
                        <div class="border-l-2 ${typeColor} pl-3 py-2 mb-2">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm font-semibold">${typeIcon} ${n.title}</span>
                                    <span class="text-xs text-gray-500 ml-2">${new Date(n.timestamp).toLocaleTimeString()}</span>
                                </div>
                                <button onclick="acknowledgeNotification(${n.id})" class="text-xs text-gray-500 hover:text-gray-300">‚úï</button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${n.message}</p>
                        </div>`;
                    }).join('')}
                </div>`;
        } catch (e) {
            // Silently fail ‚Äî polling will retry
        }
    }

    async function acknowledgeNotification(id) {
        try {
            await fetch('/api/v2/engine/notifications/acknowledge', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            });
            loadEngineNotifications();
            updateNotificationBadge();
        } catch (e) {}
    }

    async function acknowledgeAllNotifications() {
        try {
            await fetch('/api/v2/engine/notifications/acknowledge', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
            loadEngineNotifications();
            updateNotificationBadge();
        } catch (e) {}
    }

    // Notification polling (10-second interval)
    const _toastedNotifIds = new Set();  // Track which notifications we've already toasted

    function startNotificationPolling() {
        stopNotificationPolling();
        _notificationPollTimer = setInterval(async () => {
            try {
                const resp = await fetch('/api/v2/engine/notifications');
                const data = await resp.json();
                const notifs = data.notifications || [];
                if (notifs.length > 0) {
                    updateNotificationBadge(notifs.length);
                    // Toast only truly new notifications (not 'info' type like "Engine Started")
                    for (const n of notifs) {
                        if (!_toastedNotifIds.has(n.id) && n.type !== 'info') {
                            const toastType = n.type === 'error' ? 'error' :
                                              n.type === 'trade_created' ? 'success' :
                                              n.type === 'alert_triggered' ? 'alert' : 'info';
                            toast(n.title + ': ' + n.message, toastType);
                            _toastedNotifIds.add(n.id);
                        }
                    }
                } else {
                    updateNotificationBadge(0);
                }
            } catch (e) {}
        }, 10000);
    }

    function stopNotificationPolling() {
        if (_notificationPollTimer) {
            clearInterval(_notificationPollTimer);
            _notificationPollTimer = null;
        }
    }

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notification-badge');
        if (badge) {
            badge.textContent = count || '';
            badge.classList.toggle('hidden', !count);
        }
    }

    // Auto-start polling on page load ONLY if engine is actually running
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const resp = await fetch('/api/v2/engine/status');
            const s = await resp.json();
            if (s.running && s.status === 'running') startNotificationPolling();
        } catch (e) {}
    });

    // ========== SCREENER ==========
    let indicatorFilters = null; // Will hold user's indicator config
    
    function screenView() {
        const results = weeklyData?.all_results || [];
        const sum = weeklyData?.summary || {};
        
        return `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div><h2 class="text-xl font-bold">Triple Screen Scanner</h2><p class="text-gray-500 text-sm">Weekly trend + Daily entry timing</p></div>
                    <div class="flex gap-2">
                        <button onclick="showIndicatorFilterModal()" class="px-3 py-2 bg-purple-600/30 border border-purple-500 rounded-lg hover:bg-purple-600/50" title="Configure Indicators" ${isLoading ? 'disabled' : ''}>‚öôÔ∏è Filters</button>
                        <button id="run-scan-btn" onclick="runWeekly()" class="px-4 py-2 bg-blue-600 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" ${isLoading ? 'disabled' : ''}>üîç Run Weekly Scan</button>
                        <button onclick="showCriteriaModal()" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600" title="How grading works" ${isLoading ? 'disabled' : ''}>‚ùì</button>
                    </div>
                </div>

                ${weeklyData ? `
                    <div class="grid grid-cols-5 gap-3">
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-400">‚≠ê${sum.a_trades||0}</div>
                            <div class="text-xs text-gray-400">A-Trades</div>
                        </div>
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400">${sum.b_trades||0}</div>
                            <div class="text-xs text-gray-400">B-Trades</div>
                        </div>
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-400">${sum.watch_list||0}</div>
                            <div class="text-xs text-gray-400">Watch</div>
                        </div>
                        <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-red-400">${sum.avoid||0}</div>
                            <div class="text-xs text-gray-400">Avoid</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold">${results.length}</div>
                            <div class="text-xs text-gray-400">Total</div>
                        </div>
                    </div>

                    <div class="bg-[#111827] rounded-xl overflow-hidden border border-gray-700">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-[#1f2937]">
                                    <tr>
                                        <th class="text-left p-3 font-medium text-gray-400">Symbol</th>
                                        <th class="text-left p-3 font-medium text-gray-400">Price</th>
                                        <th class="text-left p-3 font-medium text-gray-400">Change</th>
                                        <th class="text-center p-3 font-medium text-gray-400">Grade</th>
                                        <th class="text-center p-3 font-medium text-gray-400">Score</th>
                                        <th class="text-left p-3 font-medium text-gray-400">Weekly</th>
                                        <th class="text-left p-3 font-medium text-gray-400">Impulse</th>
                                        <th class="text-right p-3 font-medium text-gray-400">Force Idx</th>
                                        <th class="text-right p-3 font-medium text-gray-400">Stoch</th>
                                        <th class="text-right p-3 font-medium text-gray-400">RSI</th>
                                        <th class="text-right p-3 font-medium text-gray-400">vs EMA</th>
                                        <th class="text-center p-3 font-medium text-gray-400">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(r => `
                                        <tr class="border-t border-gray-700/50 hover:bg-[#1f2937]/50">
                                            <td class="p-3">
                                                <div class="font-mono font-bold">${r.symbol}</div>
                                                <div class="text-xs text-gray-500 truncate max-w-[100px]">${r.name||''}</div>
                                            </td>
                                            <td class="p-3 font-mono">‚Çπ${r.price?.toFixed(2)}</td>
                                            <td class="p-3 font-mono ${r.change>=0?'text-green-400':'text-red-400'}">${r.change>=0?'+':''}${r.change?.toFixed(2)}</td>
                                            <td class="p-3 text-center">
                                                <span class="px-2 py-1 rounded text-xs font-bold ${
                                                    r.grade==='A'?'bg-green-500/20 text-green-400':
                                                    r.grade==='B'?'bg-blue-500/20 text-blue-400':
                                                    r.grade==='C'?'bg-yellow-500/20 text-yellow-400':
                                                    'bg-red-500/20 text-red-400'
                                                }">${r.is_a_trade?'‚≠ê':''} ${r.grade}</span>
                                            </td>
                                            <td class="p-3 text-center">
                                                <div class="flex items-center justify-center gap-1">
                                                    <div class="w-12 h-1.5 bg-gray-700 rounded overflow-hidden">
                                                        <div class="h-full ${r.signal_strength>=5?'bg-green-500':r.signal_strength>=3?'bg-yellow-500':'bg-red-500'}" style="width:${r.signal_strength*10}%"></div>
                                                    </div>
                                                    <span class="font-mono text-xs">${r.signal_strength}/10</span>
                                                </div>
                                            </td>
                                            <td class="p-3">
                                                <span class="${r.weekly_bullish?'text-green-400':'text-red-400'}" title="${r.ema_status||'No data'}">${r.screen1_score||0}/6</span>
                                                ${r.macd_h_rising?'<span class="text-green-400 ml-1">‚Üë</span>':'<span class="text-red-400 ml-1">‚Üì</span>'}
                                            </td>
                                            <td class="p-3">
                                                <span class="px-2 py-0.5 rounded text-xs font-bold ${
                                                    r.impulse_color==='GREEN'?'bg-green-500/20 text-green-400':
                                                    r.impulse_color==='RED'?'bg-red-500/20 text-red-400':
                                                    'bg-blue-500/20 text-blue-400'
                                                }">${r.impulse_color}</span>
                                            </td>
                                            <td class="p-3 text-right font-mono ${r.force_index<0?'text-green-400':'text-red-400'}">${(r.force_index/1e6)?.toFixed(1)}M</td>
                                            <td class="p-3 text-right font-mono ${r.stochastic<30?'text-green-400':r.stochastic>70?'text-red-400':'text-gray-300'}">${r.stochastic?.toFixed(0)}</td>
                                            <td class="p-3 text-right font-mono ${r.rsi<30?'text-green-400':r.rsi>70?'text-red-400':'text-gray-300'}">${r.rsi?.toFixed(0)}</td>
                                            <td class="p-3 text-right font-mono ${r.price_vs_ema<=0?'text-green-400':r.price_vs_ema>3?'text-red-400':'text-yellow-400'}">${r.price_vs_ema>=0?'+':''}${r.price_vs_ema?.toFixed(1)}%</td>
                                            <td class="p-3 text-center">
                                                <div class="flex gap-1 justify-center">
                                                    <button onclick="toggleFavorite('${r.symbol}')" class="px-2 py-1 text-xs rounded hover:bg-yellow-600/40" title="Add to favorites">‚≠ê</button>
                                                    <button onclick="showDetail(this.dataset.stock)" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-blue-600" data-stock='${JSON.stringify(r).replace(/'/g, "&apos;")}'>Details</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Indicator Configuration Info -->
                    <div class="bg-[#111827] rounded-xl p-4 border border-gray-700 mt-4">
                        <h3 class="font-bold mb-2">üìä Current Indicator Configuration</h3>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Screen 1 (Weekly)</p>
                                <p>Trend: <span class="text-blue-400">EMA 22</span></p>
                                <p>Momentum: <span class="text-blue-400">MACD Histogram</span></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Screen 2 (Daily)</p>
                                <p>Oscillator 1: <span class="text-green-400">Force Index</span></p>
                                <p>Oscillator 2: <span class="text-green-400">Stochastic</span></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Screen 3 (Entry)</p>
                                <p>Volatility: <span class="text-yellow-400">ATR</span></p>
                                <p>Impulse: <span class="text-yellow-400">Elder Impulse</span></p>
                            </div>
                        </div>
                        <button onclick="showIndicatorConfig()" class="mt-3 text-xs text-blue-400 hover:underline">View all available indicators ‚Üí</button>
                    </div>
                ` : `
                    <div class="text-center py-20 text-gray-500">
                        <div class="text-6xl mb-4">üîç</div>
                        <h3 class="text-xl font-semibold">Run the scanner to see results</h3>
                        <p class="mt-2">All stocks will be displayed with their indicator values and grades</p>
                    </div>
                `}
            </div>
        `;
    }

    async function runWeekly() {
        if(isLoading) return;  // Prevent multiple clicks
        
        isLoading = true;
        const btn = document.getElementById('run-scan-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="inline-block animate-spin">‚è≥</span> Scanning...';
        btn.disabled = true;
        
        // Show loading modal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'loading-modal';
        loadingModal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center';
        loadingModal.innerHTML = `
            <div class="text-center">
                <div class="inline-block animate-spin text-6xl mb-4">‚è≥</div>
                <h3 class="text-xl font-bold text-white mb-2">Scanning 100 stocks...</h3>
                <p class="text-gray-400">This may take 2-3 minutes</p>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        const market = document.getElementById('market').value;
        try {
            weeklyData = await api('POST', '/screener/weekly', {market});
            toast(`Found ${weeklyData.summary?.a_trades||0} A-Trades!`, 'success');
            await render();
        } catch(e) {
            toast('Scan failed: '+e.message, 'error');
        } finally {
            isLoading = false;
            btn.innerHTML = originalText;
            btn.disabled = false;
            const modal = document.getElementById('loading-modal');
            if(modal) modal.remove();
            await render();  // Re-render to update button state
        }
    }

    function showDetail(stockData) {
        // Parse JSON if it's a string (from data attribute)
        let stock = typeof stockData === 'string' ? JSON.parse(stockData) : stockData;
        selectedStock = stock;  // Store for trade bill creation
        document.getElementById('modal').classList.remove('hidden');
        const patterns = stock.pattern_names || [];
        const bullishPatterns = stock.bullish_pattern_names || [];
        
        document.getElementById('modal-body').innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">${stock.symbol}</h2>
                        <p class="text-gray-500">${stock.name}</p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-lg mb-3 text-blue-400">üìä Indicator Values</h3>
                        <div class="space-y-2 bg-[#1f2937] rounded-lg p-4">
                            <div class="flex justify-between"><span class="text-gray-400">Price</span><span class="font-mono">‚Çπ${stock.price?.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">EMA 22</span><span class="font-mono">‚Çπ${stock.ema_22?.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Price vs EMA</span><span class="font-mono ${stock.price_vs_ema<=0?'text-green-400':'text-red-400'}">${stock.price_vs_ema?.toFixed(1)}%</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">MACD Histogram</span><span class="font-mono">${stock.macd_histogram?.toFixed(4)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Force Index</span><span class="font-mono ${stock.force_index<0?'text-green-400':'text-red-400'}">${stock.force_index?.toFixed(0)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Stochastic</span><span class="font-mono">${stock.stochastic?.toFixed(1)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">RSI</span><span class="font-mono">${stock.rsi?.toFixed(1)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">ATR</span><span class="font-mono">‚Çπ${stock.atr?.toFixed(2)}</span></div>
                        </div>

                        <h3 class="font-bold text-lg mb-3 mt-6 text-purple-400">üïØÔ∏è Candlestick Patterns</h3>
                        <div class="bg-[#1f2937] rounded-lg p-4">
                            ${patterns.length > 0 ? `
                                <div class="space-y-2">
                                    ${patterns.map(p => `
                                        <div class="flex items-center gap-2">
                                            <span class="${bullishPatterns.includes(p) ? 'text-green-400' : 'text-red-400'}">
                                                ${bullishPatterns.includes(p) ? 'üü¢' : 'üî¥'}
                                            </span>
                                            <span>${p}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <p class="text-gray-500">No significant patterns detected</p>
                            `}
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-3 text-green-400">üìà Score Breakdown</h3>
                        <div class="space-y-2 bg-[#1f2937] rounded-lg p-4">
                            ${(stock.score_breakdown||[]).map(s => `
                                <div class="text-sm ${s.startsWith('+')?'text-green-400':s.startsWith('-')?'text-red-400':'text-gray-400'}">${s}</div>
                            `).join('')}
                            <div class="border-t border-gray-600 pt-2 mt-2">
                                <div class="flex justify-between font-bold">
                                    <span>Total Score</span>
                                    <span class="${stock.signal_strength>=5?'text-green-400':'text-yellow-400'}">${stock.signal_strength}/10</span>
                                </div>
                            </div>
                        </div>

                        <h3 class="font-bold text-lg mb-3 mt-6 text-yellow-400">üéØ Trade Levels</h3>
                        <div class="space-y-2 bg-[#1f2937] rounded-lg p-4">
                            <div class="flex justify-between"><span class="text-gray-400">Entry</span><span class="font-mono text-blue-400">‚Çπ${stock.entry?.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Stop Loss</span><span class="font-mono text-red-400">‚Çπ${stock.stop_loss?.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Target 1</span><span class="font-mono text-green-400">‚Çπ${stock.target_b?.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Target 2</span><span class="font-mono text-green-400">‚Çπ${stock.target_a?.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Risk</span><span class="font-mono">${stock.risk_percent?.toFixed(1)}%</span></div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button onclick="createTradeBillFromStock(selectedStock)" class="flex-1 py-2 bg-blue-600 rounded-lg font-medium hover:bg-blue-700">üíº Create Trade Bill</button>
                    <button onclick="addToWatchlist('${stock.symbol}')" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">üëÄ Add to Watchlist</button>
                </div>
            </div>
        `;
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    async function newTradeBill() {
        window.tradeBillTemplate = {};  // Clear any previous data for a fresh form
        await switchTab('trade-bill');
    }

    async function createTradeBillFromStock(stock) {
        closeModal();
        // Clear previous template completely and set ONLY fresh data from stock (no ID for new bills)
        window.tradeBillTemplate = {
            // Do NOT include 'id' - this is a NEW bill
            ticker: stock.symbol,
            current_market_price: stock.price,
            entry_price: stock.entry,
            stop_loss: stock.stop_loss,
            target_price: stock.target_b,  // Target 1 = Target B
            // Use Keltner Channel values (KC 20,10,1) from screener
            upper_channel: stock.kc_upper || (stock.price * 1.03),
            lower_channel: stock.kc_lower || (stock.price * 0.97),
            risk_percent: stock.risk_percent
        };
        await switchTab('trade-bill');
        // Trigger calculation immediately after view renders
        setTimeout(() => {
            autoCalculateTradeBill();
        }, 150);
    }

    async function addToWatchlist(symbol) {
        try {
            const market = document.getElementById('market').value;
            const result = await api('POST', '/watchlists', {ticker: symbol, market});
            if (result.success) {
                toast(`Added ${symbol} to watchlist!`, 'success');
            }
        } catch(e) {
            toast('Error adding to watchlist: ' + e.message, 'error');
        }
    }

    // ========== INDICATOR FILTER CONFIGURATION ==========
    const INDICATOR_CATALOG = {
        TREND: {
            description: 'Trend Direction Indicators',
            indicators: {
                'ema_22': { name: 'EMA 22 Slope', description: 'Weekly EMA direction', recommended: true },
                'ema_13': { name: 'EMA 13 Slope', description: 'Faster EMA for shorter swings' },
                'sma_50': { name: 'SMA 50 Slope', description: '50-day moving average' },
                'sma_200': { name: 'SMA 200 Slope', description: 'Long-term trend' },
                'adx': { name: 'ADX', description: 'Trend strength (not direction)' }
            }
        },
        MOMENTUM: {
            description: 'Momentum Indicators',
            indicators: {
                'macd_histogram': { name: 'MACD Histogram', description: 'Trend momentum', recommended: true },
                'macd_signal': { name: 'MACD Signal Line', description: 'MACD crossovers' },
                'roc': { name: 'Rate of Change', description: 'Price momentum' },
                'momentum': { name: 'Momentum', description: '10-period momentum' }
            }
        },
        OSCILLATOR: {
            description: 'Oscillator Indicators',
            indicators: {
                'force_index': { name: 'Force Index (2 EMA)', description: 'Volume-weighted momentum', recommended: true },
                'stochastic': { name: 'Stochastic %K', description: 'Overbought/oversold', recommended: true },
                'rsi': { name: 'RSI (14)', description: 'Relative strength' },
                'williams_r': { name: 'Williams %R', description: 'Similar to stochastic' },
                'cci': { name: 'CCI', description: 'Commodity Channel Index' }
            }
        },
        VOLUME: {
            description: 'Volume Indicators',
            indicators: {
                'volume_ratio': { name: 'Volume Ratio', description: 'Current vs average volume' },
                'obv': { name: 'OBV Trend', description: 'On-Balance Volume' },
                'mfi': { name: 'MFI', description: 'Money Flow Index' }
            }
        },
        VOLATILITY: {
            description: 'Volatility Indicators',
            indicators: {
                'atr': { name: 'ATR', description: 'Average True Range' },
                'bollinger_position': { name: 'Bollinger Position', description: 'Price within bands' },
                'keltner_position': { name: 'Keltner Position', description: 'Price within channels' }
            }
        },
        IMPULSE: {
            description: 'Impulse System',
            indicators: {
                'impulse': { name: 'Elder Impulse', description: 'EMA + MACD-H combined', recommended: true }
            }
        }
    };
    
    const DEFAULT_FILTERS = {
        TREND: ['ema_22'],
        MOMENTUM: ['macd_histogram'],
        OSCILLATOR: ['force_index', 'stochastic'],
        VOLUME: ['volume_ratio'],
        VOLATILITY: [],
        IMPULSE: ['impulse']
    };
    
    async function loadIndicatorFilters() {
        try {
            indicatorFilters = await api('GET', '/indicator-filters');
        } catch(e) {
            indicatorFilters = JSON.parse(JSON.stringify(DEFAULT_FILTERS));
        }
        if (!indicatorFilters || Object.keys(indicatorFilters).length === 0) {
            indicatorFilters = JSON.parse(JSON.stringify(DEFAULT_FILTERS));
        }
    }
    
    async function showIndicatorFilterModal() {
        if (!indicatorFilters) await loadIndicatorFilters();
        
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-body').innerHTML = `
            <div class="p-6 max-w-4xl">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">‚öôÔ∏è Indicator Filters</h2>
                        <p class="text-gray-500">Configure which indicators to use in the screener</p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto">
                    ${Object.entries(INDICATOR_CATALOG).map(([category, data]) => `
                        <div class="bg-[#1f2937] rounded-lg p-4">
                            <h3 class="font-bold text-sm text-blue-400 mb-3">${category}: ${data.description}</h3>
                            <div class="space-y-2">
                                ${Object.entries(data.indicators).map(([id, ind]) => {
                                    const isActive = (indicatorFilters[category] || []).includes(id);
                                    return `
                                        <label class="flex items-center gap-2 cursor-pointer hover:bg-[#111827] p-1 rounded">
                                            <input type="checkbox" id="ind-${id}" ${isActive ? 'checked' : ''} 
                                                onchange="toggleIndicator('${category}', '${id}')"
                                                class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-500">
                                            <span class="flex-1">
                                                <span class="text-sm ${ind.recommended ? 'text-green-400' : ''}">${ind.name}</span>
                                                ${ind.recommended ? '<span class="text-xs text-green-500 ml-1">‚òÖ Elder</span>' : ''}
                                                <span class="text-xs text-gray-500 block">${ind.description}</span>
                                            </span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button onclick="resetIndicatorFilters()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">‚Ü∫ Reset to Elder Defaults</button>
                    <button onclick="saveIndicatorFilters()" class="flex-1 px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">üíæ Save Configuration</button>
                </div>
            </div>
        `;
    }
    
    function toggleIndicator(category, id) {
        if (!indicatorFilters[category]) indicatorFilters[category] = [];
        const idx = indicatorFilters[category].indexOf(id);
        if (idx >= 0) {
            indicatorFilters[category].splice(idx, 1);
        } else {
            indicatorFilters[category].push(id);
        }
    }
    
    function resetIndicatorFilters() {
        indicatorFilters = JSON.parse(JSON.stringify(DEFAULT_FILTERS));
        showIndicatorFilterModal(); // Re-render
        toast('Reset to Elder defaults', 'success');
    }
    
    async function saveIndicatorFilters() {
        try {
            await api('POST', '/indicator-filters', indicatorFilters);
            toast('Indicator filters saved!', 'success');
            closeModal();
        } catch(e) {
            toast('Error saving filters: ' + e.message, 'error');
        }
    }

    let allStocks = null;
    let _typeaheadTimer = null;

    async function handleTickerTypeahead(e) {
        const input = e.target.value.trim().toUpperCase();
        const list = document.getElementById('ticker-suggestions');

        if (!input || input.length < 1) {
            list.innerHTML = '';
            return;
        }

        // Debounce: wait 200ms after last keystroke
        clearTimeout(_typeaheadTimer);
        _typeaheadTimer = setTimeout(async () => {
            try {
                list.innerHTML = '<div class="px-3 py-2 text-gray-500 text-xs">Searching...</div>';
                const resp = await fetch(`/api/v2/instruments/search?q=${encodeURIComponent(input)}&limit=10`);
                const matches = await resp.json();

                if (!Array.isArray(matches) || matches.length === 0) {
                    list.innerHTML = '<div class="px-3 py-2 text-gray-500 text-xs">No matches found.</div>';
                    return;
                }

                list.innerHTML = matches.map(s => `
                    <div onclick="selectStock('${s.symbol}')" class="px-3 py-2 hover:bg-gray-700/50 cursor-pointer text-sm border-b border-gray-700/30">
                        <div class="font-mono font-bold text-blue-400">${s.symbol}</div>
                        <div class="text-xs text-gray-500">${s.name || ''}</div>
                    </div>
                `).join('');
            } catch(err) {
                console.log('Typeahead error:', err);
                list.innerHTML = '';
            }
        }, 200);
    }

    async function selectStock(symbol) {
        // Strip NSE: prefix if present ‚Äî APIs handle it internally
        const cleanSymbol = symbol.replace('NSE:', '');
        document.getElementById('tb-ticker').value = cleanSymbol;
        document.getElementById('ticker-suggestions').innerHTML = '';

        try {
            // Fetch stock data, live CMP, ATR, and candle patterns in parallel
            // Use clean symbol (no NSE: prefix) ‚Äî APIs add it internally
            const [stockResp, cmpResp, atrResp, candleResp] = await Promise.all([
                fetch(`/api/v2/data/stock/${encodeURIComponent(cleanSymbol)}`).then(r => r.json()).catch(() => null),
                fetch(`/api/v2/live-cmp/${encodeURIComponent(cleanSymbol)}`).then(r => r.json()).catch(() => null),
                fetch(`/api/v2/stock-atr/${encodeURIComponent(cleanSymbol)}`).then(r => r.json()).catch(() => null),
                fetch(`/api/v2/candle-pattern/${encodeURIComponent(cleanSymbol)}`).then(r => r.json()).catch(() => null)
            ]);

            if (!stockResp || stockResp.error) {
                // No cached data ‚Äî try to at least get live CMP
                if (cmpResp?.cmp) {
                    document.getElementById('tb-cmp').value = cmpResp.cmp.toFixed(2);
                    const srcEl = document.getElementById('cmp-source');
                    if (srcEl) { srcEl.textContent = '‚óè Live from Kite'; srcEl.className = 'text-xs mt-0.5 text-green-400'; }
                    if (atrResp?.atr) document.getElementById('tb-atr').value = atrResp.atr.toFixed(2);
                    toast(`${cleanSymbol} ‚Äî Live CMP loaded. No cached data for entry/SL/target.`, 'info');
                    autoCalculateTradeBill();
                    startCMPRefresh(cleanSymbol);
                    return;
                }
                toast(stockResp?.error || `No data for ${cleanSymbol}. Load market data from Settings.`, 'error');
                return;
            }

            // CMP: prefer live, fallback to cached close
            const cmpValue = cmpResp?.cmp || stockResp.price;
            const cmpSource = cmpResp?.source || 'cache';
            document.getElementById('tb-cmp').value = cmpValue.toFixed(2);
            const srcEl = document.getElementById('cmp-source');
            if (srcEl) srcEl.textContent = cmpSource === 'live' ? '‚óè Live from Kite' : `‚óè Cached (${stockResp.date})`;
            if (srcEl) srcEl.className = `text-xs mt-0.5 ${cmpSource === 'live' ? 'text-green-400' : 'text-gray-500'}`;

            // Entry, SL, Target from cached data
            document.getElementById('tb-entry').value = stockResp.suggested_entry.toFixed(2);
            document.getElementById('tb-sl').value = stockResp.suggested_stop.toFixed(2);
            document.getElementById('tb-target').value = stockResp.suggested_target.toFixed(2);

            // ATR
            if (atrResp?.atr) {
                document.getElementById('tb-atr').value = atrResp.atr.toFixed(2);
            } else if (stockResp.atr) {
                document.getElementById('tb-atr').value = stockResp.atr.toFixed(2);
            }

            // Candle Pattern + Conviction
            if (candleResp && !candleResp.error) {
                const patterns = candleResp.patterns || [];
                const patternNames = patterns.map(p => p.pattern || p.name || p).join(', ');
                document.getElementById('tb-candle-pattern').value = patternNames || 'No pattern';
                document.getElementById('tb-candle1-conv').value = candleResp.candle_1_conviction || '-';
                document.getElementById('tb-candle2-conv').value = candleResp.candle_2_conviction || '-';

                // Color conviction fields
                const c1El = document.getElementById('tb-candle1-conv');
                const c2El = document.getElementById('tb-candle2-conv');
                c1El.style.color = candleResp.candle_1_conviction === 'Conviction' ? '#4ade80' : '#f87171';
                c2El.style.color = candleResp.candle_2_conviction === 'Conviction' ? '#4ade80' : '#f87171';
            }

            // Trigger calculations
            autoCalculateTradeBill();
            toast(`${cleanSymbol} loaded (${cmpSource})`, 'success');

            // Start live CMP refresh if market is open
            startCMPRefresh(cleanSymbol);
        } catch(e) {
            console.error('Error fetching stock data:', e);
            toast(`Error: ${e.message}. Load data from Settings first.`, 'error');
        }
    }

    // Live CMP refresh during market hours
    let cmpRefreshInterval = null;

    function startCMPRefresh(symbol) {
        // Clear any existing interval
        if (cmpRefreshInterval) clearInterval(cmpRefreshInterval);

        // Refresh every 15 seconds during market hours
        cmpRefreshInterval = setInterval(async () => {
            try {
                const resp = await fetch(`/api/v2/live-cmp/${encodeURIComponent(symbol)}`);
                const data = await resp.json();
                if (data.cmp) {
                    document.getElementById('tb-cmp').value = data.cmp.toFixed(2);
                    const srcEl = document.getElementById('cmp-source');
                    if (srcEl) {
                        const timeStr = new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                        if (data.source === 'live') {
                            srcEl.textContent = `‚óè Live ${timeStr}`;
                            srcEl.className = 'text-xs mt-0.5 text-green-400';
                        } else {
                            srcEl.textContent = `‚óè Cached ${timeStr}`;
                            srcEl.className = 'text-xs mt-0.5 text-gray-500';
                        }
                    }
                    autoCalculateTradeBill();
                }
            } catch(e) { /* silent */ }
        }, 15000);
    }

    async function refreshLiveCMP() {
        const ticker = document.getElementById('tb-ticker').value;
        if (!ticker) { toast('Enter a ticker first', 'error'); return; }
        try {
            const resp = await fetch(`/api/v2/live-cmp/${encodeURIComponent(ticker)}`);
            const data = await resp.json();
            if (data.cmp) {
                document.getElementById('tb-cmp').value = data.cmp.toFixed(2);
                const srcEl = document.getElementById('cmp-source');
                if (srcEl) {
                    srcEl.textContent = data.source === 'live' ? '‚óè Live from Kite' : `‚óè Cached`;
                    srcEl.className = `text-xs mt-0.5 ${data.source === 'live' ? 'text-green-400' : 'text-gray-500'}`;
                }
                toast(`CMP refreshed: ‚Çπ${data.cmp.toFixed(2)} (${data.source})`, 'success');
            } else {
                toast(data.error || 'Could not get CMP', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    // ========== HISTORICAL SCREENER (formerly Backtest) ==========
    let historicalStocks = [];
    let selectedStocks = new Set();
    
    async function backtestView() {
        // Load available stocks
        try {
            const resp = await fetch('/api/v2/historical-screener/stocks?market=IN');
            const data = await resp.json();
            historicalStocks = data.stocks || [];
        } catch(e) {
            historicalStocks = ['RELIANCE','TCS','HDFCBANK','INFY','ICICIBANK','HINDUNILVR','SBIN','BHARTIARTL','ITC','KOTAKBANK'];
        }
        
        const html = `
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-blue-400">üìä Historical Signal Scanner</h2>
                <p class="text-gray-400">Scan historical data to find Elder trading signals for manual verification</p>
                
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-lg mb-4 text-blue-300">‚öôÔ∏è Scanner Configuration</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left: Stock Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Select Stocks (NIFTY 100)</label>
                            <div class="flex gap-2 mb-2">
                                <button onclick="selectAllStocks()" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Select All</button>
                                <button onclick="clearAllStocks()" class="text-xs bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">Clear All</button>
                                <button onclick="selectTopStocks()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">Top 20</button>
                            </div>
                            <div class="bg-[#1f2937] border border-gray-600 rounded-lg p-3 max-h-64 overflow-y-auto">
                                <input type="text" id="stock-search" placeholder="Search stocks..." 
                                       class="w-full bg-[#111827] border border-gray-600 rounded px-2 py-1 mb-2 text-white text-sm"
                                       oninput="filterStockList()">
                                <div id="stock-list" class="grid grid-cols-4 gap-1 text-xs">
                                    ${historicalStocks.map(s => `
                                        <label class="flex items-center space-x-1 cursor-pointer hover:bg-gray-700 p-1 rounded stock-item" data-symbol="${s}">
                                            <input type="checkbox" class="stock-checkbox rounded" value="${s}" onchange="toggleStock('${s}')">
                                            <span class="text-gray-300">${s}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1"><span id="selected-count">0</span> stocks selected</p>
                        </div>
                        
                        <!-- Right: Parameters -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Lookback Period (days)</label>
                                <input type="number" id="hs-lookback" value="180" min="30" max="365"
                                       class="w-full bg-[#1f2937] border border-gray-600 rounded-lg px-3 py-2 text-white">
                                <p class="text-xs text-gray-500 mt-1">Scan last N days for signals (30-365)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Minimum Score</label>
                                <select id="hs-min-score" class="w-full bg-[#1f2937] border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="7">7+ (A-Trades only)</option>
                                    <option value="5" selected>5+ (A & B-Trades)</option>
                                    <option value="3">3+ (Include C-Trades)</option>
                                    <option value="1">1+ (All signals)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Market</label>
                                <select id="hs-market" class="w-full bg-[#1f2937] border border-gray-600 rounded-lg px-3 py-2 text-white" disabled>
                                    <option value="IN" selected>üáÆüá≥ NSE (NIFTY 100)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Indicator Columns to Show -->
                    <div class="mt-6 pt-6 border-t border-gray-600">
                        <h4 class="font-semibold text-blue-300 mb-3">üìä Columns to Display</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-sm">
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-price" checked class="rounded col-toggle">
                                <span>Price</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-score" checked class="rounded col-toggle">
                                <span>Score</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-grade" checked class="rounded col-toggle">
                                <span>Grade</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-screen1" checked class="rounded col-toggle">
                                <span>Screen 1</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-screen2" checked class="rounded col-toggle">
                                <span>Screen 2</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-macd-h" checked class="rounded col-toggle">
                                <span>MACD-H (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-macd-line" checked class="rounded col-toggle">
                                <span>MACD Line (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-ema" checked class="rounded col-toggle">
                                <span>EMA (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-kc" checked class="rounded col-toggle">
                                <span>KC (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-fi" checked class="rounded col-toggle">
                                <span>Force Idx (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-stoch" checked class="rounded col-toggle">
                                <span>Stoch (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-pattern" class="rounded col-toggle">
                                <span>Pattern (+)</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-weekly-vals" class="rounded col-toggle">
                                <span>Weekly Values</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-daily-vals" class="rounded col-toggle">
                                <span>Daily Values</span>
                            </label>
                            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                                <input type="checkbox" id="col-entry" class="rounded col-toggle">
                                <span>Entry/Stop/Target</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex gap-3">
                        <button onclick="runHistoricalScreener()" id="run-screener-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                            üîç Scan Historical Data
                        </button>
                        <button onclick="resetHistoricalScreener()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition">
                            ‚Üª Reset
                        </button>
                        <button onclick="exportToCSV()" id="export-btn" style="display:none;" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div id="hs-results" style="display:none;" class="space-y-6">
                    
                    <!-- Summary Stats -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                        <h3 class="font-bold text-lg mb-4 text-green-400">üìà Scan Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="hs-summary">
                        </div>
                    </div>
                    
                    <!-- Signals Table -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-blue-400">üìã Historical Signals</h3>
                            <div class="flex gap-2">
                                <input type="text" id="signal-filter" placeholder="Filter by symbol..." 
                                       class="bg-[#1f2937] border border-gray-600 rounded px-3 py-1 text-white text-sm w-40"
                                       oninput="filterSignals()">
                                <select id="grade-filter" class="bg-[#1f2937] border border-gray-600 rounded px-2 py-1 text-white text-sm" onchange="filterSignals()">
                                    <option value="">All Grades</option>
                                    <option value="A">A Only</option>
                                    <option value="B">B Only</option>
                                    <option value="C">C Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="signals-table">
                                <thead class="border-b border-gray-600 bg-[#1f2937] sticky top-0">
                                    <tr class="text-left text-gray-300" id="signals-header">
                                    </tr>
                                </thead>
                                <tbody id="signals-body" class="divide-y divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination" class="mt-4 flex justify-center gap-2">
                        </div>
                    </div>
                </div>
            </div>
        `;
        return html;
    }
    
    // Historical Screener data
    let allSignals = [];
    let currentPage = 1;
    const pageSize = 50;

    // ========== CRITERIA ==========
    function criteriaView() {
        return `
            <div class="space-y-6">
                <h2 class="text-xl font-bold">üìä Grading Criteria - Elder Triple Screen</h2>
                
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-lg text-blue-400 mb-4">Screen 1: Weekly Trend (Strategic Direction)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-[#1f2937] p-4 rounded-lg">
                            <p class="font-medium text-green-400">‚úì BULLISH (Look for longs)</p>
                            <ul class="text-sm text-gray-400 mt-2 space-y-1">
                                <li>‚Ä¢ 22-Week EMA Slope: Rising</li>
                                <li>‚Ä¢ Weekly MACD-H: Rising (bulls gaining)</li>
                            </ul>
                        </div>
                        <div class="bg-[#1f2937] p-4 rounded-lg">
                            <p class="font-medium text-red-400">‚úó BEARISH (Stay out)</p>
                            <ul class="text-sm text-gray-400 mt-2 space-y-1">
                                <li>‚Ä¢ 22-Week EMA Slope: Falling</li>
                                <li>‚Ä¢ Weekly MACD-H: Falling (bears in control)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-lg text-green-400 mb-4">Screen 2: Daily Entry (Tactical Timing)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-[#1f2937] p-4 rounded-lg">
                            <p class="font-medium">Force Index (2-EMA)</p>
                            <p class="text-sm text-gray-400 mt-1"><span class="text-green-400">&lt; 0</span> = Pullback in uptrend = BUY ZONE</p>
                        </div>
                        <div class="bg-[#1f2937] p-4 rounded-lg">
                            <p class="font-medium">Stochastic</p>
                            <p class="text-sm text-gray-400 mt-1"><span class="text-green-400">&lt; 30</span> = Oversold = Good entry</p>
                        </div>
                        <div class="bg-[#1f2937] p-4 rounded-lg">
                            <p class="font-medium">Price vs 22-EMA</p>
                            <p class="text-sm text-gray-400 mt-1"><span class="text-green-400">At/Below</span> = Buying value</p>
                        </div>
                        <div class="bg-[#1f2937] p-4 rounded-lg">
                            <p class="font-medium">Impulse System</p>
                            <p class="text-sm text-gray-400 mt-1"><span class="text-green-400">GREEN</span> or <span class="text-blue-400">BLUE</span> = OK to buy</p>
                        </div>
                    </div>
                </div>

                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-lg text-yellow-400 mb-4">Signal Strength Scoring (0-10)</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-green-500/10 p-2 rounded">+2: Weekly EMA strongly rising</div>
                        <div class="bg-green-500/10 p-2 rounded">+1: Weekly MACD-H rising</div>
                        <div class="bg-green-500/10 p-2 rounded">+2: Force Index &lt; 0 (pullback)</div>
                        <div class="bg-green-500/10 p-2 rounded">+2: Stochastic &lt; 30 (oversold)</div>
                        <div class="bg-green-500/10 p-2 rounded">+1: Stochastic 30-50</div>
                        <div class="bg-green-500/10 p-2 rounded">+1: Price at/below EMA</div>
                        <div class="bg-green-500/10 p-2 rounded">+2: Bullish divergence</div>
                        <div class="bg-green-500/10 p-2 rounded">+1: Impulse GREEN</div>
                        <div class="bg-red-500/10 p-2 rounded col-span-2">-2: Impulse RED (disqualifies trade)</div>
                    </div>
                </div>

                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-lg mb-4">Grade Thresholds</h3>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-green-500/10 rounded-lg border border-green-500/30">
                            <div class="text-2xl">‚≠ê A</div>
                            <div class="text-sm text-gray-400 mt-2">Score ‚â• 5<br/>Impulse not RED</div>
                        </div>
                        <div class="text-center p-4 bg-blue-500/10 rounded-lg border border-blue-500/30">
                            <div class="text-2xl">üìä B</div>
                            <div class="text-sm text-gray-400 mt-2">Score 3-4<br/>Impulse GREEN/BLUE</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/30">
                            <div class="text-2xl">üëÄ C</div>
                            <div class="text-sm text-gray-400 mt-2">Score 1-2<br/>Watch list</div>
                        </div>
                        <div class="text-center p-4 bg-red-500/10 rounded-lg border border-red-500/30">
                            <div class="text-2xl">üõë AVOID</div>
                            <div class="text-sm text-gray-400 mt-2">Score ‚â§ 0<br/>OR Impulse RED</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function showCriteriaModal() { switchTab('criteria'); }

    // ========== CANDLESTICK PATTERN SCREENER ==========
    let candlestickResults = [];
    let candlestickLoading = false;

    let candlestickLookbackDays = 180;
    let candlestickKcLevel = -1;
    let candlestickRsiLevel = 30;
    let candlestickSelectedPatterns = [];
    function candlestickScreenerView() {
        const market = document.getElementById('market')?.value || 'IN';

        
        const resultsHtml = candlestickResults.length > 0 ? `
            <div class="bg-[#111827] rounded-xl border border-gray-700 overflow-hidden mt-4">
                <div class="p-4 border-b border-gray-700">
                    <h3 class="font-semibold">Results: ${candlestickResults.length} signals found</h3>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-800 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left">Symbol</th>
                                <th class="px-3 py-2 text-left">Date</th>
                                <th class="px-3 py-2 text-right">Close</th>
                                <th class="px-3 py-2 text-left">Patterns</th>
                                <th class="px-3 py-2 text-right">RSI</th>
                                <th class="px-3 py-2 text-right">KC Lower</th>
                                <th class="px-3 py-2 text-center">Filters</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${candlestickResults.slice(0, 100).map(s => `
                                <tr class="hover:bg-gray-700/50 ${s.filters_match ? 'bg-green-900/20' : ''}">
                                    <td class="px-3 py-2 font-medium text-blue-400">${s.symbol}</td>
                                    <td class="px-3 py-2">${s.date}</td>
                                    <td class="px-3 py-2 text-right">‚Çπ${s.close}</td>
                                    <td class="px-3 py-2">
                                        ${(s.patterns || []).map(p => `<span class="px-2 py-0.5 text-xs rounded ${p.includes('Hammer') ? 'bg-green-600/30 text-green-400' : p.includes('Engulfing') ? 'bg-blue-600/30 text-blue-400' : 'bg-purple-600/30 text-purple-400'}">${p}</span>`).join(' ')}
                                    </td>
                                    <td class="px-3 py-2 text-right ${s.rsi < 30 ? 'text-green-400 font-medium' : ''}">${s.rsi || '-'}</td>
                                    <td class="px-3 py-2 text-right">${s.kc_lower || '-'}</td>
                                    <td class="px-3 py-2 text-center">${s.filters_match ? '‚úÖ' : '‚ùå'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : '';
        
        return `
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üïØÔ∏è Candlestick Pattern Screener</h2>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-sm">
                    <strong>Patterns Detected:</strong> Hammer, Bullish Engulfing, Piercing Pattern, Tweezer Bottom<br>
                    <strong>Filters:</strong> Price &lt; KC Lower + RSI(14) &lt; 30
                </div>
                
                <div class="bg-[#111827] rounded-xl border border-gray-700 p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Lookback Days</label>
                            <input type="number" id="candlestick-lookback" value="${candlestickLookbackDays}" min="30" max="365" 
                                onchange="candlestickLookbackDays=parseInt(this.value)"
                                class="w-full bg-[#1f2937] border border-gray-600 rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">KC Channel Level</label>
                            <select id="candlestick-kc-level" onchange="candlestickKcLevel=parseFloat(this.value)"
                                class="w-full bg-[#1f2937] border border-gray-600 rounded px-3 py-2">
                                <option value="0" ${candlestickKcLevel === 0 ? 'selected' : ''}>KC &lt; 0 (Below Middle)</option>
                                <option value="-1" ${candlestickKcLevel === -1 ? 'selected' : ''}>KC &lt; -1 (Below Lower)</option>
                                <option value="-2" ${candlestickKcLevel === -2 ? 'selected' : ''}>KC &lt; -2 (Below Lower - ATR)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">RSI Level</label>
                            <select id="candlestick-rsi-level" onchange="candlestickRsiLevel=parseInt(this.value)"
                                class="w-full bg-[#1f2937] border border-gray-600 rounded px-3 py-2">
                                <option value="60" ${candlestickRsiLevel === 60 ? 'selected' : ''}>RSI &lt; 60</option>
                                <option value="50" ${candlestickRsiLevel === 50 ? 'selected' : ''}>RSI &lt; 50</option>
                                <option value="40" ${candlestickRsiLevel === 40 ? 'selected' : ''}>RSI &lt; 40</option>
                                <option value="30" ${candlestickRsiLevel === 30 ? 'selected' : ''}>RSI &lt; 30</option>
                            </select>
                        </div>
                    </div>
                    <div>
                            <label class="block text-sm font-medium mb-1">&nbsp;</label>
                            <button onclick="runCandlestickScreener()"
                                class="w-full px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 font-medium ${candlestickLoading ? 'opacity-50' : ''}">
                                ${candlestickLoading ? '‚è≥ Scanning...' : 'üîç Scan All'}
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Candlestick Patterns (Ctrl+Click to select multiple)</label>
                        <select id="candlestick-patterns" multiple
                            onchange="candlestickSelectedPatterns = Array.from(this.selectedOptions).map(opt => opt.value); render();"
                            class="w-full bg-[#1f2937] border border-gray-600 rounded px-3 py-2" style="height: 120px;">
                            <option value="Hammer" ${candlestickSelectedPatterns.includes('Hammer') ? 'selected' : ''}>Hammer - Small body at top, long lower shadow</option>
                            <option value="Bullish Engulfing" ${candlestickSelectedPatterns.includes('Bullish Engulfing') ? 'selected' : ''}>Bullish Engulfing - Green candle engulfs red candle</option>
                            <option value="Piercing Pattern" ${candlestickSelectedPatterns.includes('Piercing Pattern') ? 'selected' : ''}>Piercing Pattern - Closes above midpoint</option>
                            <option value="Tweezer Bottom" ${candlestickSelectedPatterns.includes('Tweezer Bottom') ? 'selected' : ''}>Tweezer Bottom - Two candles with same low</option>
                        </select>
                        <div class="text-xs text-gray-400 mt-1">Hold Ctrl/Cmd and click to select multiple patterns. Leave empty to scan all patterns.</div>
                    </div>
                
                ${resultsHtml}
            </div>
        `;
    }
    
    async function runCandlestickScreener() {
        candlestickLoading = true;
        render();
        
        try {
            const market = document.getElementById('market')?.value || 'IN';
            
            const res = await fetch('/api/v2/screener/candlestick/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbols: 'all',
                    lookback_days: candlestickLookbackDays,
                    market: market,
                    kc_level: candlestickKcLevel,
                    rsi_level: candlestickRsiLevel,
                    selected_patterns: candlestickSelectedPatterns.length > 0 ? candlestickSelectedPatterns : null
                })
            });
            
            const data = await res.json();
            candlestickResults = data.signals || [];
            toast(`Found ${candlestickResults.length} candlestick signals`, 'success');
        } catch (err) {
            toast('Error running screener: ' + err.message, 'error');
        } finally {
            candlestickLoading = false;
            render();
        }
    }

    // ========== RSI + MACD SCREENER ==========
    let rsiMacdResults = [];
    let rsiMacdLoading = false;
    let rsiMacdSelectedStocks = [];
    let rsiMacdLookbackDays = 180;
    
    function rsiMacdScreenerView() {
        const market = 'IN';
        // NIFTY 100 stocks for NSE India
        const stocks = [
            'RELIANCE', 'TCS', 'HDFCBANK', 'INFY', 'ICICIBANK',
            'HINDUNILVR', 'SBIN', 'BHARTIARTL', 'ITC', 'KOTAKBANK',
            'LT', 'AXISBANK', 'ASIANPAINT', 'MARUTI', 'TITAN',
            'SUNPHARMA', 'ULTRACEMCO', 'BAJFINANCE', 'WIPRO', 'HCLTECH',
            'POWERGRID', 'NTPC', 'M&M', 'JSWSTEEL'
        ];
        
        if (rsiMacdSelectedStocks.length === 0) rsiMacdSelectedStocks = stocks.slice(0, 20);
        
        const resultsHtml = rsiMacdResults.length > 0 ? `
            <div class="bg-[#111827] rounded-xl border border-gray-700 overflow-hidden mt-4">
                <div class="p-4 border-b border-gray-700">
                    <h3 class="font-semibold">Results: ${rsiMacdResults.length} signals found</h3>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-800 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left">Symbol</th>
                                <th class="px-3 py-2 text-left">Date</th>
                                <th class="px-3 py-2 text-right">Close</th>
                                <th class="px-3 py-2 text-left">Signal Type</th>
                                <th class="px-3 py-2 text-right">RSI</th>
                                <th class="px-3 py-2 text-right">RSI Œî</th>
                                <th class="px-3 py-2 text-right">MACD</th>
                                <th class="px-3 py-2 text-right">MACD Hist</th>
                                <th class="px-3 py-2 text-right">Hist Œî</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${rsiMacdResults.slice(0, 100).map(s => `
                                <tr class="hover:bg-gray-700/50 ${s.conditions?.macd_crossing_up ? 'bg-green-900/20' : ''}">
                                    <td class="px-3 py-2 font-medium text-blue-400">${s.symbol}</td>
                                    <td class="px-3 py-2">${s.date}</td>
                                    <td class="px-3 py-2 text-right">‚Çπ${s.close}</td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs rounded ${s.conditions?.macd_crossing_up ? 'bg-green-600/30 text-green-400' : 'bg-blue-600/30 text-blue-400'}">
                                            ${s.signal_type || 'RSI+MACD'}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-right text-green-400 font-medium">${s.rsi}</td>
                                    <td class="px-3 py-2 text-right ${s.rsi_change > 0 ? 'text-green-400' : 'text-red-400'}">${s.rsi_change > 0 ? '+' : ''}${s.rsi_change}</td>
                                    <td class="px-3 py-2 text-right">${s.macd}</td>
                                    <td class="px-3 py-2 text-right">${s.macd_hist}</td>
                                    <td class="px-3 py-2 text-right ${s.macd_hist_change > 0 ? 'text-green-400' : 'text-red-400'}">${s.macd_hist_change > 0 ? '+' : ''}${s.macd_hist_change}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : '';
        
        return `
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üìà RSI + MACD Indicator Screener</h2>
                </div>
                
                <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 text-sm">
                    <strong>Filter Conditions (ALL must be TRUE):</strong><br>
                    ‚Ä¢ RSI(14) &lt; 30 (Oversold)<br>
                    ‚Ä¢ RSI is Increasing (today &gt; yesterday)<br>
                    ‚Ä¢ MACD pointing up OR crossing up
                </div>
                
                <div class="bg-[#111827] rounded-xl border border-gray-700 p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Lookback Days</label>
                            <input type="number" id="rsimacd-lookback" value="${rsiMacdLookbackDays}" min="30" max="365" 
                                onchange="rsiMacdLookbackDays=parseInt(this.value)"
                                class="w-full bg-[#1f2937] border border-gray-600 rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Market</label>
                            <div class="py-2 text-gray-400">Using: üáÆüá≥ NSE (NIFTY 100)</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Selected: ${rsiMacdSelectedStocks.length}</label>
                            <div class="flex gap-2">
                                <button onclick="rsiMacdSelectedStocks=[...document.querySelectorAll('#rsimacd-stocks input:checked')].map(e=>e.value); toast('Selected '+rsiMacdSelectedStocks.length+' stocks')" 
                                    class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 text-sm">Update Selection</button>
                                <button onclick="runRsiMacdScreener()" 
                                    class="px-4 py-2 bg-green-600 rounded hover:bg-green-500 font-medium ${rsiMacdLoading ? 'opacity-50' : ''}">
                                    ${rsiMacdLoading ? '‚è≥ Scanning...' : 'üîç Scan'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border border-gray-700 rounded p-2 max-h-32 overflow-y-auto" id="rsimacd-stocks">
                        <div class="flex flex-wrap gap-1">
                            ${stocks.map(s => `
                                <label class="flex items-center gap-1 px-2 py-1 rounded text-xs cursor-pointer hover:bg-gray-700 ${rsiMacdSelectedStocks.includes(s) ? 'bg-green-600/30' : ''}">
                                    <input type="checkbox" value="${s}" ${rsiMacdSelectedStocks.includes(s) ? 'checked' : ''} class="w-3 h-3">
                                    ${s}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                ${resultsHtml}
            </div>
        `;
    }
    
    async function runRsiMacdScreener() {
        rsiMacdLoading = true;
        render();
        
        try {
            const market = document.getElementById('market')?.value || 'IN';
            const symbols = rsiMacdSelectedStocks.map(s => market === 'IN' ? s + '.NS' : s);
            
            const res = await fetch('/api/v2/screener/rsi-macd/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbols: symbols,
                    lookback_days: rsiMacdLookbackDays,
                    market: market
                })
            });
            
            const data = await res.json();
            rsiMacdResults = data.signals || [];
            toast(`Found ${rsiMacdResults.length} RSI+MACD signals`, 'success');
        } catch (err) {
            toast('Error running screener: ' + err.message, 'error');
        } finally {
            rsiMacdLoading = false;
            render();
        }
    }

    // ========== GSS (GREEN SUPERTREND STRATEGY) SCREENER ==========
    let gssLongResults = [];
    let gssShortResults = [];
    let gssLoading = false;
    let gssDirection = 'long';

    function gssScreenerView() {
        const results = gssDirection === 'long' ? gssLongResults : gssShortResults;
        const dirLabel = gssDirection === 'long' ? 'LONG' : 'SHORT';
        const patternDesc = gssDirection === 'long'
            ? 'Hammer, Pin Bar, Bullish Engulfing'
            : 'Inv-Hammer, Shooting Star, Bearish Engulfing';
        const priceLabel = gssDirection === 'long' ? 'Max Buying Price' : 'Max Selling Price';
        const priceKey = gssDirection === 'long' ? 'max_buying_price' : 'max_selling_price';
        const matched = results.filter(r => r.all_conditions_met);

        const conditionsHtml = gssDirection === 'long' ? `
            <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                <div>‚úÖ RSI(20) &gt; 50</div>
                <div>‚úÖ Stochastic %K &gt; %D</div>
                <div>‚úÖ Day Low &lt; SuperTrend</div>
                <div>‚úÖ Close &gt; SuperTrend</div>
                <div>‚úÖ SuperTrend GREEN before &amp; EOD</div>
                <div>‚úÖ SuperTrend &lt; EMA(20)</div>
            </div>
        ` : `
            <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                <div>‚úÖ RSI(20) &lt; 50</div>
                <div>‚úÖ Stochastic %K &lt; %D</div>
                <div>‚úÖ Day High &gt; SuperTrend</div>
                <div>‚úÖ Close &lt; SuperTrend</div>
                <div>‚úÖ SuperTrend RED before &amp; EOD</div>
                <div>‚úÖ SuperTrend &gt; EMA(20)</div>
            </div>
        `;

        const resultsHtml = results.length > 0 ? `
            <div class="bg-[#111827] rounded-xl border border-gray-700 overflow-hidden mt-4">
                <div class="p-3 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="font-semibold text-sm">
                        üéØ GSS ${dirLabel}: <span class="text-green-400">${matched.length} signals</span>
                        <span class="text-gray-500 ml-2">(${results.length} stocks scanned)</span>
                    </h3>
                    <div class="text-xs text-gray-500">
                        Nifty 500 | EMA 20 | EMA 50
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-2 text-left text-gray-400 text-xs">Ticker</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">CMP</th>
                                <th class="px-2 py-2 text-left text-gray-400 text-xs">Candle Pattern</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">RSI(20)</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">%K / %D</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">EMA(20)</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">SuperTrend</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">Prev ATR</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">ATR√ó0.5</th>
                                <th class="px-2 py-2 text-right text-gray-400 text-xs">${priceLabel}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${matched.map(s => `
                                <tr class="hover:bg-gray-700/50 ${gssDirection === 'long' ? 'bg-green-900/10' : 'bg-red-900/10'}">
                                    <td class="px-2 py-2 font-medium text-blue-400 font-mono">${(s.symbol || '').replace('NSE:','')}</td>
                                    <td class="px-2 py-2 text-right font-mono">‚Çπ${s.close}</td>
                                    <td class="px-2 py-2">
                                        ${(s.candle_pattern || []).map(p =>
                                            '<span class="px-1.5 py-0.5 text-xs rounded ' +
                                            (gssDirection === 'long' ? 'bg-green-600/30 text-green-400' : 'bg-red-600/30 text-red-400') +
                                            ' mr-1">' + p + '</span>'
                                        ).join('') || '<span class="text-gray-600">-</span>'}
                                    </td>
                                    <td class="px-2 py-2 text-right font-mono ${gssDirection === 'long' ? (s.rsi > 50 ? 'text-green-400' : 'text-red-400') : (s.rsi < 50 ? 'text-green-400' : 'text-red-400')}">${s.rsi != null ? s.rsi.toFixed(1) : '-'}</td>
                                    <td class="px-2 py-2 text-right font-mono text-xs">${s.stoch_k != null ? s.stoch_k.toFixed(1) : '-'} / ${s.stoch_d != null ? s.stoch_d.toFixed(1) : '-'}</td>
                                    <td class="px-2 py-2 text-right font-mono">${s.ema_20 != null ? '‚Çπ' + s.ema_20.toFixed(2) : '-'}</td>
                                    <td class="px-2 py-2 text-right font-mono ${s.st_direction === 'GREEN' ? 'text-green-400' : 'text-red-400'}">${s.supertrend != null ? '‚Çπ' + s.supertrend.toFixed(2) : '-'}</td>
                                    <td class="px-2 py-2 text-right font-mono">${s.prev_atr != null ? s.prev_atr.toFixed(2) : '-'}</td>
                                    <td class="px-2 py-2 text-right font-mono">${s.prev_atr_half != null ? s.prev_atr_half.toFixed(2) : '-'}</td>
                                    <td class="px-2 py-2 text-right font-mono font-bold text-yellow-400">${s[priceKey] != null ? '‚Çπ' + s[priceKey].toFixed(2) : '-'}</td>
                                </tr>
                            `).join('')}
                            ${matched.length === 0 ? '<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">No stocks match all GSS ' + dirLabel + ' conditions today.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : `
            <div class="bg-[#111827] rounded-xl border border-gray-700 p-8 text-center text-gray-500 mt-4">
                Click "Scan Nifty 500" to run the GSS ${dirLabel} screener
            </div>
        `;

        return `
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üéØ GSS - Green SuperTrend Strategy</h2>
                </div>

                <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 text-sm">
                    <strong>GSS ${dirLabel} Strategy:</strong> SuperTrend(10,2) + RSI(20) + Stochastic(55,34,21) + EMA(20)<br>
                    <strong>Patterns:</strong> ${patternDesc}<br>
                    <strong>Universe:</strong> Nifty 500 stocks (Daily timeframe)
                    ${conditionsHtml}
                </div>

                <div class="bg-[#111827] rounded-xl border border-gray-700 p-4">
                    <div class="flex gap-4 items-center flex-wrap">
                        <div class="flex rounded-lg overflow-hidden border border-gray-600">
                            <button onclick="gssDirection='long'; render();"
                                class="px-5 py-2 text-sm font-medium transition-colors ${gssDirection === 'long' ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                üìà Long
                            </button>
                            <button onclick="gssDirection='short'; render();"
                                class="px-5 py-2 text-sm font-medium transition-colors ${gssDirection === 'short' ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                üìâ Short
                            </button>
                        </div>
                        <button onclick="runGssScreener()"
                            class="px-6 py-2 bg-purple-600 rounded-lg hover:bg-purple-500 font-medium transition-colors ${gssLoading ? 'opacity-50 cursor-wait' : ''}"
                            ${gssLoading ? 'disabled' : ''}>
                            ${gssLoading ? '‚è≥ Scanning Nifty 500...' : 'üîç Scan Nifty 500'}
                        </button>
                        ${results.length > 0 ? '<span class="text-xs text-gray-500">Last scan: ' + matched.length + ' matched / ' + results.length + ' scanned</span>' : ''}
                    </div>
                </div>

                ${resultsHtml}
            </div>
        `;
    }

    async function runGssScreener() {
        gssLoading = true;
        render();

        try {
            const res = await fetch('/api/v2/screener/gss/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbols: 'all',
                    direction: gssDirection,
                    market: 'IN'
                })
            });

            const data = await res.json();

            if (data.error) {
                toast('GSS Error: ' + data.error, 'error');
            } else {
                const signals = data.signals || [];
                if (gssDirection === 'long') {
                    gssLongResults = signals;
                } else {
                    gssShortResults = signals;
                }
                const matched = signals.filter(s => s.all_conditions_met).length;
                toast('GSS ' + gssDirection.toUpperCase() + ': ' + matched + ' signals from ' + signals.length + ' stocks', 'success');
            }
        } catch (err) {
            toast('Error running GSS screener: ' + err.message, 'error');
        } finally {
            gssLoading = false;
            render();
        }
    }

    // ========== TRADE BILL ==========
    function tradeBillView() {
        const tb = window.tradeBillTemplate || {};
        const s = settings[0] || {trading_capital:500000, risk_per_trade:2, currency:'INR'};
        const sym = '‚Çπ';  // Always INR for NSE

        return `
            <div class="space-y-6 max-w-5xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üíº Trade Bill</h2>
                    <button onclick="switchTab('trade-bills')" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">üìã View Saved Bills</button>
                </div>

                <!-- Account Info Banner with Portfolio Context -->
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <span class="text-gray-400">Capital:</span>
                        <span class="font-mono font-bold text-blue-400 ml-1">${sym}${s.trading_capital?.toLocaleString()}</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Max Risk (${s.risk_per_trade}%):</span>
                        <span class="font-mono font-bold text-red-400 ml-1">${sym}${(s.trading_capital * s.risk_per_trade / 100).toFixed(0)}</span>
                    </div>
                    <div id="tb-portfolio-ctx" class="flex gap-4">
                        <span class="text-gray-500 text-xs">Loading portfolio...</span>
                    </div>
                </div>

                <!-- Trade Info Section -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-lg text-blue-400">Trade Info</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">Ticker (NSE)</label>
                            <input id="tb-ticker" value="${tb.ticker||''}" placeholder="RELIANCE" onkeyup="handleTickerTypeahead(event)" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono">
                            <div id="ticker-suggestions" class="mt-1 bg-[#1f2937] rounded-lg border border-gray-600 max-h-40 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">CMP (${sym}) <button onclick="refreshLiveCMP()" class="text-blue-400 hover:text-blue-300 text-xs ml-1" title="Refresh from Kite">üîÑ Live</button></label>
                            <input id="tb-cmp" type="number" value="${tb.current_market_price||''}" step="0.05" placeholder="2500.00" oninput="autoCalculateTradeBill()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono">
                            <div id="cmp-source" class="text-xs text-gray-600 mt-0.5"></div>
                        </div>
                        <div><label class="text-sm text-gray-400">Entry Price (${sym})</label><input id="tb-entry" type="number" value="${tb.entry_price||''}" step="0.05" placeholder="2450.00" oninput="autoCalculateTradeBill()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <div><label class="text-sm text-gray-400">Stop Loss (${sym})</label><input id="tb-sl" type="number" value="${tb.stop_loss||''}" step="0.05" placeholder="2400.00" oninput="autoCalculateTradeBill()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Target (${sym})</label><input id="tb-target" type="number" value="${tb.target_price||''}" step="0.05" placeholder="2600.00" oninput="autoCalculateTradeBill()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Quantity (even, whole)</label><input id="tb-qty" type="number" value="${tb.quantity||''}" step="2" min="2" placeholder="auto" oninput="autoCalculateTradeBill()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">ATR (14)</label><input id="tb-atr" type="number" value="${tb.atr||''}" step="0.01" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-gray-800" readonly></div>
                    </div>

                    <!-- Candle Pattern & Conviction -->
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-sm text-gray-400">Candle Pattern</label><input id="tb-candle-pattern" type="text" value="${tb.candle_pattern||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg text-sm bg-gray-800" readonly></div>
                        <div><label class="text-sm text-gray-400">Candle 1 (Latest)</label><input id="tb-candle1-conv" type="text" value="${tb.candle_1_conviction||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg text-sm bg-gray-800" readonly></div>
                        <div><label class="text-sm text-gray-400">Candle 2</label><input id="tb-candle2-conv" type="text" value="${tb.candle_2_conviction||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg text-sm bg-gray-800" readonly></div>
                    </div>
                </div>

                <!-- Trade Risk Section -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-lg text-red-400">üìâ Trade Risk</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-sm text-gray-400">Max Risk (${sym})</label><input id="tb-maxrisk" type="text" value="${tb.max_risk||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-gray-800" readonly></div>
                        <div><label class="text-sm text-gray-400">Risk % <span class="text-xs text-gray-500">(from settings)</span></label><input id="tb-rp" type="number" value="${tb.risk_percent||''}" step="0.01" oninput="recalcFromRiskPercent()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Risk per Share (${sym})</label><input id="tb-rps" type="number" value="${tb.risk_per_share||''}" step="0.01" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-gray-800" readonly></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-sm text-gray-400">Max Qty for Risk</label><input id="tb-maxqty" type="number" value="${tb.max_qty_for_risk||''}" step="1" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-gray-800" readonly></div>
                        <div><label class="text-sm text-gray-400">Position Size (${sym})</label><input id="tb-ps" type="text" value="${tb.position_size||''}" oninput="recalcFromPositionSize()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Other Charges (${sym})</label><input id="tb-oc" type="number" value="${tb.other_charges||0}" step="0.01" oninput="autoCalculateTradeBill()" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                    </div>
                </div>

                <!-- Reward Information (Simplified) -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-lg text-green-400">üìà Reward Information</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-sm text-gray-400">Risk (${sym})</label><input id="tb-risk" type="text" value="${tb.risk_amount_currency||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-red-900/30" readonly></div>
                        <div><label class="text-sm text-gray-400">Reward (${sym})</label><input id="tb-reward" type="text" value="${tb.reward_amount_currency||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-green-900/30" readonly></div>
                        <div><label class="text-sm text-gray-400">R:R Ratio</label><input id="tb-rrr" type="number" value="${tb.risk_reward_ratio||''}" step="0.01" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-gray-800" readonly></div>
                    </div>
                </div>

                <!-- After Entry -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-lg text-purple-400">üéØ After Entry</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-sm text-gray-400">Break Even (${sym})</label><input id="tb-be" type="number" value="${tb.break_even||''}" step="0.01" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono bg-gray-800" readonly></div>
                        <div><label class="text-sm text-gray-400">Trailing Stop (${sym})</label><input id="tb-ts" type="number" value="${tb.trailing_stop||''}" step="0.01" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-lg">Actions</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-[#1f2937]">
                            <input type="checkbox" id="tb-filled" ${tb.is_filled ? 'checked' : ''} class="w-4 h-4"><span>Filled</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-[#1f2937]">
                            <input type="checkbox" id="tb-stop-entered" ${tb.stop_entered ? 'checked' : ''} class="w-4 h-4"><span>Stop Entered</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-[#1f2937]">
                            <input type="checkbox" id="tb-target-entered" ${tb.target_entered ? 'checked' : ''} class="w-4 h-4"><span>Target Entered</span>
                        </label>
                        <label class="flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-[#1f2937]">
                            <input type="checkbox" id="tb-journal-entered" ${tb.journal_entered ? 'checked' : ''} class="w-4 h-4"><span>Journal Entered</span>
                        </label>
                    </div>
                </div>

                <!-- Comments -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-lg">Comments</h3>
                    <textarea id="tb-comments" class="w-full h-24 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg" placeholder="Add any notes about this trade...">${tb.comments||''}</textarea>
                </div>

                <!-- Elder Calculation Reference -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-lg text-gray-400 mb-3">üìñ Calculation Reference</h3>
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <div class="space-y-1">
                            <p><span class="text-red-400">Max Risk</span> = Capital √ó (Risk % √∑ 100)</p>
                            <p><span class="text-blue-400">Risk per Share</span> = Entry ‚àí Stop Loss</p>
                            <p><span class="text-blue-400">Max Qty</span> = floor(Max Risk √∑ Risk per Share √∑ 2) √ó 2 (even)</p>
                            <p><span class="text-blue-400">Position Size</span> = Quantity √ó Entry</p>
                        </div>
                        <div class="space-y-1">
                            <p><span class="text-red-400">Risk</span> = (Entry ‚àí SL) √ó Quantity</p>
                            <p><span class="text-green-400">Reward</span> = (Target ‚àí Entry) √ó Quantity</p>
                            <p><span class="text-purple-400">R:R Ratio</span> = Reward √∑ Risk</p>
                            <p><span class="text-yellow-400">Conviction</span> = body > 50% of candle range</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <button onclick="calculateTradeBillMetrics()" class="flex-1 py-3 bg-purple-600 rounded-lg font-medium hover:bg-purple-700">üî¢ Calculate Metrics</button>
                        <button onclick="saveTradeBill()" class="flex-1 py-3 bg-green-600 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50" id="save-btn">üíæ Save Trade Bill</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="fillJournalFromBill()" class="flex-1 py-2.5 bg-blue-600 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed text-sm" id="fill-journal-btn" ${tb.id ? '' : 'disabled'}>üìì Journal</button>
                        <button onclick="placeGttOrder()" class="flex-1 py-2.5 bg-orange-600 rounded-lg font-medium hover:bg-orange-700 disabled:opacity-40 disabled:cursor-not-allowed text-sm" id="gtt-btn" ${tb.id ? '' : 'disabled'}>üìä GTT Buy</button>
                        <button onclick="placeNrmlOrder('BUY')" class="flex-1 py-2.5 bg-cyan-600 rounded-lg font-medium hover:bg-cyan-700 disabled:opacity-40 disabled:cursor-not-allowed text-sm" id="nrml-btn" ${tb.id ? '' : 'disabled'}>üî∑ NRML Buy</button>
                        <button onclick="placeNrmlOrder('SELL')" class="flex-1 py-2.5 bg-pink-600 rounded-lg font-medium hover:bg-pink-700 disabled:opacity-40 disabled:cursor-not-allowed text-sm" id="nrml-sell-btn" ${tb.id ? '' : 'disabled'}>üîª NRML Sell</button>
                        <button onclick="placeOcoSellOrder()" class="flex-1 py-2.5 bg-red-600 rounded-lg font-medium hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed text-sm" id="oco-btn" ${tb.id ? '' : 'disabled'}>üéØ OCO Sell</button>
                    </div>
                    <p class="text-xs text-gray-500 text-center">${tb.id ? 'Buttons enabled - bill is saved.' : 'Save the Trade Bill first to enable order buttons.'} OCO Sell = SL GTT (full qty) + Target GTT (half qty).</p>
                </div>
            </div>
        `;
    }

    // Auto-calculate when trade bill view is rendered
    function triggerTradeBillCalc() {
        setTimeout(() => {
            if (document.getElementById('tb-entry')) {
                autoCalculateTradeBill();
            }
            // If editing an existing bill, set currentBillId so action buttons work
            const tb = window.tradeBillTemplate || {};
            if (tb.id) {
                window.currentBillId = tb.id;
            }
            // Load portfolio context into banner
            loadPortfolioContext();
        }, 100);
    }

    async function loadPortfolioContext() {
        const el = document.getElementById('tb-portfolio-ctx');
        if (!el) return;
        try {
            const resp = await fetch('/api/v2/portfolio/context');
            const data = await resp.json();
            const s = data.summary || {};
            const sym = '‚Çπ';
            el.innerHTML = `
                <div><span class="text-gray-500 text-xs">Positions:</span> <span class="font-mono text-xs text-blue-400">${s.open_positions || 0}</span></div>
                <div><span class="text-gray-500 text-xs">Locked:</span> <span class="font-mono text-xs text-red-400">${sym}${(s.total_locked || 0).toLocaleString()}</span></div>
                <div><span class="text-gray-500 text-xs">Used:</span> <span class="font-mono text-xs text-yellow-400">${(s.capital_used_pct || 0).toFixed(1)}%</span></div>
            `;
        } catch(e) {
            el.innerHTML = '<span class="text-gray-600 text-xs">Portfolio: N/A</span>';
        }
    }

    function calculateTradeBillMetrics() {
        autoCalculateTradeBill();
        toast('Metrics calculated!', 'success');
    }

    function autoCalculateTradeBill() {
        // Get input values
        const entry = parseFloat(document.getElementById('tb-entry').value) || 0;
        const sl = parseFloat(document.getElementById('tb-sl').value) || 0;
        const target = parseFloat(document.getElementById('tb-target').value) || 0;
        const cmp = parseFloat(document.getElementById('tb-cmp').value) || 0;
        const manualQty = parseInt(document.getElementById('tb-qty').value) || 0;
        const otherCharges = parseFloat(document.getElementById('tb-oc').value) || 0;

        const s = settings[0] || {trading_capital: 500000, risk_per_trade: 2, currency: 'INR'};
        const acSize = s.trading_capital;
        const riskPerTradePercent = s.risk_per_trade;

        // Need at least entry and stop loss
        if (!entry || !sl) return;

        // Risk per Share = Entry - SL
        const riskPerShare = Math.round((entry - sl) * 100) / 100;
        if (riskPerShare <= 0) return;

        // Max Risk = Capital √ó (Risk% / 100)
        const maxRisk = Math.round(acSize * (riskPerTradePercent / 100));

        // Max Qty = even number: floor(maxRisk / riskPerShare / 2) * 2
        const maxQtyRisk = riskPerShare > 0 ? Math.floor(maxRisk / riskPerShare / 2) * 2 : 0;

        // Quantity (use manual if entered, otherwise maxQtyRisk) - EVEN WHOLE SHARES
        const quantity = manualQty > 0 ? manualQty : maxQtyRisk;

        // Position Size = Quantity √ó Entry Price
        const positionSize = Math.round(quantity * entry);

        // Risk (‚Çπ) = (Entry - SL) √ó Quantity
        const stopLossPips = Math.round((entry - sl) * 100) / 100;
        const risk = Math.round(stopLossPips * quantity);

        // Reward (‚Çπ) = (Target - Entry) √ó Quantity
        const targetPips = target ? Math.round((target - entry) * 100) / 100 : 0;
        const reward = targetPips > 0 ? Math.round(targetPips * quantity) : 0;

        // R:R Ratio = Reward / Risk
        const riskRewardRatio = risk > 0 && reward > 0 ? Math.round((reward / risk) * 100) / 100 : 0;

        // Break Even = Entry + (Other Charges / Quantity)
        const breakEven = quantity > 0 && otherCharges > 0 ? Math.round((entry + (otherCharges / quantity)) * 100) / 100 : entry;

        // Trailing Stop = Stop Loss initially
        const trailingStop = sl;

        // Update form fields - EVEN WHOLE SHARES
        if (!manualQty) document.getElementById('tb-qty').value = quantity;
        document.getElementById('tb-maxrisk').value = maxRisk.toLocaleString();
        document.getElementById('tb-maxqty').value = maxQtyRisk;
        document.getElementById('tb-rps').value = riskPerShare.toFixed(2);
        document.getElementById('tb-ps').value = positionSize.toLocaleString();
        document.getElementById('tb-rp').value = riskPerTradePercent.toFixed(2);
        document.getElementById('tb-risk').value = risk.toLocaleString();
        document.getElementById('tb-reward').value = reward.toLocaleString();
        document.getElementById('tb-rrr').value = riskRewardRatio;
        document.getElementById('tb-be').value = breakEven.toFixed(2);
        document.getElementById('tb-ts').value = trailingStop.toFixed(2);
    }

    // 9. Recalculate from Position Size - when user manually changes position size
    function recalcFromPositionSize() {
        const entry = parseFloat(document.getElementById('tb-entry').value) || 0;
        const positionSizeStr = document.getElementById('tb-ps').value.replace(/,/g, '');
        const newPositionSize = parseFloat(positionSizeStr) || 0;

        if (!entry || !newPositionSize) return;

        // Quantity = Position Size / Entry Price (whole shares)
        const newQty = Math.floor(newPositionSize / entry);
        document.getElementById('tb-qty').value = newQty;

        // Recalculate everything with new quantity
        autoCalculateTradeBill();
    }

    // 10. Recalculate from Risk % - when user manually changes risk percentage
    function recalcFromRiskPercent() {
        const entry = parseFloat(document.getElementById('tb-entry').value) || 0;
        const sl = parseFloat(document.getElementById('tb-sl').value) || 0;
        const newRiskPercent = parseFloat(document.getElementById('tb-rp').value) || 0;

        if (!entry || !sl || !newRiskPercent) return;

        const s = settings[0] || {trading_capital: 500000};
        const acSize = s.trading_capital;

        // Risk per Share = Entry - SL
        const riskPerShare = entry - sl;
        if (riskPerShare <= 0) return;

        // New Max Risk based on user-entered risk %
        const newMaxRisk = Math.round(acSize * (newRiskPercent / 100));

        // New Max Qty = even number
        const newQty = Math.floor(newMaxRisk / riskPerShare / 2) * 2;

        // Update quantity and position size
        document.getElementById('tb-qty').value = newQty;
        document.getElementById('tb-maxrisk').value = newMaxRisk.toLocaleString();

        // Recalculate everything with new values
        autoCalculateTradeBill();
    }

    async function saveTradeBill() {
        const s = settings[0] || {id:1};
        const ticker = document.getElementById('tb-ticker').value;
        
        if (!ticker) {
            toast('Please enter a ticker', 'error');
            return;
        }

        // Parse position_size and risk values (remove commas for INR formatted numbers)
        const positionSizeStr = document.getElementById('tb-ps').value.replace(/,/g, '');
        const maxRiskStr = document.getElementById('tb-maxrisk').value.replace(/,/g, '');
        const riskStr = document.getElementById('tb-risk').value.replace(/,/g, '');
        const rewardStr = document.getElementById('tb-reward').value.replace(/,/g, '');

        const data = {
            ticker: ticker,
            current_market_price: parseFloat(document.getElementById('tb-cmp').value) || null,
            entry_price: parseFloat(document.getElementById('tb-entry').value),
            stop_loss: parseFloat(document.getElementById('tb-sl').value),
            target_price: parseFloat(document.getElementById('tb-target').value),
            quantity: parseInt(document.getElementById('tb-qty').value) || 0,
            atr: parseFloat(document.getElementById('tb-atr').value) || null,
            candle_pattern: document.getElementById('tb-candle-pattern').value || null,
            candle_1_conviction: document.getElementById('tb-candle1-conv').value || null,
            candle_2_conviction: document.getElementById('tb-candle2-conv').value || null,
            max_risk: parseFloat(maxRiskStr) || null,
            max_qty_for_risk: parseInt(document.getElementById('tb-maxqty').value) || null,
            other_charges: parseFloat(document.getElementById('tb-oc').value) || 0,
            risk_per_share: parseFloat(document.getElementById('tb-rps').value) || null,
            position_size: parseFloat(positionSizeStr) || null,
            risk_percent: parseFloat(document.getElementById('tb-rp').value) || null,
            risk_amount_currency: parseFloat(riskStr) || null,
            reward_amount_currency: parseFloat(rewardStr) || null,
            risk_reward_ratio: parseFloat(document.getElementById('tb-rrr').value) || null,
            break_even: parseFloat(document.getElementById('tb-be').value) || null,
            trailing_stop: parseFloat(document.getElementById('tb-ts').value) || null,
            is_filled: document.getElementById('tb-filled').checked,
            stop_entered: document.getElementById('tb-stop-entered').checked,
            target_entered: document.getElementById('tb-target-entered').checked,
            journal_entered: document.getElementById('tb-journal-entered').checked,
            comments: document.getElementById('tb-comments').value
        };

        try {
            const tb = window.tradeBillTemplate || {};
            let result;

            if (tb.id) {
                // Update existing
                result = await api('PUT', `/trade-bills/${tb.id}`, data);
                if (result.success) {
                    toast(`Trade Bill for ${ticker} updated!`, 'success');
                    window.currentBillId = tb.id;
                } else {
                    toast(`Error updating Trade Bill: ${result.error || 'Unknown error'}`, 'error');
                    console.error('Update failed:', result);
                    return;
                }
            } else {
                // Create new
                result = await api('POST', '/trade-bills', data);
                if (result.success || result.id) {
                    toast(`Trade Bill for ${ticker} saved!`, 'success');
                    window.currentBillId = result.id;
                    // Update tradeBillTemplate so subsequent saves do UPDATE instead of INSERT
                    window.tradeBillTemplate = window.tradeBillTemplate || {};
                    window.tradeBillTemplate.id = result.id;
                } else {
                    toast(`Error saving Trade Bill: ${result.error || 'Unknown error'}`, 'error');
                    console.error('Create failed:', result);
                    return;
                }
            }

            // Enable action buttons after save
            if (window.currentBillId) {
                document.getElementById('fill-journal-btn').disabled = false;
                document.getElementById('gtt-btn').disabled = false;
                document.getElementById('nrml-btn').disabled = false;
                document.getElementById('nrml-sell-btn').disabled = false;
                document.getElementById('oco-btn').disabled = false;
            }
        } catch(e) {
            toast('Error saving Trade Bill: ' + e.message, 'error');
            console.error('Save error:', e);
        }
    }

    // ===== ORDER CONFIRMATION POPUP =====
    function showOrderConfirmation(title, params, onConfirm) {
        const modal = document.getElementById('modal');
        const sym = '‚Çπ';
        const rows = params.map(p => `
            <tr class="border-t border-gray-700/50">
                <td class="py-2 pr-4 text-gray-400 text-sm">${p.label}</td>
                <td class="py-2 font-mono text-sm font-bold ${p.color || 'text-white'}">${p.value}</td>
            </tr>
        `).join('');

        modal.innerHTML = `
            <div class="bg-[#1f2937] rounded-xl border border-gray-600 max-w-md w-full p-6 space-y-4">
                <h3 class="text-lg font-bold text-white">${title}</h3>
                <table class="w-full">${rows}</table>
                <div class="border-t border-gray-700 pt-4 flex gap-3">
                    <button id="confirm-order-btn" class="flex-1 py-2.5 bg-green-600 rounded-lg font-medium hover:bg-green-700 text-white">‚úÖ Confirm & Place Order</button>
                    <button id="cancel-order-btn" class="flex-1 py-2.5 bg-gray-600 rounded-lg font-medium hover:bg-gray-700 text-white">‚ùå Cancel</button>
                </div>
            </div>
        `;
        modal.classList.remove('hidden');

        return new Promise((resolve) => {
            document.getElementById('confirm-order-btn').onclick = () => { modal.classList.add('hidden'); resolve(true); };
            document.getElementById('cancel-order-btn').onclick = () => { modal.classList.add('hidden'); resolve(false); };
        });
    }

    // Fill Journal from saved Trade Bill
    async function fillJournalFromBill() {
        if (!window.currentBillId) {
            toast('Please save the Trade Bill first', 'error');
            return;
        }

        const ticker = document.getElementById('tb-ticker').value;
        const entry = document.getElementById('tb-entry').value;
        const sl = document.getElementById('tb-sl').value;
        const target = document.getElementById('tb-target').value;

        const confirmed = await showOrderConfirmation('üìì Create Trade Journal', [
            { label: 'Action', value: 'Create Journal Entry', color: 'text-blue-400' },
            { label: 'Symbol', value: ticker, color: 'text-blue-400' },
            { label: 'Entry Price', value: `‚Çπ${entry}` },
            { label: 'Stop Loss', value: `‚Çπ${sl}`, color: 'text-red-400' },
            { label: 'Target', value: `‚Çπ${target}`, color: 'text-green-400' },
            { label: 'Source', value: `Trade Bill #${window.currentBillId}` }
        ]);
        if (!confirmed) return;

        try {
            const result = await fetch(`/api/v2/trade-journal/from-bill/${window.currentBillId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await result.json();

            if (data.success) {
                toast('Journal created! Opening Trade Journal...', 'success');
                window.currentJournalId = data.id;
                await switchTab('trade-journal');
            } else {
                toast(data.error || 'Failed to create journal', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // Place GTT Order from Trade Bill
    async function placeGttOrder() {
        if (!window.currentBillId) {
            toast('Please save the Trade Bill first', 'error');
            return;
        }

        const entry = parseFloat(document.getElementById('tb-entry').value);
        const qty = parseInt(document.getElementById('tb-qty').value);
        const ticker = document.getElementById('tb-ticker').value;
        const cmp = parseFloat(document.getElementById('tb-cmp').value) || 0;

        if (!entry || !qty || !ticker) {
            toast('Missing entry price, quantity or ticker', 'error');
            return;
        }

        const totalValue = (entry * qty).toLocaleString();
        const confirmed = await showOrderConfirmation('üìä Place GTT Buy Order', [
            { label: 'Order Type', value: 'GTT (Good Till Triggered)', color: 'text-orange-400' },
            { label: 'Symbol', value: ticker, color: 'text-blue-400' },
            { label: 'Transaction', value: 'BUY', color: 'text-green-400' },
            { label: 'Trigger Price', value: `‚Çπ${entry.toFixed(2)}` },
            { label: 'Limit Price', value: `‚Çπ${entry.toFixed(2)}` },
            { label: 'Quantity', value: `${qty} shares` },
            { label: 'Total Value', value: `‚Çπ${totalValue}`, color: 'text-yellow-400' },
            { label: 'Current CMP', value: cmp ? `‚Çπ${cmp.toFixed(2)}` : 'N/A' },
            { label: 'Product', value: 'CNC (Delivery)' }
        ]);
        if (!confirmed) return;

        try {
            const result = await fetch('/api/v2/kite/gtt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: ticker,
                    transaction_type: 'BUY',
                    trigger_price: entry,
                    quantity: qty,
                    order_type: 'LIMIT',
                    limit_price: entry
                })
            });
            const data = await result.json();

            if (data.success) {
                toast(`GTT Order placed! Trigger ID: ${data.trigger_id}`, 'success');
            } else {
                toast(data.error || 'Failed to place GTT order', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // Place OCO Split Sell (full qty SL + half qty target as separate GTTs)
    async function placeOcoSellOrder() {
        if (!window.currentBillId) {
            toast('Please save the Trade Bill first', 'error');
            return;
        }

        const sl = parseFloat(document.getElementById('tb-sl').value);
        const target = parseFloat(document.getElementById('tb-target').value);
        const qty = parseInt(document.getElementById('tb-qty').value);
        const ticker = document.getElementById('tb-ticker').value;
        const halfQty = Math.floor(qty / 2);
        const slPrice = Math.round(sl * 0.99 * 100) / 100;

        if (!sl || !target || !qty || !ticker) {
            toast('Missing stop loss, target, quantity or ticker', 'error');
            return;
        }

        if (qty < 2) {
            toast('Quantity must be at least 2 for OCO split', 'error');
            return;
        }

        const confirmed = await showOrderConfirmation('üéØ Place OCO Split Sell Orders', [
            { label: 'Order Type', value: 'OCO Split (2 GTT Orders)', color: 'text-red-400' },
            { label: 'Symbol', value: ticker, color: 'text-blue-400' },
            { label: 'Transaction', value: 'SELL', color: 'text-red-400' },
            { label: 'üî¥ SL Trigger', value: `‚Çπ${sl.toFixed(2)}`, color: 'text-red-400' },
            { label: 'üî¥ SL Limit', value: `‚Çπ${slPrice.toFixed(2)}`, color: 'text-red-400' },
            { label: 'üî¥ SL Quantity', value: `${qty} shares (full)`, color: 'text-red-400' },
            { label: 'üü¢ Target Trigger', value: `‚Çπ${target.toFixed(2)}`, color: 'text-green-400' },
            { label: 'üü¢ Target Limit', value: `‚Çπ${target.toFixed(2)}`, color: 'text-green-400' },
            { label: 'üü¢ Target Quantity', value: `${halfQty} shares (half)`, color: 'text-green-400' }
        ]);
        if (!confirmed) return;

        try {
            const result = await fetch('/api/v2/kite/gtt/oco-split', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: ticker,
                    quantity: qty,
                    stop_loss_trigger: sl,
                    stop_loss_price: slPrice,
                    target_trigger: target,
                    target_price: target
                })
            });
            const data = await result.json();

            if (data.success) {
                toast(`OCO Split placed! SL: ${qty} shares, Target: ${halfQty} shares`, 'success');
            } else {
                toast(data.sl_gtt?.error || data.target_gtt?.error || 'Failed to place OCO orders', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // Place NRML Order (BUY or SELL)
    async function placeNrmlOrder(txnType='BUY', overrideTicker=null, overrideQty=null, overridePrice=null) {
        // Support calling from TradeBill or TradeLog
        const ticker = overrideTicker || (document.getElementById('tb-ticker') ? document.getElementById('tb-ticker').value : '');
        const qty = overrideQty || (document.getElementById('tb-qty') ? parseInt(document.getElementById('tb-qty').value) : 0);
        const price = overridePrice || (document.getElementById('tb-entry') ? parseFloat(document.getElementById('tb-entry').value) : 0);
        const cmp = document.getElementById('tb-cmp') ? parseFloat(document.getElementById('tb-cmp').value) || 0 : 0;

        if (!window.currentBillId && !overrideTicker) {
            toast('Please save the Trade Bill first', 'error');
            return;
        }

        if (!price || !qty || !ticker) {
            toast('Missing price, quantity or ticker', 'error');
            return;
        }

        const isBuy = txnType === 'BUY';
        const totalValue = (price * qty).toLocaleString();
        const confirmed = await showOrderConfirmation(`${isBuy ? 'üî∑' : 'üîª'} Place NRML ${txnType} Order`, [
            { label: 'Order Type', value: 'NRML (Delivery)', color: isBuy ? 'text-cyan-400' : 'text-pink-400' },
            { label: 'Symbol', value: ticker, color: 'text-blue-400' },
            { label: 'Transaction', value: txnType, color: isBuy ? 'text-green-400' : 'text-red-400' },
            { label: 'Price', value: `‚Çπ${price.toFixed(2)}` },
            { label: 'Quantity', value: `${qty} shares` },
            { label: 'Total Value', value: `‚Çπ${totalValue}`, color: 'text-yellow-400' },
            { label: 'Product', value: 'CNC (Delivery)' },
            { label: 'Order Type', value: 'LIMIT' }
        ]);
        if (!confirmed) return;

        try {
            const result = await fetch('/api/v2/kite/orders/nrml', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: ticker,
                    transaction_type: txnType,
                    quantity: qty,
                    price: price,
                    order_type: 'LIMIT'
                })
            });
            const data = await result.json();

            if (data.success) {
                toast(`NRML ${txnType} Order placed! Order ID: ${data.order_id}`, 'success');
            } else {
                toast(data.error || 'Failed to place order', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // Place Sell GTT from TradeLog for remaining position
    async function placeTradeLogSellGtt(ticker, remainingQty, targetPrice, slPrice) {
        if (!ticker || !remainingQty || !targetPrice) {
            toast('Missing ticker, remaining quantity, or target price', 'error');
            return;
        }

        const confirmed = await showOrderConfirmation('üìä Place Sell GTT (Remaining Position)', [
            { label: 'Order Type', value: 'GTT SELL (Remaining 50%)', color: 'text-orange-400' },
            { label: 'Symbol', value: ticker, color: 'text-blue-400' },
            { label: 'Transaction', value: 'SELL', color: 'text-red-400' },
            { label: 'Trigger (Target)', value: `‚Çπ${targetPrice.toFixed(2)}`, color: 'text-green-400' },
            { label: 'Quantity', value: `${remainingQty} shares` },
            { label: 'Product', value: 'CNC (Delivery)' }
        ]);
        if (!confirmed) return;

        try {
            const result = await fetch('/api/v2/kite/gtt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: ticker,
                    transaction_type: 'SELL',
                    trigger_price: targetPrice,
                    quantity: remainingQty,
                    order_type: 'LIMIT',
                    limit_price: targetPrice
                })
            });
            const data = await result.json();

            if (data.success) {
                toast(`Sell GTT placed! Trigger ID: ${data.trigger_id}`, 'success');
            } else {
                toast(data.error || 'Failed to place GTT', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // ========== TRADE BILLS LIST ==========
    async function tradeBillsView() {
        try {
            const bills = await api('GET', '/trade-bills');
            const sym = '‚Çπ';  // Always INR for NSE

            if (!Array.isArray(bills)) {
                return `<div class="text-red-400">Error: API returned invalid data</div>`;
            }

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">üìã Trade Bills</h2>
                        <div class="flex gap-2">
                            <button onclick="exportCSVData('trade-bills')" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">üì• Export CSV</button>
                            <button onclick="importCSVData('trade-bills')" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">üì§ Import CSV</button>
                            <button onclick="newTradeBill()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">‚ûï New Trade Bill</button>
                        </div>
                    </div>

                    ${bills.length > 0 ? `
                        <div class="bg-[#111827] rounded-xl overflow-hidden border border-gray-700">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-[#1f2937]">
                                        <tr>
                                            <th class="text-left p-3 font-medium text-gray-400">Ticker</th>
                                            <th class="text-right p-3 font-medium text-gray-400">Entry</th>
                                            <th class="text-right p-3 font-medium text-gray-400">SL</th>
                                            <th class="text-right p-3 font-medium text-gray-400">Target</th>
                                            <th class="text-right p-3 font-medium text-gray-400">Qty</th>
                                            <th class="text-right p-3 font-medium text-gray-400">Risk (${sym})</th>
                                            <th class="text-right p-3 font-medium text-gray-400">R:R</th>
                                            <th class="text-center p-3 font-medium text-gray-400">Status</th>
                                            <th class="text-center p-3 font-medium text-gray-400">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${bills.map(b => `
                                            <tr class="border-t border-gray-700/50 hover:bg-[#1f2937]/50">
                                                <td class="p-3 font-mono font-bold text-blue-400">${b.ticker}</td>
                                                <td class="p-3 text-right font-mono">${sym}${b.entry_price?.toFixed(2)}</td>
                                                <td class="p-3 text-right font-mono text-red-400">${sym}${b.stop_loss?.toFixed(2)}</td>
                                                <td class="p-3 text-right font-mono text-green-400">${sym}${b.target_price?.toFixed(2)}</td>
                                                <td class="p-3 text-right font-mono">${b.quantity?.toFixed(1)}</td>
                                                <td class="p-3 text-right font-mono">${sym}${b.risk_amount_currency?.toFixed(2)}</td>
                                                <td class="p-3 text-right font-mono ${b.risk_reward_ratio >= 2 ? 'text-green-400' : 'text-yellow-400'}">${b.risk_reward_ratio?.toFixed(2)}</td>
                                                <td class="p-3 text-center">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${
                                                        b.is_filled ? 'bg-green-500/20 text-green-400' :
                                                        b.status === 'active' ? 'bg-blue-500/20 text-blue-400' :
                                                        'bg-gray-500/20 text-gray-400'
                                                    }">${b.is_filled ? '‚úì Filled' : b.status || 'pending'}</span>
                                                </td>
                                                <td class="p-3 text-center">
                                                    <button onclick="editTradeBill(${b.id})" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-blue-600 mr-1">Edit</button>
                                                    <button onclick="deleteTradeBill(${b.id})" class="px-2 py-1 bg-gray-700 rounded text-xs hover:bg-red-600">Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-20 text-gray-500">
                            <div class="text-6xl mb-4">üìã</div>
                            <h3 class="text-xl font-semibold">No Trade Bills yet</h3>
                            <p class="mt-2">Create your first trade bill to get started</p>
                            <button onclick="newTradeBill()" class="mt-4 px-6 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">Create Trade Bill</button>
                        </div>
                    `}
                </div>
            `;
        } catch(e) {
            console.error('Error loading Trade Bills:', e);
            return `<div class="text-red-400">Error loading Trade Bills: ${e.message}</div>`;
        }
    }

    async function editTradeBill(id) {
        try {
            const bill = await api('GET', `/trade-bills/${id}`);
            window.tradeBillTemplate = bill;
            await switchTab('trade-bill');
        } catch(e) {
            toast('Error loading Trade Bill: ' + e.message, 'error');
        }
    }

    async function deleteTradeBill(id) {
        if (confirm('Delete this Trade Bill?')) {
            try {
                await api('DELETE', `/trade-bills/${id}`);
                toast('Trade Bill deleted!', 'success');
                await render();
            } catch(e) {
                toast('Error deleting Trade Bill: ' + e.message, 'error');
            }
        }
    }

    // ========== TRADE JOURNAL V2 ==========
    let currentJournal = null;

    async function tradeJournalView() {
        const sym = '‚Çπ';
        let journals = [];

        try {
            const resp = await fetch('/api/v2/trade-journal');
            const data = await resp.json();
            journals = data.journals || [];
        } catch(e) {
            console.log('No journals yet');
        }

        // If editing a specific journal
        if (window.currentJournalId) {
            try {
                const resp = await fetch(`/api/v2/trade-journal/${window.currentJournalId}`);
                currentJournal = await resp.json();
            } catch(e) {
                currentJournal = null;
            }
        }

        const j = currentJournal || {};
        const entries = j.entries || [];
        const exits = j.exits || [];

        const entryTactics = ['Limit Order', 'Market Order', 'Stop Order', 'Scale In', 'Breakout'];
        const exitTactics = ['Target Hit', 'Stop Loss Hit', 'Trailing Stop', 'Time Exit', 'Scale Out', 'Manual'];
        const orderTypes = ['CNC', 'MIS', 'NRML'];
        const mentalStates = ['Confident', 'Neutral', 'Anxious', 'FOMO', 'Revenge'];
        const directions = ['Long', 'Short'];
        const statuses = ['open', 'closed', 'cancelled'];
        const grades = ['A', 'B', 'C'];

        return `
            <div class="space-y-4">
                <!-- Header with tabs -->
                <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                    <div class="flex gap-4">
                        <button onclick="showJournalForm()" class="px-4 py-2 ${currentJournal ? 'bg-blue-600' : 'bg-gray-700'} rounded-t-lg">TradeJournal</button>
                        <button onclick="showJournalRecords()" class="px-4 py-2 ${!currentJournal ? 'bg-blue-600' : 'bg-gray-700'} rounded-t-lg">Records</button>
                    </div>
                    <button onclick="newJournal()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">+ New Journal</button>
                </div>

                ${currentJournal ? `
                <!-- Trade Journal Form (matching screenshot layout) -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <div class="grid grid-cols-4 gap-4">
                        <!-- Ticker Info -->
                        <div class="border border-gray-600 rounded p-3 space-y-2">
                            <h4 class="text-sm font-bold text-gray-400 border-b border-gray-600 pb-1">Ticker Info</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div><label class="text-gray-500">Ticker</label><input id="tj-ticker" value="${j.ticker||''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">Journal Date</label><input type="date" id="tj-date" value="${j.journal_date||new Date().toISOString().split('T')[0]}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded"></div>
                                <div><label class="text-gray-500">CMP</label><input type="number" id="tj-cmp" value="${j.cmp||''}" step="0.01" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">Remaining Qty</label><input type="number" id="tj-remaining" value="${j.remaining_qty||0}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                                <div><label class="text-gray-500">Direction</label><select id="tj-direction" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${directions.map(d => `<option ${j.direction===d?'selected':''}>${d}</option>`).join('')}</select></div>
                                <div><label class="text-gray-500">Order Type</label><select id="tj-ordertype" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${orderTypes.map(o => `<option ${j.order_type===o?'selected':''}>${o}</option>`).join('')}</select></div>
                                <div><label class="text-gray-500">Status</label><select id="tj-status" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${statuses.map(s => `<option ${j.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
                                <div><label class="text-gray-500">Mental State</label><select id="tj-mental" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${mentalStates.map(m => `<option ${j.mental_state===m?'selected':''}>${m}</option>`).join('')}</select></div>
                            </div>
                        </div>

                        <!-- Trade Setup -->
                        <div class="border border-gray-600 rounded p-3 space-y-2">
                            <h4 class="text-sm font-bold text-gray-400 border-b border-gray-600 pb-1">Trade Setup</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div><label class="text-gray-500">Entry</label><input type="number" id="tj-entry" value="${j.entry_price||''}" step="0.01" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">Quantity</label><input type="number" id="tj-qty" value="${j.quantity||''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">Target</label><input type="number" id="tj-target" value="${j.target_price||''}" step="0.01" class="w-full px-2 py-1 bg-green-900/30 border border-green-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">Stop Loss</label><input type="number" id="tj-sl" value="${j.stop_loss||''}" step="0.01" class="w-full px-2 py-1 bg-red-900/30 border border-red-600 rounded font-mono"></div>
                                <div class="col-span-2"><label class="text-gray-500">RR Ratio</label><input type="number" id="tj-rr" value="${j.rr_ratio||''}" step="0.01" class="w-full px-2 py-1 bg-yellow-900/30 border border-yellow-600 rounded font-mono" readonly></div>
                            </div>
                        </div>

                        <!-- Risk (Pyramiding Model) -->
                        <div class="border border-red-600/30 rounded p-3 space-y-2">
                            <h4 class="text-sm font-bold text-red-400 border-b border-gray-600 pb-1">Risk (Pyramiding)</h4>
                            <div class="grid grid-cols-1 gap-2 text-xs">
                                <div><label class="text-gray-500">Initial Stop Loss <span class="text-gray-600">(static)</span></label><input type="number" id="tj-initialsl" value="${j.initial_stop_loss||j.stop_loss||''}" step="0.01" class="w-full px-2 py-1 bg-red-900/30 border border-red-600 rounded font-mono" readonly></div>
                                <div><label class="text-gray-500">Trailing Stop</label>
                                    <div class="flex gap-1">
                                        <input type="number" id="tj-trailing" value="${j.trailing_stop||''}" step="0.01" class="flex-1 px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono">
                                        <button onclick="updateTrailingStop(${j.id})" class="px-2 py-1 bg-yellow-600 rounded hover:bg-yellow-700 text-xs" title="Update trailing stop">‚Üë</button>
                                    </div>
                                </div>
                                <div><label class="text-gray-500">Potential Loss</label><input type="number" id="tj-potloss" value="${j.potential_loss||''}" class="w-full px-2 py-1 bg-red-900/20 border border-gray-600 rounded font-mono" readonly></div>
                                <div><label class="text-gray-500">New Target</label><input type="number" id="tj-newtarget" value="${j.new_target||''}" step="0.01" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                            </div>
                        </div>

                        <!-- Reward -->
                        <div class="border border-green-600/30 rounded p-3 space-y-2">
                            <h4 class="text-sm font-bold text-green-400 border-b border-gray-600 pb-1">Reward</h4>
                            <div class="grid grid-cols-1 gap-2 text-xs">
                                <div><label class="text-gray-500">Potential Gain</label><input type="number" id="tj-potgain" value="${j.potential_gain||''}" class="w-full px-2 py-1 bg-green-900/20 border border-gray-600 rounded font-mono" readonly></div>
                                <div><label class="text-gray-500">1:3 A-Target</label><input type="number" id="tj-targeta" value="${j.target_a||''}" step="0.01" class="w-full px-2 py-1 bg-green-900/30 border border-gray-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">1:2 B-Target</label><input type="number" id="tj-targetb" value="${j.target_b||''}" step="0.01" class="w-full px-2 py-1 bg-green-900/30 border border-gray-600 rounded font-mono"></div>
                                <div><label class="text-gray-500">1:1 C-Target</label><input type="number" id="tj-targetc" value="${j.target_c||''}" step="0.01" class="w-full px-2 py-1 bg-yellow-900/30 border border-gray-600 rounded font-mono"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entries Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-blue-400">Entries</h4>
                        <div class="flex gap-2 items-center text-xs">
                            <label class="text-gray-500">Entry Tactic</label>
                            <select id="tj-entry-tactic" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${entryTactics.map(t => `<option ${j.entry_tactic===t?'selected':''}>${t}</option>`).join('')}</select>
                            <label class="text-gray-500 ml-2">Reason</label>
                            <input id="tj-entry-reason" value="${j.entry_reason||''}" placeholder="Reason for entry" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded flex-1">
                            <button onclick="addEntryRow(${j.id})" class="px-3 py-1 bg-green-600 rounded hover:bg-green-700">+ Add Entry</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-[#1f2937]">
                                <tr>
                                    <th class="p-2 text-left text-gray-400">Entry Date</th>
                                    <th class="p-2 text-right text-gray-400">Quantity</th>
                                    <th class="p-2 text-right text-gray-400">Order Price</th>
                                    <th class="p-2 text-right text-gray-400">Filled Price</th>
                                    <th class="p-2 text-right text-gray-400">Slippage</th>
                                    <th class="p-2 text-right text-gray-400">Commission</th>
                                    <th class="p-2 text-right text-gray-400">Position Size</th>
                                    <th class="p-2 text-right text-gray-400">Day High</th>
                                    <th class="p-2 text-right text-gray-400">Day Low</th>
                                    <th class="p-2 text-center text-gray-400">Grade</th>
                                    <th class="p-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entries.length > 0 ? entries.map(e => `
                                    <tr class="border-t border-gray-700">
                                        <td class="p-2 font-mono">${e.entry_datetime?.split('T')[0] || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.quantity || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.order_price ? sym + e.order_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.filled_price ? sym + e.filled_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono ${(e.slippage||0) > 0 ? 'text-red-400' : ''}">${e.slippage ? sym + e.slippage.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.commission ? sym + e.commission.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.position_size ? sym + e.position_size.toLocaleString() : '-'}</td>
                                        <td class="p-2 text-right font-mono text-green-400">${e.day_high ? sym + e.day_high.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono text-red-400">${e.day_low ? sym + e.day_low.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-center"><span class="px-2 py-0.5 rounded ${e.grade==='A' ? 'bg-green-500/20 text-green-400' : e.grade==='B' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-400'}">${e.grade || '-'}</span></td>
                                        <td class="p-2 text-center"><button onclick="deleteEntry(${e.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button></td>
                                    </tr>
                                `).join('') : '<tr><td colspan="11" class="p-4 text-center text-gray-500">No entries yet. Add your first entry above.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Exits Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-orange-400">Exits</h4>
                        <div class="flex gap-2 items-center text-xs">
                            <label class="text-gray-500">Exit Tactic</label>
                            <select id="tj-exit-tactic" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${exitTactics.map(t => `<option ${j.exit_tactic===t?'selected':''}>${t}</option>`).join('')}</select>
                            <label class="text-gray-500 ml-2">Reason</label>
                            <input id="tj-exit-reason" value="${j.exit_reason||''}" placeholder="Reason for exit" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded flex-1">
                            <button onclick="addExitRow(${j.id})" class="px-3 py-1 bg-orange-600 rounded hover:bg-orange-700">+ Add Exit</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-[#1f2937]">
                                <tr>
                                    <th class="p-2 text-left text-gray-400">Exit Date</th>
                                    <th class="p-2 text-right text-gray-400">Quantity</th>
                                    <th class="p-2 text-right text-gray-400">Order Price</th>
                                    <th class="p-2 text-right text-gray-400">Filled Price</th>
                                    <th class="p-2 text-right text-gray-400">Slippage</th>
                                    <th class="p-2 text-right text-gray-400">Commission</th>
                                    <th class="p-2 text-right text-gray-400">Position Size</th>
                                    <th class="p-2 text-right text-gray-400">Day High</th>
                                    <th class="p-2 text-right text-gray-400">Day Low</th>
                                    <th class="p-2 text-center text-gray-400">Grade</th>
                                    <th class="p-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${exits.length > 0 ? exits.map(e => `
                                    <tr class="border-t border-gray-700">
                                        <td class="p-2 font-mono">${e.exit_datetime?.split('T')[0] || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.quantity || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.order_price ? sym + e.order_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.filled_price ? sym + e.filled_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono ${(e.slippage||0) > 0 ? 'text-red-400' : ''}">${e.slippage ? sym + e.slippage.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.commission ? sym + e.commission.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.position_size ? sym + e.position_size.toLocaleString() : '-'}</td>
                                        <td class="p-2 text-right font-mono text-green-400">${e.day_high ? sym + e.day_high.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono text-red-400">${e.day_low ? sym + e.day_low.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-center"><span class="px-2 py-0.5 rounded ${e.grade==='A' ? 'bg-green-500/20 text-green-400' : e.grade==='B' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-400'}">${e.grade || '-'}</span></td>
                                        <td class="p-2 text-center"><button onclick="deleteExit(${e.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button></td>
                                    </tr>
                                `).join('') : '<tr><td colspan="11" class="p-4 text-center text-gray-500">No exits yet. Add your first exit above.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <h4 class="font-bold text-purple-400 mb-3">Results</h4>
                    <div class="grid grid-cols-6 gap-4 text-xs">
                        <div><label class="text-gray-500">First Entry Date</label><input id="tj-firstentry" value="${j.first_entry_date||''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Total Shares</label><input id="tj-totalshares" value="${j.total_shares||''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Avg Entry</label><input id="tj-avgentry" value="${j.avg_entry ? sym + j.avg_entry.toFixed(2) : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Gain/Loss %</label><input id="tj-glpct" value="${j.gain_loss_percent ? j.gain_loss_percent.toFixed(2) + '%' : ''}" class="w-full px-2 py-1 ${(j.gain_loss_percent||0) >= 0 ? 'bg-green-900/20' : 'bg-red-900/20'} border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">High During Trade</label><input id="tj-hdt" value="${j.high_during_trade ? sym + j.high_during_trade.toFixed(2) : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Max Drawdown</label><input id="tj-maxdd" value="${j.max_drawdown ? sym + j.max_drawdown.toFixed(2) : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>

                        <div><label class="text-gray-500">Last Exit Date</label><input id="tj-lastexit" value="${j.last_exit_date||''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Trade Grade</label><select id="tj-grade" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${grades.map(g => `<option ${j.trade_grade===g?'selected':''}>${g}</option>`).join('')}</select></div>
                        <div><label class="text-gray-500">Avg Exit</label><input id="tj-avgexit" value="${j.avg_exit ? sym + j.avg_exit.toFixed(2) : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Gain/Loss ${sym}</label><input id="tj-glamount" value="${j.gain_loss_amount ? sym + j.gain_loss_amount.toFixed(2) : ''}" class="w-full px-2 py-1 ${(j.gain_loss_amount||0) >= 0 ? 'bg-green-900/20' : 'bg-red-900/20'} border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Low During Trade</label><input id="tj-ldt" value="${j.low_during_trade ? sym + j.low_during_trade.toFixed(2) : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">% Captured</label><input id="tj-captured" value="${j.percent_captured ? j.percent_captured.toFixed(1) + '%' : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">Open Trade Comments</label>
                            <textarea id="tj-comments" class="w-full h-20 mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded text-sm">${j.open_trade_comments||''}</textarea>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Followup Analysis</label>
                            <textarea id="tj-followup" class="w-full h-20 mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded text-sm">${j.followup_analysis||''}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button onclick="saveJournal()" class="flex-1 py-3 bg-green-600 rounded-lg font-medium hover:bg-green-700">üíæ Save Journal</button>
                    <button onclick="clearJournal()" class="flex-1 py-3 bg-gray-600 rounded-lg font-medium hover:bg-gray-700">üóëÔ∏è Clear</button>
                </div>
                ` : `
                <!-- Journal Records List -->
                <div class="bg-[#111827] rounded-xl border border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-[#1f2937]">
                                <tr>
                                    <th class="p-2 text-left text-gray-400">Date</th>
                                    <th class="p-2 text-left text-gray-400">Ticker</th>
                                    <th class="p-2 text-center text-gray-400">Dir</th>
                                    <th class="p-2 text-right text-gray-400">Entry</th>
                                    <th class="p-2 text-right text-gray-400">Qty</th>
                                    <th class="p-2 text-right text-gray-400">Target</th>
                                    <th class="p-2 text-right text-gray-400">SL</th>
                                    <th class="p-2 text-right text-gray-400">Gain/Loss</th>
                                    <th class="p-2 text-center text-gray-400">Status</th>
                                    <th class="p-2 text-center text-gray-400">Grade</th>
                                    <th class="p-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${journals.length > 0 ? journals.map(j => `
                                    <tr class="border-t border-gray-700 hover:bg-[#1f2937]/50 cursor-pointer" onclick="editJournal(${j.id})">
                                        <td class="p-2 font-mono">${j.journal_date || '-'}</td>
                                        <td class="p-2 font-mono font-bold">${j.ticker}</td>
                                        <td class="p-2 text-center"><span class="${j.direction === 'Long' ? 'text-green-400' : 'text-red-400'}">${j.direction === 'Long' ? '‚ñ≤' : '‚ñº'}</span></td>
                                        <td class="p-2 text-right font-mono">${j.entry_price ? sym + j.entry_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${j.quantity || '-'}</td>
                                        <td class="p-2 text-right font-mono text-green-400">${j.target_price ? sym + j.target_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono text-red-400">${j.stop_loss ? sym + j.stop_loss.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono ${(j.gain_loss_amount||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${j.gain_loss_amount ? sym + j.gain_loss_amount.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${j.status==='closed' ? 'bg-gray-500/20 text-gray-400' : 'bg-blue-500/20 text-blue-400'}">${j.status}</span></td>
                                        <td class="p-2 text-center"><span class="px-2 py-0.5 rounded ${j.trade_grade==='A' ? 'bg-green-500/20 text-green-400' : j.trade_grade==='B' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-400'}">${j.trade_grade || '-'}</span></td>
                                        <td class="p-2 text-center">
                                            <button onclick="event.stopPropagation(); editJournal(${j.id})" class="text-blue-400 hover:text-blue-300 mr-2">‚úèÔ∏è</button>
                                            <button onclick="event.stopPropagation(); deleteJournal(${j.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="11" class="p-8 text-center text-gray-500">No journal entries yet. Create one from Trade Bill or click + New Journal.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                `}
            </div>
        `;
    }

    function showJournalForm() {
        // Already showing form, do nothing
    }

    function showJournalRecords() {
        window.currentJournalId = null;
        currentJournal = null;
        render();
    }

    function newJournal() {
        window.currentJournalId = 'new';
        currentJournal = {id: null};
        render();
    }

    async function editJournal(id) {
        window.currentJournalId = id;
        await render();
    }

    async function deleteJournal(id) {
        if (!confirm('Delete this journal entry?')) return;

        try {
            await fetch(`/api/v2/trade-journal/${id}`, {method: 'DELETE'});
            toast('Journal deleted', 'success');
            window.currentJournalId = null;
            currentJournal = null;
            await render();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    function clearJournal() {
        window.currentJournalId = null;
        currentJournal = null;
        render();
    }

    async function updateTrailingStop(journalId) {
        const newTrailing = parseFloat(document.getElementById('tj-trailing').value);
        if (!newTrailing) { toast('Enter trailing stop value', 'error'); return; }
        try {
            const resp = await fetch(`/api/v2/trade-journal/${journalId}/trailing-stop`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ trailing_stop: newTrailing })
            });
            const data = await resp.json();
            if (data.success) {
                toast(`Trailing stop updated to ‚Çπ${newTrailing.toFixed(2)}`, 'success');
                await render();
            } else {
                toast(data.error || 'Failed to update', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function saveJournal() {
        const data = {
            ticker: document.getElementById('tj-ticker').value,
            journal_date: document.getElementById('tj-date').value,
            cmp: parseFloat(document.getElementById('tj-cmp').value) || null,
            direction: document.getElementById('tj-direction').value,
            order_type: document.getElementById('tj-ordertype').value,
            status: document.getElementById('tj-status').value,
            mental_state: document.getElementById('tj-mental').value,
            entry_price: parseFloat(document.getElementById('tj-entry').value) || null,
            quantity: parseInt(document.getElementById('tj-qty').value) || null,
            target_price: parseFloat(document.getElementById('tj-target').value) || null,
            stop_loss: parseFloat(document.getElementById('tj-sl').value) || null,
            trailing_stop: parseFloat(document.getElementById('tj-trailing').value) || null,
            new_target: parseFloat(document.getElementById('tj-newtarget').value) || null,
            target_a: parseFloat(document.getElementById('tj-targeta').value) || null,
            target_b: parseFloat(document.getElementById('tj-targetb').value) || null,
            target_c: parseFloat(document.getElementById('tj-targetc').value) || null,
            entry_tactic: document.getElementById('tj-entry-tactic').value,
            entry_reason: document.getElementById('tj-entry-reason').value,
            exit_tactic: document.getElementById('tj-exit-tactic').value,
            exit_reason: document.getElementById('tj-exit-reason').value,
            trade_grade: document.getElementById('tj-grade').value,
            open_trade_comments: document.getElementById('tj-comments').value,
            followup_analysis: document.getElementById('tj-followup').value
        };

        // Calculate derived fields
        if (data.entry_price && data.stop_loss && data.quantity) {
            data.potential_loss = Math.abs(data.entry_price - data.stop_loss) * data.quantity;
        }
        if (data.entry_price && data.target_price && data.quantity) {
            data.potential_gain = Math.abs(data.target_price - data.entry_price) * data.quantity;
        }
        if (data.potential_loss && data.potential_gain) {
            data.rr_ratio = data.potential_gain / data.potential_loss;
        }

        try {
            let result;
            if (currentJournal && currentJournal.id) {
                // Update
                result = await fetch(`/api/v2/trade-journal/${currentJournal.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                // Create
                result = await fetch('/api/v2/trade-journal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }

            const res = await result.json();
            if (res.success || res.id) {
                toast('Journal saved!', 'success');
                if (res.id) window.currentJournalId = res.id;
                await render();
            } else {
                toast(res.error || 'Failed to save', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function addEntryRow(journalId) {
        if (!journalId) {
            toast('Save journal first', 'error');
            return;
        }

        const entry = {
            entry_datetime: new Date().toISOString(),
            quantity: parseInt(document.getElementById('tj-qty').value) || 0,
            order_price: parseFloat(document.getElementById('tj-entry').value) || 0,
            filled_price: parseFloat(document.getElementById('tj-entry').value) || 0,
            slippage: 0,
            commission: 0,
            position_size: 0
        };

        entry.position_size = entry.filled_price * entry.quantity;

        try {
            const result = await fetch(`/api/v2/trade-journal/${journalId}/entry`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(entry)
            });
            const res = await result.json();
            if (res.success) {
                toast('Entry added!', 'success');
                await render();
            } else {
                toast(res.error || 'Failed to add entry', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function addExitRow(journalId) {
        if (!journalId) {
            toast('Save journal first', 'error');
            return;
        }

        const exit = {
            exit_datetime: new Date().toISOString(),
            quantity: parseInt(document.getElementById('tj-qty').value) || 0,
            order_price: parseFloat(document.getElementById('tj-target').value) || 0,
            filled_price: parseFloat(document.getElementById('tj-target').value) || 0,
            slippage: 0,
            commission: 0,
            position_size: 0
        };

        exit.position_size = exit.filled_price * exit.quantity;

        try {
            const result = await fetch(`/api/v2/trade-journal/${journalId}/exit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(exit)
            });
            const res = await result.json();
            if (res.success) {
                toast('Exit added!', 'success');
                await render();
            } else {
                toast(res.error || 'Failed to add exit', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function deleteEntry(entryId) {
        if (!confirm('Delete this entry?')) return;

        try {
            await fetch(`/api/v2/trade-journal/entry/${entryId}`, {method: 'DELETE'});
            toast('Entry deleted', 'success');
            await render();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function deleteExit(exitId) {
        if (!confirm('Delete this exit?')) return;

        try {
            await fetch(`/api/v2/trade-journal/exit/${exitId}`, {method: 'DELETE'});
            toast('Exit deleted', 'success');
            await render();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // ========== ACCOUNT INFO ==========
    async function accountView() {
        try {
            const account = await api('GET', '/account/info');
            const sym = '‚Çπ';  // Always INR for NSE

            return `
                <div class="space-y-6 max-w-4xl">
                    <h2 class="text-2xl font-bold">üí∞ Account Information</h2>

                    <!-- Account Summary Cards -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-500/10 to-blue-600/5 rounded-lg p-4 border border-blue-500/30">
                            <div class="text-sm text-gray-400">Account Size</div>
                            <div class="text-2xl font-bold text-blue-400 mt-2">${sym}${account.trading_capital?.toLocaleString()}</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500/10 to-red-600/5 rounded-lg p-4 border border-red-500/30">
                            <div class="text-sm text-gray-400">Risk per Trade</div>
                            <div class="text-2xl font-bold text-red-400 mt-2">${account.risk_per_trade?.toFixed(1)}%</div>
                            <div class="text-xs text-gray-500 mt-1">${sym}${((account.trading_capital * account.risk_per_trade)/100).toFixed(0)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 rounded-lg p-4 border border-yellow-500/30">
                            <div class="text-sm text-gray-400">Open Positions</div>
                            <div class="text-2xl font-bold text-yellow-400 mt-2">${account.no_of_open_positions}</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500/10 to-purple-600/5 rounded-lg p-4 border border-purple-500/30">
                            <div class="text-sm text-gray-400">Money Locked</div>
                            <div class="text-2xl font-bold text-purple-400 mt-2">${sym}${account.money_locked_in_positions?.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                        <h3 class="font-bold text-lg text-red-400">Risk Management</h3>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-400">Max Monthly Drawdown: ${account.max_monthly_drawdown}%</span>
                                    <span class="font-mono">${sym}${((account.trading_capital * account.max_monthly_drawdown)/100).toFixed(0)}</span>
                                </div>
                                <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-red-500" style="width:${Math.min(100, (account.money_locked_in_positions / (account.trading_capital * account.max_monthly_drawdown / 100)) * 100)}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${((account.money_locked_in_positions / (account.trading_capital * account.max_monthly_drawdown / 100)) * 100).toFixed(1)}% Used</div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-400">Money Remaining to Risk</span>
                                    <span class="font-mono text-green-400">${sym}${Math.max(0, account.money_remaining_to_risk).toLocaleString()}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-4">${account.risk_percent_remaining?.toFixed(1)}% of capital available</div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Details -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                        <h3 class="font-bold text-lg">Account Details</h3>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Account Name</div>
                                <div class="font-mono text-lg">${account.account_name}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Broker</div>
                                <div class="font-mono text-lg">${account.broker || 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Market</div>
                                <div class="font-mono text-lg">${account.market}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400 mb-1">Target R:R</div>
                                <div class="font-mono text-lg">${account.target_rr?.toFixed(1)} : 1</div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Summary -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                        <h3 class="font-bold text-lg">Position Summary</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-[#1f2937] rounded-lg p-4">
                                <div class="text-sm text-gray-400">Total Positions</div>
                                <div class="text-2xl font-bold text-blue-400 mt-2">${account.no_of_open_positions}</div>
                            </div>
                            <div class="bg-[#1f2937] rounded-lg p-4">
                                <div class="text-sm text-gray-400">Money Locked</div>
                                <div class="text-2xl font-bold text-purple-400 mt-2">${sym}${account.money_locked_in_positions?.toLocaleString()}</div>
                            </div>
                            <div class="bg-[#1f2937] rounded-lg p-4">
                                <div class="text-sm text-gray-400">Slots Remaining</div>
                                <div class="text-2xl font-bold text-green-400 mt-2">${account.max_open_positions - account.no_of_open_positions}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch(e) {
            return `<div class="text-red-400">Error loading Account Info: ${e.message}</div>`;
        }
    }

    // ========== JOURNAL DASHBOARD ==========
    async function journalDashboardView() {
        try {
            const resp = await fetch('/api/v2/trade-journal');
            const jData = await resp.json();
            const tradeList = jData.journals || [];
            const closedTrades = tradeList.filter(t => t.status === 'closed');
            const openTrades = tradeList.filter(t => t.status !== 'closed');
            const winners = closedTrades.filter(t => (t.gain_loss_amount || 0) > 0);
            const losers = closedTrades.filter(t => (t.gain_loss_amount || 0) < 0);
            const breakeven = closedTrades.filter(t => (t.gain_loss_amount || 0) === 0);

            const totalPnL = closedTrades.reduce((sum, t) => sum + (t.gain_loss_amount || 0), 0);
            const winRate = closedTrades.length > 0 ? (winners.length / closedTrades.length * 100) : 0;
            const avgWin = winners.length > 0 ? winners.reduce((sum, t) => sum + t.gain_loss_amount, 0) / winners.length : 0;
            const avgLoss = losers.length > 0 ? losers.reduce((sum, t) => sum + Math.abs(t.gain_loss_amount), 0) / losers.length : 0;
            const expectancy = closedTrades.length > 0 ? totalPnL / closedTrades.length : 0;
            const s = settings[0] || {trading_capital: 500000};
            const sym = '‚Çπ';
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">üìä Trade Journal Dashboard</h2>
                    
                    <!-- Win Rate Donut -->
                    <div class="grid grid-cols-3 gap-6">
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 text-center">
                            <div class="text-6xl font-bold ${winRate >= 50 ? 'text-green-400' : 'text-red-400'}">${winRate.toFixed(1)}%</div>
                            <div class="text-gray-400 mt-2">Win Rate</div>
                            <div class="flex justify-center gap-4 mt-4 text-sm">
                                <span class="text-green-400">${winners.length}W</span>
                                <span class="text-red-400">${losers.length}L</span>
                                <span class="text-gray-400">${breakeven.length}BE</span>
                            </div>
                        </div>
                        
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Journal Statistics</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Closed Trades</span><span class="font-mono">${closedTrades.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Open Trades</span><span class="font-mono">${openTrades.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Trade Expectancy</span><span class="font-mono ${expectancy >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${expectancy.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Overall P/L</span><span class="font-mono text-lg ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${totalPnL.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Account Growth</span><span class="font-mono ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}">${(totalPnL / s.trading_capital * 100).toFixed(2)}%</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Trade Analysis</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Avg Winning Trade</span><span class="font-mono text-green-400">${sym}${avgWin.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Avg Losing Trade</span><span class="font-mono text-red-400">-${sym}${avgLoss.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Profit Factor</span><span class="font-mono">${avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : 'N/A'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Best Trade</span><span class="font-mono text-green-400">${sym}${Math.max(...closedTrades.map(t => t.net_pnl || 0), 0).toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Worst Trade</span><span class="font-mono text-red-400">${sym}${Math.min(...closedTrades.map(t => t.net_pnl || 0), 0).toFixed(2)}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-4 gap-4">
                        <button onclick="switchTab('trade-log')" class="p-4 bg-blue-600/20 border border-blue-600/50 rounded-xl hover:bg-blue-600/30 text-center">
                            <div class="text-2xl">üìù</div>
                            <div class="mt-2">Add Trade</div>
                        </button>
                        <button onclick="switchTab('trade-summary')" class="p-4 bg-green-600/20 border border-green-600/50 rounded-xl hover:bg-green-600/30 text-center">
                            <div class="text-2xl">üìà</div>
                            <div class="mt-2">Summary</div>
                        </button>
                        <button onclick="switchTab('pnl-tracker')" class="p-4 bg-purple-600/20 border border-purple-600/50 rounded-xl hover:bg-purple-600/30 text-center">
                            <div class="text-2xl">üíµ</div>
                            <div class="mt-2">P&L Tracker</div>
                        </button>
                        <button onclick="switchTab('mistakes')" class="p-4 bg-red-600/20 border border-red-600/50 rounded-xl hover:bg-red-600/30 text-center">
                            <div class="text-2xl">‚ö†Ô∏è</div>
                            <div class="mt-2">Mistakes</div>
                        </button>
                    </div>
                    
                    <!-- Recent Trades -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                        <h3 class="font-bold text-lg mb-4">Recent Trades</h3>
                        ${tradeList.length > 0 ? `
                            <table class="w-full text-sm">
                                <thead class="text-gray-400 border-b border-gray-700">
                                    <tr>
                                        <th class="text-left py-2">Date</th>
                                        <th class="text-left py-2">Ticker</th>
                                        <th class="text-left py-2">Strategy</th>
                                        <th class="text-right py-2">Avg Entry</th>
                                        <th class="text-right py-2">Avg Exit</th>
                                        <th class="text-right py-2">P&L</th>
                                        <th class="text-center py-2">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tradeList.slice(0, 10).map(t => `
                                        <tr class="border-b border-gray-700/50 cursor-pointer hover:bg-[#1f2937]/50" onclick="switchTab('trade-log'); setTimeout(() => openTradeLogDetail(${t.id}), 100)">
                                            <td class="py-2 font-mono text-xs">${t.journal_date || '-'}</td>
                                            <td class="py-2 font-mono font-bold">${t.ticker}</td>
                                            <td class="py-2">${t.strategy || '-'}</td>
                                            <td class="py-2 text-right font-mono">${t.avg_entry ? sym + t.avg_entry.toFixed(2) : (t.entry_price ? sym + t.entry_price.toFixed(2) : '-')}</td>
                                            <td class="py-2 text-right font-mono">${t.avg_exit ? sym + t.avg_exit.toFixed(2) : '-'}</td>
                                            <td class="py-2 text-right font-mono ${(t.gain_loss_amount || 0) >= 0 ? 'text-green-400' : 'text-red-400'}">${t.status === 'closed' ? sym + (t.gain_loss_amount || 0).toFixed(2) : '-'}</td>
                                            <td class="py-2 text-center"><span class="px-2 py-1 rounded text-xs ${t.status === 'closed' ? ((t.gain_loss_amount||0) > 0 ? 'bg-green-500/20 text-green-400' : (t.gain_loss_amount||0) < 0 ? 'bg-red-500/20 text-red-400' : 'bg-gray-500/20') : 'bg-blue-500/20 text-blue-400'}">${t.status === 'closed' ? ((t.gain_loss_amount||0) > 0 ? 'WIN' : (t.gain_loss_amount||0) < 0 ? 'LOSS' : 'BE') : 'OPEN'}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p class="text-gray-500 text-center py-8">No trades recorded yet. Start by adding a trade!</p>'}
                    </div>
                </div>
            `;
        } catch(e) {
            return `<div class="text-center py-20"><p class="text-red-400">Error: ${e.message}</p></div>`;
        }
    }

    // ========== TRADE LOG (Pyramiding Model) ==========
    let currentTradeLog = null;
    let tradeLogMode = 'list'; // 'list' or 'detail'

    async function tradeLogView() {
        // Load strategies and mistakes dynamically from API
        let strategies = [];
        let mistakes = [];
        try {
            const [stratResp, mistResp] = await Promise.all([
                fetch('/api/v2/strategies/global').then(r => r.json()),
                fetch('/api/v2/mistakes').then(r => r.json())
            ]);
            strategies = stratResp.map(s => s.name);
            mistakes = mistResp.map(m => m.name);
        } catch(e) {
            strategies = ['EL - Elder System'];
            mistakes = ['Rule Deviation'];
        }
        window._tlStrategies = strategies;
        window._tlMistakes = mistakes;

        const sym = '‚Çπ';
        let journals = [];

        try {
            const resp = await fetch('/api/v2/trade-journal');
            const data = await resp.json();
            journals = data.journals || [];
        } catch(e) { console.log('No trade journals yet'); }

        // Load detail if editing
        if (tradeLogMode === 'detail' && window.tradeLogEditId) {
            try {
                const resp = await fetch(`/api/v2/trade-journal/${window.tradeLogEditId}`);
                currentTradeLog = await resp.json();
            } catch(e) {
                currentTradeLog = null;
                tradeLogMode = 'list';
            }
        } else if (tradeLogMode === 'detail' && !window.tradeLogEditId) {
            currentTradeLog = {id: null};
        }

        if (tradeLogMode === 'detail') {
            return renderTradeLogDetail(currentTradeLog || {}, strategies, mistakes, sym);
        }

        // ===== LIST VIEW =====
        const openTrades = journals.filter(j => j.status === 'open');
        const closedTrades = journals.filter(j => j.status === 'closed');

        // ‚îÄ‚îÄ Info Tile Calculations ‚îÄ‚îÄ
        const s = settings[0] || {trading_capital: 500000, risk_per_trade: 2, max_monthly_drawdown: 10};
        const capital = s.trading_capital || 500000;

        // Position Size: SUM(avg_entry √ó remaining_qty) for open trades
        const positionSize = openTrades.reduce((sum, t) => {
            const entry = t.avg_entry || t.entry_price || 0;
            const qty = t.remaining_qty || 0;
            return sum + (entry * qty);
        }, 0);

        // Money at Risk: SUM((entry - SL) √ó remaining_qty) for open trades (direction-aware)
        const moneyAtRisk = openTrades.reduce((sum, t) => {
            const entry = t.avg_entry || t.entry_price || 0;
            const sl = t.stop_loss || 0;
            const qty = t.remaining_qty || 0;
            if (sl <= 0 || entry <= 0 || qty <= 0) return sum;
            const risk = t.direction === 'Short' ? (sl - entry) * qty : (entry - sl) * qty;
            return sum + Math.max(0, risk);
        }, 0);

        // Total Risk%: moneyAtRisk / capital √ó 100
        const totalRiskPct = capital > 0 ? (moneyAtRisk / capital * 100) : 0;

        // Realized P&L from closed trades
        const realizedPnL = closedTrades.reduce((sum, t) => sum + (t.gain_loss_amount || 0), 0);

        // Partial realized P&L from open trades (exited portions)
        const partialRealizedPnL = openTrades.reduce((sum, t) => {
            if (t.exits && t.exits.length > 0 && t.gain_loss_amount) return sum + t.gain_loss_amount;
            return sum;
        }, 0);

        // Account Balance: capital + all realized P&L
        const accountBalance = capital + realizedPnL + partialRealizedPnL;

        // Risk Limit: capital √ó max_monthly_drawdown / 100
        const riskLimit = capital * (s.max_monthly_drawdown || 10) / 100;

        const html = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Trade Log</h2>
                    <div class="flex gap-2">
                        <button onclick="exportCSVData('trade-journal')" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">üì• Export CSV</button>
                        <button onclick="importCSVData('trade-journal')" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">üì§ Import CSV</button>
                        <button onclick="newTradeLog()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">+ New Trade</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-5 gap-3">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-blue-400">${journals.length}</div>
                        <div class="text-xs text-gray-400">Total Trades</div>
                    </div>
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-yellow-400">${openTrades.length}</div>
                        <div class="text-xs text-gray-400">Open</div>
                    </div>
                    <div class="bg-gray-500/10 border border-gray-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-gray-400">${closedTrades.length}</div>
                        <div class="text-xs text-gray-400">Closed</div>
                    </div>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-green-400">${closedTrades.filter(t => (t.gain_loss_amount||0) > 0).length}</div>
                        <div class="text-xs text-gray-400">Winners</div>
                    </div>
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-red-400">${closedTrades.filter(t => (t.gain_loss_amount||0) < 0).length}</div>
                        <div class="text-xs text-gray-400">Losers</div>
                    </div>
                </div>

                <!-- Portfolio Info Tiles -->
                <div class="grid grid-cols-7 gap-3">
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 text-center">
                        <div id="tile-overall-pnl" class="text-lg font-bold text-purple-400">Loading...</div>
                        <div class="text-xs text-gray-400">Overall P&L</div>
                    </div>
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-cyan-400">${sym}${positionSize.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="text-xs text-gray-400">Position Size</div>
                    </div>
                    <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold ${totalRiskPct > (s.risk_per_day || 2) ? 'text-red-400' : 'text-orange-400'}">${totalRiskPct.toFixed(2)}%</div>
                        <div class="text-xs text-gray-400">Total Risk%</div>
                    </div>
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-red-400">${sym}${moneyAtRisk.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="text-xs text-gray-400">Money at Risk</div>
                    </div>
                    <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-indigo-400">${sym}${capital.toLocaleString()}</div>
                        <div class="text-xs text-gray-400">Starting Balance</div>
                    </div>
                    <div class="bg-teal-500/10 border border-teal-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold ${accountBalance >= capital ? 'text-teal-400' : 'text-red-400'}">${sym}${accountBalance.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="text-xs text-gray-400">Account Balance</div>
                    </div>
                    <div class="bg-pink-500/10 border border-pink-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-pink-400">${sym}${riskLimit.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="text-xs text-gray-400">Risk Limit</div>
                    </div>
                </div>

                <!-- Trade Records Table -->
                <div class="bg-[#111827] rounded-xl border border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-[#1f2937]">
                                <tr>
                                    <th class="p-2 text-left text-gray-400">Date</th>
                                    <th class="p-2 text-left text-gray-400">Ticker</th>
                                    <th class="p-2 text-center text-gray-400">Dir</th>
                                    <th class="p-2 text-right text-gray-400">Entries</th>
                                    <th class="p-2 text-right text-gray-400">Exits</th>
                                    <th class="p-2 text-right text-gray-400">Total Qty</th>
                                    <th class="p-2 text-right text-gray-400">Remaining</th>
                                    <th class="p-2 text-right text-gray-400">Avg Entry</th>
                                    <th class="p-2 text-right text-gray-400">Avg Exit</th>
                                    <th class="p-2 text-right text-gray-400">SL</th>
                                    <th class="p-2 text-right text-gray-400">Target</th>
                                    <th class="p-2 text-right text-gray-400">Gain/Loss</th>
                                    <th class="p-2 text-right text-gray-400">G/L %</th>
                                    <th class="p-2 text-center text-gray-400">Status</th>
                                    <th class="p-2 text-center text-gray-400">Grade</th>
                                    <th class="p-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${journals.length > 0 ? journals.map(j => {
                                    const entryCnt = (j.entries || []).length || '-';
                                    const exitCnt = (j.exits || []).length || '-';
                                    return `
                                        <tr class="border-t border-gray-700/50 hover:bg-[#1f2937]/50 cursor-pointer" onclick="openTradeLogDetail(${j.id})">
                                            <td class="p-2 font-mono">${j.journal_date || j.first_entry_date?.split('T')[0] || '-'}</td>
                                            <td class="p-2 font-mono font-bold text-blue-400">${j.ticker}</td>
                                            <td class="p-2 text-center"><span class="${j.direction === 'Long' ? 'text-green-400' : 'text-red-400'}">${j.direction === 'Long' ? '‚ñ≤ Long' : '‚ñº Short'}</span></td>
                                            <td class="p-2 text-right font-mono">${entryCnt}</td>
                                            <td class="p-2 text-right font-mono">${exitCnt}</td>
                                            <td class="p-2 text-right font-mono">${j.total_shares != null ? j.total_shares : (j.quantity != null ? j.quantity : '-')}</td>
                                            <td class="p-2 text-right font-mono ${(j.remaining_qty||0) > 0 ? 'text-yellow-400' : ''}">${j.remaining_qty != null ? j.remaining_qty : '-'}</td>
                                            <td class="p-2 text-right font-mono">${j.avg_entry != null && j.avg_entry > 0 ? sym + j.avg_entry.toFixed(2) : (j.entry_price ? sym + j.entry_price.toFixed(2) : '-')}</td>
                                            <td class="p-2 text-right font-mono">${j.avg_exit != null && j.avg_exit > 0 ? sym + j.avg_exit.toFixed(2) : '-'}</td>
                                            <td class="p-2 text-right font-mono text-red-400">${j.stop_loss ? sym + j.stop_loss.toFixed(2) : '-'}</td>
                                            <td class="p-2 text-right font-mono text-green-400">${j.target_price ? sym + j.target_price.toFixed(2) : '-'}</td>
                                            <td class="p-2 text-right font-mono ${(j.gain_loss_amount||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${j.gain_loss_amount != null ? sym + j.gain_loss_amount.toFixed(2) : '-'}</td>
                                            <td class="p-2 text-right font-mono ${(j.gain_loss_percent||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${j.gain_loss_percent != null ? j.gain_loss_percent.toFixed(2) + '%' : '-'}</td>
                                            <td class="p-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${j.status==='closed' ? ((j.gain_loss_amount||0)>0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400') : 'bg-blue-500/20 text-blue-400'}">${j.status === 'closed' ? 'CLOSED' : 'OPEN'}</span></td>
                                            <td class="p-2 text-center"><span class="px-2 py-0.5 rounded ${j.trade_grade==='A'?'bg-green-500/20 text-green-400':j.trade_grade==='B'?'bg-blue-500/20 text-blue-400':'bg-gray-500/20 text-gray-400'}">${j.trade_grade||'-'}</span></td>
                                            <td class="p-2 text-center">
                                                <button onclick="event.stopPropagation(); openTradeLogDetail(${j.id})" class="text-blue-400 hover:text-blue-300 mr-2" title="Edit">‚úèÔ∏è</button>
                                                <button onclick="event.stopPropagation(); deleteTradeLog(${j.id})" class="text-red-400 hover:text-red-300" title="Delete">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="16" class="p-8 text-center text-gray-500">No trades recorded. Click "+ New Trade" to start your first pyramiding trade!</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        // Trigger async P&L tile update after DOM renders
        setTimeout(() => updateNotionalPnlTile(openTrades, closedTrades, sym), 100);

        return html;
    }

    async function updateNotionalPnlTile(openTrades, closedTrades, sym) {
        const tile = document.getElementById('tile-overall-pnl');
        if (!tile) return;

        // Realized P&L from all closed trades
        const realizedPnL = closedTrades.reduce((sum, t) => sum + (t.gain_loss_amount || 0), 0);

        // Partial realized P&L from open trades with exits
        const partialPnL = openTrades.reduce((sum, t) => {
            if (t.exits && t.exits.length > 0 && t.gain_loss_amount) return sum + t.gain_loss_amount;
            return sum;
        }, 0);

        // If no open trades with remaining qty, skip batch CMP
        const tradesWithPositions = openTrades.filter(t => (t.remaining_qty || 0) > 0);
        if (tradesWithPositions.length === 0) {
            const totalPnL = realizedPnL + partialPnL;
            tile.textContent = sym + totalPnL.toLocaleString(undefined, {maximumFractionDigits: 0});
            tile.className = `text-lg font-bold ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;
            return;
        }

        // Fetch batch CMP for open positions
        const tickers = [...new Set(tradesWithPositions.map(t => t.ticker))];
        let prices = {};
        try {
            const resp = await fetch(`/api/v2/live-cmp/batch?symbols=${tickers.join(',')}`);
            const data = await resp.json();
            prices = data.prices || {};
        } catch (e) {
            console.log('Could not fetch batch CMP:', e);
            tile.textContent = sym + (realizedPnL + partialPnL).toLocaleString(undefined, {maximumFractionDigits: 0});
            tile.className = `text-lg font-bold ${(realizedPnL + partialPnL) >= 0 ? 'text-green-400' : 'text-red-400'}`;
            return;
        }

        // Compute unrealized P&L using live CMP
        let unrealizedPnL = 0;
        tradesWithPositions.forEach(t => {
            const entry = t.avg_entry || t.entry_price || 0;
            const qty = t.remaining_qty || 0;
            const priceData = prices[t.ticker];
            const cmp = priceData ? priceData.cmp : 0;
            if (cmp > 0 && entry > 0 && qty > 0) {
                if (t.direction === 'Short') {
                    unrealizedPnL += (entry - cmp) * qty;
                } else {
                    unrealizedPnL += (cmp - entry) * qty;
                }
            }
        });

        const totalPnL = realizedPnL + partialPnL + unrealizedPnL;
        tile.textContent = sym + totalPnL.toLocaleString(undefined, {maximumFractionDigits: 0});
        tile.className = `text-lg font-bold ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    function renderTradeLogDetail(j, strategies, mistakes, sym) {
        const entries = j.entries || [];
        const exits = j.exits || [];
        const entryTactics = ['Limit Order', 'Market Order', 'Stop Order', 'Scale In', 'Breakout'];
        const exitTactics = ['Target Hit', 'Stop Loss Hit', 'Trailing Stop', 'Time Exit', 'Scale Out', 'Manual'];
        const directions = ['Long', 'Short'];
        const grades = ['A', 'B', 'C'];

        return `
            <div class="space-y-4">
                <!-- Header -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button onclick="backToTradeLogList()" class="px-3 py-1.5 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">&larr; Back to List</button>
                        <h2 class="text-xl font-bold">${j.id ? 'Edit Trade: ' + (j.ticker || '') : 'New Trade'}</h2>
                        ${j.id ? `<span class="px-2 py-1 rounded text-xs ${j.status==='closed'?'bg-gray-500/20 text-gray-400':'bg-blue-500/20 text-blue-400'}">${j.status||'open'}</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${j.id && j.status !== 'closed' && (j.remaining_qty || 0) > 0 ? `
                            <button onclick="placeTradeLogSellGtt('${j.ticker}', ${j.remaining_qty || 0}, ${j.target_price || 0}, ${j.stop_loss || 0})" class="px-3 py-2 bg-orange-600 rounded-lg hover:bg-orange-700 text-sm" title="Sell remaining ${j.remaining_qty} shares via GTT">üì§ Sell GTT (${j.remaining_qty})</button>
                            <button onclick="placeNrmlOrder('BUY', '${j.ticker}')" class="px-3 py-2 bg-cyan-600 rounded-lg hover:bg-cyan-700 text-sm" title="Place NRML Buy order">üî∑ NRML Buy</button>
                            <button onclick="placeNrmlOrder('SELL', '${j.ticker}', ${j.remaining_qty || 0})" class="px-3 py-2 bg-pink-600 rounded-lg hover:bg-pink-700 text-sm" title="Place NRML Sell order">üîª NRML Sell</button>
                        ` : ''}
                        <button onclick="saveTradeLogDetail()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">Save Trade</button>
                    </div>
                </div>

                <!-- Trade Setup -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <h4 class="text-sm font-bold text-gray-400 border-b border-gray-600 pb-2 mb-3">Trade Setup</h4>
                    <div class="grid grid-cols-8 gap-3 text-sm">
                        <div><label class="text-gray-500">Ticker</label><input id="tl-ticker" value="${j.ticker||''}" placeholder="RELIANCE" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono"></div>
                        <div><label class="text-gray-500">Date</label><input type="date" id="tl-date" value="${(j.journal_date ? String(j.journal_date).split('T')[0] : '') || new Date().toISOString().split('T')[0]}" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded"></div>
                        <div><label class="text-gray-500">Direction</label><select id="tl-direction" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded">${directions.map(d => `<option ${j.direction===d?'selected':''}>${d}</option>`).join('')}</select></div>
                        <div><label class="text-gray-500">Strategy</label><select id="tl-strategy" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded">${strategies.map(s => `<option ${j.strategy===s?'selected':''}>${s}</option>`).join('')}</select></div>
                        <div><label class="text-gray-500">Stop Loss</label><input type="number" id="tl-sl" value="${j.stop_loss||''}" step="0.01" class="w-full px-2 py-1.5 bg-red-900/30 border border-red-600 rounded font-mono"></div>
                        <div><label class="text-gray-500">Target</label><input type="number" id="tl-target" value="${j.target_price||''}" step="0.01" class="w-full px-2 py-1.5 bg-green-900/30 border border-green-600 rounded font-mono"></div>
                        <div><label class="text-gray-500">Initial SL <span class="text-gray-600">(static)</span></label><input type="number" id="tl-initialsl" value="${j.initial_stop_loss||j.stop_loss||''}" class="w-full px-2 py-1.5 bg-red-900/20 border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Mistake</label><select id="tl-mistake" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded"><option value="">None</option>${mistakes.map(m => `<option ${j.mistake===m?'selected':''}>${m}</option>`).join('')}</select></div>
                    </div>
                </div>

                <!-- Entries Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-blue-500/30">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-blue-400">Entries</h4>
                        <div class="flex gap-2 items-center text-sm">
                            <label class="text-gray-500">Entry Tactic</label>
                            <select id="tl-entry-tactic" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${entryTactics.map(t => `<option ${j.entry_tactic===t?'selected':''}>${t}</option>`).join('')}</select>
                            <label class="text-gray-500 ml-2">Reason</label>
                            <input id="tl-entry-reason" value="${j.entry_reason||''}" placeholder="Reason for entry" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded w-48">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-[#1f2937]">
                                <tr>
                                    <th class="p-2 text-left text-gray-400">Entry Date</th>
                                    <th class="p-2 text-right text-gray-400">Quantity</th>
                                    <th class="p-2 text-right text-gray-400">Order Price</th>
                                    <th class="p-2 text-right text-gray-400">Filled Price</th>
                                    <th class="p-2 text-right text-gray-400">Slippage</th>
                                    <th class="p-2 text-right text-gray-400">Commission</th>
                                    <th class="p-2 text-right text-gray-400">Position Size</th>
                                    <th class="p-2 text-right text-gray-400">Day High</th>
                                    <th class="p-2 text-right text-gray-400">Day Low</th>
                                    <th class="p-2 text-center text-gray-400">Grade</th>
                                    <th class="p-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entries.length > 0 ? entries.map(e => `
                                    <tr class="border-t border-gray-700">
                                        <td class="p-2 font-mono">${e.entry_datetime?.split('T')[0] || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.quantity || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.order_price ? sym + e.order_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.filled_price ? sym + e.filled_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono ${(e.slippage||0) > 0 ? 'text-red-400' : ''}">${e.slippage ? sym + e.slippage.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.commission ? sym + e.commission.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.position_size ? sym + e.position_size.toLocaleString() : '-'}</td>
                                        <td class="p-2 text-right font-mono text-green-400">${e.day_high ? sym + e.day_high.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono text-red-400">${e.day_low ? sym + e.day_low.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-center"><span class="px-2 py-0.5 rounded ${e.grade==='A'?'bg-green-500/20 text-green-400':e.grade==='B'?'bg-blue-500/20 text-blue-400':'bg-gray-500/20 text-gray-400'}">${e.grade||'-'}</span></td>
                                        <td class="p-2 text-center"><button onclick="deleteTradeLogEntry(${e.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button></td>
                                    </tr>
                                `).join('') : ''}
                                <!-- Inline Add Entry Row -->
                                <tr class="border-t border-blue-500/30 bg-blue-500/5">
                                    <td class="p-1"><input type="datetime-local" id="tl-new-entry-date" value="${new Date().toISOString().slice(0,16)}" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono" onchange="autoFillDayRange('entry')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-qty" placeholder="Qty" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right"></td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-ordprice" step="0.01" placeholder="Order" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('entry')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-fillprice" step="0.01" placeholder="Filled" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('entry')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-slip" step="0.01" value="0" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right"></td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-comm" step="0.01" value="0" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right"></td>
                                    <td class="p-1 text-right text-xs font-mono text-gray-500">auto</td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-high" step="0.01" placeholder="High" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('entry')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-entry-low" step="0.01" placeholder="Low" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('entry')"></td>
                                    <td class="p-1"><select id="tl-new-entry-grade" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs">${grades.map(g => `<option>${g}</option>`).join('')}</select></td>
                                    <td class="p-1 text-center"><button onclick="addTradeLogEntry()" class="px-2 py-1 bg-green-600 rounded hover:bg-green-700 text-xs font-bold">+ Add</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Exits Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-orange-500/30">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-orange-400">Exits</h4>
                        <div class="flex gap-2 items-center text-sm">
                            <label class="text-gray-500">Exit Tactic</label>
                            <select id="tl-exit-tactic" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded">${exitTactics.map(t => `<option ${j.exit_tactic===t?'selected':''}>${t}</option>`).join('')}</select>
                            <label class="text-gray-500 ml-2">Reason</label>
                            <input id="tl-exit-reason" value="${j.exit_reason||''}" placeholder="Reason for exit" class="px-2 py-1 bg-[#1f2937] border border-gray-600 rounded w-48">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-[#1f2937]">
                                <tr>
                                    <th class="p-2 text-left text-gray-400">Exit Date</th>
                                    <th class="p-2 text-right text-gray-400">Quantity</th>
                                    <th class="p-2 text-right text-gray-400">Order Price</th>
                                    <th class="p-2 text-right text-gray-400">Filled Price</th>
                                    <th class="p-2 text-right text-gray-400">Slippage</th>
                                    <th class="p-2 text-right text-gray-400">Commission</th>
                                    <th class="p-2 text-right text-gray-400">Position Size</th>
                                    <th class="p-2 text-right text-gray-400">Day High</th>
                                    <th class="p-2 text-right text-gray-400">Day Low</th>
                                    <th class="p-2 text-center text-gray-400">Grade</th>
                                    <th class="p-2 text-center text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${exits.length > 0 ? exits.map(e => `
                                    <tr class="border-t border-gray-700">
                                        <td class="p-2 font-mono">${e.exit_datetime?.split('T')[0] || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.quantity || '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.order_price ? sym + e.order_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.filled_price ? sym + e.filled_price.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono ${(e.slippage||0) > 0 ? 'text-red-400' : ''}">${e.slippage ? sym + e.slippage.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.commission ? sym + e.commission.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono">${e.position_size ? sym + e.position_size.toLocaleString() : '-'}</td>
                                        <td class="p-2 text-right font-mono text-green-400">${e.day_high ? sym + e.day_high.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-right font-mono text-red-400">${e.day_low ? sym + e.day_low.toFixed(2) : '-'}</td>
                                        <td class="p-2 text-center"><span class="px-2 py-0.5 rounded ${e.grade==='A'?'bg-green-500/20 text-green-400':e.grade==='B'?'bg-blue-500/20 text-blue-400':'bg-gray-500/20 text-gray-400'}">${e.grade||'-'}</span></td>
                                        <td class="p-2 text-center"><button onclick="deleteTradeLogExit(${e.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button></td>
                                    </tr>
                                `).join('') : ''}
                                <!-- Inline Add Exit Row -->
                                <tr class="border-t border-orange-500/30 bg-orange-500/5">
                                    <td class="p-1"><input type="datetime-local" id="tl-new-exit-date" value="${new Date().toISOString().slice(0,16)}" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono" onchange="autoFillDayRange('exit')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-qty" placeholder="Qty" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right"></td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-ordprice" step="0.01" placeholder="Order" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('exit')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-fillprice" step="0.01" placeholder="Filled" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('exit')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-slip" step="0.01" value="0" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right"></td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-comm" step="0.01" value="0" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right"></td>
                                    <td class="p-1 text-right text-xs font-mono text-gray-500">auto</td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-high" step="0.01" placeholder="High" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('exit')"></td>
                                    <td class="p-1"><input type="number" id="tl-new-exit-low" step="0.01" placeholder="Low" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs font-mono text-right" onchange="autoCalcGradeLocal('exit')"></td>
                                    <td class="p-1"><select id="tl-new-exit-grade" class="w-full px-1 py-1 bg-[#1f2937] border border-gray-600 rounded text-xs">${grades.map(g => `<option>${g}</option>`).join('')}</select></td>
                                    <td class="p-1 text-center"><button onclick="addTradeLogExit()" class="px-2 py-1 bg-orange-600 rounded hover:bg-orange-700 text-xs font-bold">+ Add</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-purple-500/30">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-purple-400">Results</h4>
                        ${j.id ? `<button onclick="recalculateTradeLog(${j.id})" class="px-3 py-1 bg-purple-600 rounded hover:bg-purple-700 text-xs">üîÑ Recalculate</button>` : ''}
                    </div>

                    <!-- Trade Overview -->
                    <div class="grid grid-cols-6 gap-3 text-sm mb-3">
                        <div><label class="text-gray-500">First Entry Date</label><input value="${j.first_entry_date?.split('T')[0]||''}" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Total Shares</label><input value="${j.total_shares != null ? j.total_shares : ''}" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Avg Entry</label><input value="${j.avg_entry != null && j.avg_entry > 0 ? sym + j.avg_entry.toFixed(2) : ''}" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">High During Trade</label><input value="${j.high_during_trade != null ? sym + j.high_during_trade.toFixed(2) : ''}" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Low During Trade</label><input value="${j.low_during_trade != null ? sym + j.low_during_trade.toFixed(2) : ''}" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono" readonly></div>
                        <div><label class="text-gray-500">Trade Grade</label><select id="tl-grade" class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded">${grades.map(g => `<option ${j.trade_grade===g?'selected':''}>${g}</option>`).join('')}</select></div>
                    </div>

                    <!-- Booked P&L (from exited shares) + Open Position side by side -->
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <!-- Booked P&L -->
                        <div class="bg-[#0d1117] rounded-lg p-3 border ${(j.gain_loss_amount||0)>=0?'border-green-500/30':'border-red-500/30'}">
                            <h5 class="text-xs font-bold ${(j.gain_loss_amount||0)>=0?'text-green-400':'text-red-400'} mb-2">Booked P&L (Exited: ${j.exited_qty || ((j.total_shares||0) - (j.remaining_qty||0))} shares)</h5>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div><label class="text-gray-500 text-xs">Avg Exit</label><input value="${j.avg_exit != null && j.avg_exit > 0 ? sym + j.avg_exit.toFixed(2) : '-'}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs" readonly></div>
                                <div><label class="text-gray-500 text-xs">Realized P&L</label><input value="${j.gain_loss_amount != null ? sym + j.gain_loss_amount.toFixed(2) : '-'}" class="w-full px-2 py-1 ${(j.gain_loss_amount||0)>=0?'bg-green-900/20':'bg-red-900/20'} border border-gray-600 rounded font-mono text-xs" readonly></div>
                                <div><label class="text-gray-500 text-xs">Realized %</label><input value="${j.gain_loss_percent != null ? j.gain_loss_percent.toFixed(2)+'%' : '-'}" class="w-full px-2 py-1 ${(j.gain_loss_percent||0)>=0?'bg-green-900/20':'bg-red-900/20'} border border-gray-600 rounded font-mono text-xs" readonly></div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm mt-2">
                                <div><label class="text-gray-500 text-xs">Last Exit Date</label><input value="${j.last_exit_date?.split('T')[0]||'-'}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs" readonly></div>
                                <div><label class="text-gray-500 text-xs">Max Drawdown</label><input id="tl-maxdd" value="${j.max_drawdown ? sym + j.max_drawdown.toFixed(2) : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs"></div>
                                <div><label class="text-gray-500 text-xs">% Captured</label><input id="tl-captured" value="${j.percent_captured ? j.percent_captured.toFixed(1)+'%' : ''}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs"></div>
                            </div>
                        </div>

                        <!-- Open Position (Remaining) -->
                        <div class="bg-[#0d1117] rounded-lg p-3 border border-yellow-500/30">
                            <h5 class="text-xs font-bold text-yellow-400 mb-2">Open Position (Remaining: ${j.remaining_qty || 0} shares)</h5>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div><label class="text-gray-500 text-xs">Remaining Qty</label><input value="${j.remaining_qty || 0}" class="w-full px-2 py-1 bg-[#1f2937] border border-yellow-600/50 rounded font-mono text-xs ${(j.remaining_qty||0) > 0 ? 'text-yellow-400' : ''}" readonly></div>
                                <div><label class="text-gray-500 text-xs">CMP</label><input id="tl-cmp-display" value="..." class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs" readonly></div>
                                <div><label class="text-gray-500 text-xs">Notional P&L</label><input id="tl-notional-pnl" value="..." class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs" readonly></div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm mt-2">
                                <div><label class="text-gray-500 text-xs">Avg Entry</label><input value="${j.avg_entry != null && j.avg_entry > 0 ? sym + j.avg_entry.toFixed(2) : '-'}" class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs" readonly></div>
                                <div><label class="text-gray-500 text-xs">Notional %</label><input id="tl-notional-pct" value="..." class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs" readonly></div>
                                <div><label class="text-gray-500 text-xs">Total P&L</label><input id="tl-total-pnl" value="..." class="w-full px-2 py-1 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs font-bold" readonly></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TradingView Charts -->
                <div class="bg-[#111827] rounded-xl p-4 border border-indigo-500/30">
                    <h4 class="font-bold text-indigo-400 mb-3">TradingView Charts</h4>
                    <div class="grid grid-cols-3 gap-3 text-sm">
                        <div>
                            <label class="text-gray-500">Entry Chart Link</label>
                            <div class="flex gap-1">
                                <input id="tl-tv-entry" value="${j.tv_link_entry||''}" placeholder="https://www.tradingview.com/chart/..." class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs">
                                ${j.tv_link_entry ? `<a href="${j.tv_link_entry}" target="_blank" rel="noopener" class="px-2 py-1.5 bg-indigo-600/30 border border-indigo-500 rounded hover:bg-indigo-600/50 text-xs whitespace-nowrap">üîó Open</a>` : ''}
                            </div>
                        </div>
                        <div>
                            <label class="text-gray-500">Exit Chart Link</label>
                            <div class="flex gap-1">
                                <input id="tl-tv-exit" value="${j.tv_link_exit||''}" placeholder="https://www.tradingview.com/chart/..." class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs">
                                ${j.tv_link_exit ? `<a href="${j.tv_link_exit}" target="_blank" rel="noopener" class="px-2 py-1.5 bg-indigo-600/30 border border-indigo-500 rounded hover:bg-indigo-600/50 text-xs whitespace-nowrap">üîó Open</a>` : ''}
                            </div>
                        </div>
                        <div>
                            <label class="text-gray-500">Result Chart Link</label>
                            <div class="flex gap-1">
                                <input id="tl-tv-result" value="${j.tv_link_result||''}" placeholder="https://www.tradingview.com/chart/..." class="w-full px-2 py-1.5 bg-[#1f2937] border border-gray-600 rounded font-mono text-xs">
                                ${j.tv_link_result ? `<a href="${j.tv_link_result}" target="_blank" rel="noopener" class="px-2 py-1.5 bg-indigo-600/30 border border-indigo-500 rounded hover:bg-indigo-600/50 text-xs whitespace-nowrap">üîó Open</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">Open Trade Comments</label>
                            <textarea id="tl-comments" class="w-full h-20 mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded text-sm">${j.open_trade_comments||''}</textarea>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Followup Analysis</label>
                            <textarea id="tl-followup" class="w-full h-20 mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded text-sm">${j.followup_analysis||''}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button onclick="saveTradeLogDetail()" class="flex-1 py-3 bg-green-600 rounded-lg font-medium hover:bg-green-700">Save Trade</button>
                    <button onclick="backToTradeLogList()" class="flex-1 py-3 bg-gray-600 rounded-lg font-medium hover:bg-gray-700">Back to List</button>
                </div>
            </div>
        `;
    }

    async function fetchNotionalPnL() {
        // Fetch CMP and compute notional P&L for remaining position in TradeLog detail
        if (!currentTradeLog || !currentTradeLog.ticker || !currentTradeLog.remaining_qty) return;
        const remaining = currentTradeLog.remaining_qty || 0;
        const avgEntry = currentTradeLog.avg_entry || 0;
        const direction = currentTradeLog.direction || 'Long';
        const realizedPnL = currentTradeLog.gain_loss_amount || 0;
        const sym = '‚Çπ';

        if (remaining <= 0 || avgEntry <= 0) {
            // Trade fully closed ‚Äî show zeroes
            const cmpEl = document.getElementById('tl-cmp-display');
            const notionalEl = document.getElementById('tl-notional-pnl');
            const notionalPctEl = document.getElementById('tl-notional-pct');
            const totalEl = document.getElementById('tl-total-pnl');
            if (cmpEl) cmpEl.value = '-';
            if (notionalEl) notionalEl.value = '-';
            if (notionalPctEl) notionalPctEl.value = '-';
            if (totalEl) { totalEl.value = realizedPnL ? sym + realizedPnL.toFixed(2) : '-'; totalEl.className = totalEl.className.replace(/text-\w+-400/g, '') + (realizedPnL >= 0 ? ' text-green-400' : ' text-red-400'); }
            return;
        }

        try {
            const resp = await fetch(`/api/v2/live-cmp/${encodeURIComponent(currentTradeLog.ticker)}`);
            const data = await resp.json();
            const cmp = data.price || data.cmp || 0;

            const cmpEl = document.getElementById('tl-cmp-display');
            const notionalEl = document.getElementById('tl-notional-pnl');
            const notionalPctEl = document.getElementById('tl-notional-pct');
            const totalEl = document.getElementById('tl-total-pnl');

            if (!cmpEl) return; // Not in detail view

            cmpEl.value = cmp ? sym + cmp.toFixed(2) : '-';

            if (cmp && avgEntry) {
                const notionalPnL = direction === 'Short'
                    ? (avgEntry - cmp) * remaining
                    : (cmp - avgEntry) * remaining;
                const notionalPct = (notionalPnL / (avgEntry * remaining)) * 100;
                const totalPnL = realizedPnL + notionalPnL;

                notionalEl.value = sym + notionalPnL.toFixed(2);
                notionalEl.className = notionalEl.className.replace(/bg-\w+-900\/20/g, '') + (notionalPnL >= 0 ? ' bg-green-900/20' : ' bg-red-900/20');

                notionalPctEl.value = notionalPct.toFixed(2) + '%';
                notionalPctEl.className = notionalPctEl.className.replace(/bg-\w+-900\/20/g, '') + (notionalPct >= 0 ? ' bg-green-900/20' : ' bg-red-900/20');

                totalEl.value = sym + totalPnL.toFixed(2);
                totalEl.className = totalEl.className.replace(/bg-\w+-900\/20/g, '') + (totalPnL >= 0 ? ' bg-green-900/20 text-green-400' : ' bg-red-900/20 text-red-400');
            }
        } catch(e) {
            // CMP not available ‚Äî show placeholder
            const cmpEl = document.getElementById('tl-cmp-display');
            if (cmpEl) cmpEl.value = 'N/A';
        }
    }

    function newTradeLog() {
        window.tradeLogEditId = null;
        currentTradeLog = {id: null};
        tradeLogMode = 'detail';
        render();
    }

    function openTradeLogDetail(id) {
        window.tradeLogEditId = id;
        tradeLogMode = 'detail';
        render();
    }

    function backToTradeLogList() {
        window.tradeLogEditId = null;
        currentTradeLog = null;
        tradeLogMode = 'list';
        render();
    }

    async function saveTradeLogDetail() {
        const slVal = parseFloat(document.getElementById('tl-sl').value) || null;
        const data = {
            ticker: document.getElementById('tl-ticker').value,
            journal_date: document.getElementById('tl-date').value,
            direction: document.getElementById('tl-direction').value,
            strategy: document.getElementById('tl-strategy').value,
            stop_loss: slVal,
            initial_stop_loss: slVal,  // Set initial SL on creation (backend uses it only for new trades)
            target_price: parseFloat(document.getElementById('tl-target').value) || null,
            entry_tactic: document.getElementById('tl-entry-tactic').value,
            entry_reason: document.getElementById('tl-entry-reason').value,
            exit_tactic: document.getElementById('tl-exit-tactic').value,
            exit_reason: document.getElementById('tl-exit-reason').value,
            trade_grade: document.getElementById('tl-grade').value,
            open_trade_comments: document.getElementById('tl-comments').value,
            followup_analysis: document.getElementById('tl-followup').value,
            mistake: document.getElementById('tl-mistake').value || null,
            tv_link_entry: document.getElementById('tl-tv-entry')?.value || null,
            tv_link_exit: document.getElementById('tl-tv-exit')?.value || null,
            tv_link_result: document.getElementById('tl-tv-result')?.value || null
        };

        if (!data.ticker) { toast('Ticker is required', 'error'); return; }

        try {
            let result;
            if (currentTradeLog && currentTradeLog.id) {
                result = await fetch(`/api/v2/trade-journal/${currentTradeLog.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                result = await fetch('/api/v2/trade-journal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }

            const res = await result.json();
            if (res.success || res.id) {
                toast('Trade saved!', 'success');
                if (res.id) window.tradeLogEditId = res.id;
                await render();
            } else {
                toast(res.error || 'Failed to save', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function addTradeLogEntry() {
        if (!currentTradeLog || !currentTradeLog.id) {
            toast('Save the trade first before adding entries', 'error');
            return;
        }

        const qty = parseInt(document.getElementById('tl-new-entry-qty').value);
        const orderPrice = parseFloat(document.getElementById('tl-new-entry-ordprice').value);
        const filledPrice = parseFloat(document.getElementById('tl-new-entry-fillprice').value) || orderPrice;

        if (!qty || !orderPrice) { toast('Quantity and Order Price are required', 'error'); return; }

        const entry = {
            entry_datetime: document.getElementById('tl-new-entry-date').value,
            quantity: qty,
            order_price: orderPrice,
            filled_price: filledPrice,
            slippage: parseFloat(document.getElementById('tl-new-entry-slip').value) || 0,
            commission: parseFloat(document.getElementById('tl-new-entry-comm').value) || 0,
            position_size: filledPrice * qty,
            day_high: parseFloat(document.getElementById('tl-new-entry-high').value) || null,
            day_low: parseFloat(document.getElementById('tl-new-entry-low').value) || null,
            grade: document.getElementById('tl-new-entry-grade').value
        };

        try {
            const result = await fetch(`/api/v2/trade-journal/${currentTradeLog.id}/entry`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(entry)
            });
            const res = await result.json();
            if (res.success) {
                toast('Entry added!', 'success');
                await render();
            } else {
                toast(res.error || 'Failed to add entry', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function addTradeLogExit() {
        if (!currentTradeLog || !currentTradeLog.id) {
            toast('Save the trade first before adding exits', 'error');
            return;
        }

        const qty = parseInt(document.getElementById('tl-new-exit-qty').value);
        const orderPrice = parseFloat(document.getElementById('tl-new-exit-ordprice').value);
        const filledPrice = parseFloat(document.getElementById('tl-new-exit-fillprice').value) || orderPrice;

        if (!qty || !orderPrice) { toast('Quantity and Order Price are required', 'error'); return; }

        const exit = {
            exit_datetime: document.getElementById('tl-new-exit-date').value,
            quantity: qty,
            order_price: orderPrice,
            filled_price: filledPrice,
            slippage: parseFloat(document.getElementById('tl-new-exit-slip').value) || 0,
            commission: parseFloat(document.getElementById('tl-new-exit-comm').value) || 0,
            position_size: filledPrice * qty,
            day_high: parseFloat(document.getElementById('tl-new-exit-high').value) || null,
            day_low: parseFloat(document.getElementById('tl-new-exit-low').value) || null,
            grade: document.getElementById('tl-new-exit-grade').value
        };

        try {
            const result = await fetch(`/api/v2/trade-journal/${currentTradeLog.id}/exit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(exit)
            });
            const res = await result.json();
            if (res.success) {
                toast('Exit added!', 'success');
                await render();
            } else {
                toast(res.error || 'Failed to add exit', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function deleteTradeLogEntry(entryId) {
        if (!confirm('Delete this entry?')) return;
        try {
            await fetch(`/api/v2/trade-journal/entry/${entryId}`, {method: 'DELETE'});
            toast('Entry deleted', 'success');
            await render();
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function deleteTradeLogExit(exitId) {
        if (!confirm('Delete this exit?')) return;
        try {
            await fetch(`/api/v2/trade-journal/exit/${exitId}`, {method: 'DELETE'});
            toast('Exit deleted', 'success');
            await render();
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function deleteTradeLog(id) {
        if (!confirm('Delete this trade and all its entries/exits?')) return;
        try {
            await fetch(`/api/v2/trade-journal/${id}`, {method: 'DELETE'});
            toast('Trade deleted', 'success');
            await render();
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function recalculateTradeLog(journalId) {
        try {
            const resp = await fetch(`/api/v2/trade-journal/${journalId}/recalculate`, {method: 'POST'});
            const res = await resp.json();
            if (res.success) {
                toast('Recalculated successfully!', 'success');
                await render();
            } else {
                toast(res.error || 'Recalculation failed', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // ========== TRADE SUMMARY ==========
    async function tradeSummaryView() {
        try {
            const resp = await fetch('/api/v2/trade-journal');
            const data = await resp.json();
            const trades = data.journals || [];
            const closed = trades.filter(t => t.status === 'closed');
            const sym = '‚Çπ';

            // Calculate by strategy
            const strategies = {};
            closed.forEach(t => {
                const strat = t.strategy || 'Unspecified';
                if (!strategies[strat]) strategies[strat] = {wins: 0, losses: 0, totalPnL: 0, count: 0};
                strategies[strat].count++;
                strategies[strat].totalPnL += t.gain_loss_amount || 0;
                if ((t.gain_loss_amount || 0) > 0) strategies[strat].wins++;
                else if ((t.gain_loss_amount || 0) < 0) strategies[strat].losses++;
            });

            const winners = closed.filter(t => (t.gain_loss_amount || 0) > 0);
            const losers = closed.filter(t => (t.gain_loss_amount || 0) < 0);
            const totalPnL = closed.reduce((s, t) => s + (t.gain_loss_amount || 0), 0);

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">Trade Summary</h2>

                    <div class="grid grid-cols-2 gap-6">
                        <!-- Overall Stats -->
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Overall Statistics</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between"><span class="text-gray-400">Total Trades</span><span class="font-mono">${trades.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Open Trades</span><span class="font-mono text-blue-400">${trades.length - closed.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Closed Trades</span><span class="font-mono">${closed.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Winning Trades</span><span class="font-mono text-green-400">${winners.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Losing Trades</span><span class="font-mono text-red-400">${losers.length}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Win Rate</span><span class="font-mono">${closed.length > 0 ? (winners.length / closed.length * 100).toFixed(1) : 0}%</span></div>
                                <div class="border-t border-gray-700 pt-3 mt-3"></div>
                                <div class="flex justify-between"><span class="text-gray-400">Total P&L</span><span class="font-mono ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${totalPnL.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Avg Win</span><span class="font-mono text-green-400">${sym}${winners.length > 0 ? (winners.reduce((s, t) => s + t.gain_loss_amount, 0) / winners.length).toFixed(2) : '0.00'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Avg Loss</span><span class="font-mono text-red-400">${sym}${losers.length > 0 ? (losers.reduce((s, t) => s + Math.abs(t.gain_loss_amount), 0) / losers.length).toFixed(2) : '0.00'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Largest Win</span><span class="font-mono text-green-400">${sym}${Math.max(...closed.map(t => t.gain_loss_amount || 0), 0).toFixed(2)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Largest Loss</span><span class="font-mono text-red-400">${sym}${Math.min(...closed.map(t => t.gain_loss_amount || 0), 0).toFixed(2)}</span></div>
                            </div>
                        </div>

                        <!-- Strategy Breakdown -->
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Strategy Performance</h3>
                            <div class="space-y-3">
                                ${Object.entries(strategies).map(([name, d]) => `
                                    <div class="p-3 bg-[#1f2937] rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">${name}</span>
                                            <span class="font-mono ${d.totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${d.totalPnL.toFixed(2)}</span>
                                        </div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            ${d.count} trades | ${(d.wins / d.count * 100).toFixed(0)}% win rate | ${d.wins}W / ${d.losses}L
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500">No closed trades yet</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch(e) {
            return `<div class="text-red-400">Error: ${e.message}</div>`;
        }
    }

    // ========== POSITIONS & HOLDINGS ==========
    async function positionsHoldingsView() {
        const sym = '‚Çπ';
        let data = { positions: [], holdings: [], summary: {} };

        try {
            const resp = await fetch('/api/v2/portfolio/context');
            data = await resp.json();
        } catch(e) {
            return `<div class="text-center py-20"><p class="text-red-400">Error: ${e.message}</p></div>`;
        }

        const s = data.summary || {};

        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üè¶ Portfolio</h2>
                    <button onclick="syncOrders()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">üîÑ Sync from Kite</button>
                </div>

                <!-- Portfolio Summary -->
                <div class="grid grid-cols-5 gap-3">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-blue-400">${sym}${(s.trading_capital || 0).toLocaleString()}</div>
                        <div class="text-xs text-gray-400">Trading Capital</div>
                    </div>
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-red-400">${sym}${(s.total_locked || 0).toLocaleString()}</div>
                        <div class="text-xs text-gray-400">Capital Locked</div>
                    </div>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-green-400">${sym}${(s.available_capital || 0).toLocaleString()}</div>
                        <div class="text-xs text-gray-400">Available</div>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold ${(s.positions_pnl||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${(s.positions_pnl||0).toLocaleString()}</div>
                        <div class="text-xs text-gray-400">Positions P/L</div>
                    </div>
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-yellow-400">${(s.capital_used_pct || 0).toFixed(1)}%</div>
                        <div class="text-xs text-gray-400">Capital Used</div>
                    </div>
                </div>

                <!-- Positions -->
                <div class="bg-[#111827] rounded-xl border border-blue-500/30 overflow-hidden">
                    <div class="px-4 py-2 bg-blue-500/10 border-b border-blue-500/30 flex justify-between items-center">
                        <h3 class="font-bold text-blue-400">üìä Open Positions (${data.positions.length})</h3>
                        <span class="text-xs text-gray-400">Value: ${sym}${(s.positions_value || 0).toLocaleString()}</span>
                    </div>
                    ${data.positions.length > 0 ? `
                    <table class="w-full text-xs">
                        <thead class="bg-[#1f2937]"><tr>
                            <th class="p-2 text-left text-gray-400">Symbol</th>
                            <th class="p-2 text-left text-gray-400">Product</th>
                            <th class="p-2 text-right text-gray-400">Qty</th>
                            <th class="p-2 text-right text-gray-400">Avg Price</th>
                            <th class="p-2 text-right text-gray-400">LTP</th>
                            <th class="p-2 text-right text-gray-400">P/L</th>
                            <th class="p-2 text-right text-gray-400">P/L %</th>
                        </tr></thead>
                        <tbody>
                            ${data.positions.map(p => {
                                const pnlPct = p.average_price ? ((p.last_price - p.average_price) / p.average_price * 100) : 0;
                                return `<tr class="border-t border-gray-700/50">
                                    <td class="p-2 font-mono font-bold text-blue-400">${p.tradingsymbol}</td>
                                    <td class="p-2 text-xs">${p.product || '-'}</td>
                                    <td class="p-2 text-right font-mono">${p.quantity}</td>
                                    <td class="p-2 text-right font-mono">${sym}${(p.average_price||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono">${sym}${(p.last_price||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono ${(p.pnl||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${(p.pnl||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono ${pnlPct >= 0 ? 'text-green-400' : 'text-red-400'}">${pnlPct.toFixed(2)}%</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>` : '<p class="p-4 text-gray-500 text-center">No open positions</p>'}
                </div>

                <!-- Holdings -->
                <div class="bg-[#111827] rounded-xl border border-green-500/30 overflow-hidden">
                    <div class="px-4 py-2 bg-green-500/10 border-b border-green-500/30 flex justify-between items-center">
                        <h3 class="font-bold text-green-400">üè¶ Holdings (${data.holdings.length})</h3>
                        <span class="text-xs text-gray-400">Value: ${sym}${(s.holdings_value || 0).toLocaleString()} | P/L: ${sym}${(s.holdings_pnl || 0).toLocaleString()}</span>
                    </div>
                    ${data.holdings.length > 0 ? `
                    <table class="w-full text-xs">
                        <thead class="bg-[#1f2937]"><tr>
                            <th class="p-2 text-left text-gray-400">Symbol</th>
                            <th class="p-2 text-right text-gray-400">Qty</th>
                            <th class="p-2 text-right text-gray-400">Avg Price</th>
                            <th class="p-2 text-right text-gray-400">LTP</th>
                            <th class="p-2 text-right text-gray-400">P/L</th>
                            <th class="p-2 text-right text-gray-400">Day Chg</th>
                            <th class="p-2 text-right text-gray-400">Day %</th>
                        </tr></thead>
                        <tbody>
                            ${data.holdings.map(h => `
                                <tr class="border-t border-gray-700/50">
                                    <td class="p-2 font-mono font-bold text-green-400">${h.tradingsymbol}</td>
                                    <td class="p-2 text-right font-mono">${h.quantity}</td>
                                    <td class="p-2 text-right font-mono">${sym}${(h.average_price||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono">${sym}${(h.last_price||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono ${(h.pnl||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${(h.pnl||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono ${(h.day_change||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${(h.day_change||0).toFixed(2)}</td>
                                    <td class="p-2 text-right font-mono ${(h.day_change_percentage||0) >= 0 ? 'text-green-400' : 'text-red-400'}">${(h.day_change_percentage||0).toFixed(2)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` : '<p class="p-4 text-gray-500 text-center">No holdings</p>'}
                </div>
            </div>
        `;
    }

    // ========== ORDERS SCREEN ==========
    async function ordersView() {
        const sym = '‚Çπ';
        let data = { pending: [], executed: [], other: [], gtt_orders: [], summary: {} };

        try {
            const resp = await fetch('/api/v2/orders/history');
            data = await resp.json();
        } catch(e) {
            return `<div class="text-center py-20"><p class="text-red-400">Error: ${e.message}</p><p class="text-gray-500 mt-2">Sync orders from Settings first.</p></div>`;
        }

        function orderRow(o, showActions=false) {
            const isBuy = o.transaction_type === 'BUY';
            const statusColor = (o.status||'').includes('COMPLETE') ? 'text-green-400' :
                (o.status||'').includes('OPEN') || (o.status||'').includes('PENDING') ? 'text-blue-400' :
                (o.status||'').includes('CANCEL') ? 'text-gray-400' : 'text-red-400';
            const orderJson = JSON.stringify(o).replace(/'/g, "\\'").replace(/"/g, '&quot;');
            return `
                <tr class="border-t border-gray-700/50 hover:bg-[#1f2937]/50">
                    <td class="p-2 font-mono text-xs">${o.placed_at ? o.placed_at.split('T')[0] : '-'}</td>
                    <td class="p-2 font-mono font-bold text-blue-400">${o.tradingsymbol || '-'}</td>
                    <td class="p-2 text-center"><span class="${isBuy ? 'text-green-400' : 'text-red-400'}">${o.transaction_type || '-'}</span></td>
                    <td class="p-2 font-mono text-xs">${o.order_type || '-'}</td>
                    <td class="p-2 text-right font-mono">${o.quantity || '-'}</td>
                    <td class="p-2 text-right font-mono">${o.filled_quantity || 0}</td>
                    <td class="p-2 text-right font-mono">${o.price ? sym + parseFloat(o.price).toFixed(2) : '-'}</td>
                    <td class="p-2 text-right font-mono">${o.average_price ? sym + parseFloat(o.average_price).toFixed(2) : '-'}</td>
                    <td class="p-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${statusColor}">${o.status || '-'}</span></td>
                    ${showActions ? `<td class="p-2 text-center whitespace-nowrap">
                        <button onclick='modifyRegularOrder("${o.order_id}", ${orderJson})' class="px-1.5 py-0.5 text-xs bg-blue-600/30 text-blue-400 rounded hover:bg-blue-600/50 mr-1" title="Modify">‚úèÔ∏è</button>
                        <button onclick='cancelRegularOrder("${o.order_id}")' class="px-1.5 py-0.5 text-xs bg-red-600/30 text-red-400 rounded hover:bg-red-600/50" title="Cancel">‚úï</button>
                    </td>` : ''}
                </tr>`;
        }

        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üì¶ Orders</h2>
                    <div class="flex gap-2">
                        <button onclick="syncOrders()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">üîÑ Sync from Kite</button>
                    </div>
                </div>

                <!-- Summary -->
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-blue-400">${data.summary.pending_count || 0}</div>
                        <div class="text-xs text-gray-400">Pending</div>
                    </div>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-green-400">${data.summary.executed_count || 0}</div>
                        <div class="text-xs text-gray-400">Executed</div>
                    </div>
                    <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-orange-400">${data.summary.gtt_count || 0}</div>
                        <div class="text-xs text-gray-400">GTT Active</div>
                    </div>
                    <div class="bg-gray-500/10 border border-gray-500/30 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-gray-400">${data.summary.total || 0}</div>
                        <div class="text-xs text-gray-400">Total Orders</div>
                    </div>
                </div>

                <!-- Pending Orders -->
                ${data.pending.length > 0 ? `
                <div class="bg-[#111827] rounded-xl border border-blue-500/30 overflow-hidden">
                    <div class="px-4 py-2 bg-blue-500/10 border-b border-blue-500/30"><h3 class="font-bold text-blue-400">üîµ Pending Orders (${data.pending.length})</h3></div>
                    <table class="w-full text-xs"><thead class="bg-[#1f2937]"><tr>
                        <th class="p-2 text-left text-gray-400">Date</th><th class="p-2 text-left text-gray-400">Symbol</th>
                        <th class="p-2 text-center text-gray-400">Side</th><th class="p-2 text-left text-gray-400">Type</th>
                        <th class="p-2 text-right text-gray-400">Qty</th><th class="p-2 text-right text-gray-400">Filled</th>
                        <th class="p-2 text-right text-gray-400">Price</th><th class="p-2 text-right text-gray-400">Avg</th>
                        <th class="p-2 text-center text-gray-400">Status</th>
                        <th class="p-2 text-center text-gray-400">Actions</th>
                    </tr></thead><tbody>${data.pending.map(o => orderRow(o, true)).join('')}</tbody></table>
                </div>` : ''}

                <!-- Executed Orders -->
                ${data.executed.length > 0 ? `
                <div class="bg-[#111827] rounded-xl border border-green-500/30 overflow-hidden">
                    <div class="px-4 py-2 bg-green-500/10 border-b border-green-500/30"><h3 class="font-bold text-green-400">üü¢ Executed Orders (${data.executed.length})</h3></div>
                    <table class="w-full text-xs"><thead class="bg-[#1f2937]"><tr>
                        <th class="p-2 text-left text-gray-400">Date</th><th class="p-2 text-left text-gray-400">Symbol</th>
                        <th class="p-2 text-center text-gray-400">Side</th><th class="p-2 text-left text-gray-400">Type</th>
                        <th class="p-2 text-right text-gray-400">Qty</th><th class="p-2 text-right text-gray-400">Filled</th>
                        <th class="p-2 text-right text-gray-400">Price</th><th class="p-2 text-right text-gray-400">Avg</th>
                        <th class="p-2 text-center text-gray-400">Status</th>
                    </tr></thead><tbody>${data.executed.map(orderRow).join('')}</tbody></table>
                </div>` : ''}

                <!-- GTT Orders -->
                ${data.gtt_orders.length > 0 ? `
                <div class="bg-[#111827] rounded-xl border border-orange-500/30 overflow-hidden">
                    <div class="px-4 py-2 bg-orange-500/10 border-b border-orange-500/30"><h3 class="font-bold text-orange-400">üü† GTT Orders (${data.gtt_orders.length})</h3></div>
                    <table class="w-full text-xs"><thead class="bg-[#1f2937]"><tr>
                        <th class="p-2 text-left text-gray-400">Symbol</th>
                        <th class="p-2 text-center text-gray-400">Type</th>
                        <th class="p-2 text-center text-gray-400">Side</th>
                        <th class="p-2 text-right text-gray-400">Qty</th>
                        <th class="p-2 text-right text-gray-400">Trigger</th>
                        <th class="p-2 text-right text-gray-400">Limit</th>
                        <th class="p-2 text-right text-gray-400">SL/Target</th>
                        <th class="p-2 text-center text-gray-400">Status</th>
                        <th class="p-2 text-center text-gray-400">Actions</th>
                    </tr></thead><tbody>
                    ${data.gtt_orders.map(g => {
                        const isBuy = (g.transaction_type || '').toUpperCase() === 'BUY';
                        const triggerVals = g.trigger_values || [];
                        const orders = g.orders || [];
                        const isTwoLeg = (g.trigger_type || '').toLowerCase() === 'two-leg' || triggerVals.length > 1;

                        // For two-leg: first order is SL, second is target (or vice versa)
                        let legInfo = '';
                        if (isTwoLeg && orders.length >= 2) {
                            const leg1 = orders[0];
                            const leg2 = orders[1];
                            legInfo = '<span class="text-red-400">SL: ' + sym + (triggerVals[0] || '-') + '</span> / <span class="text-green-400">T: ' + sym + (triggerVals[1] || '-') + '</span>';
                        } else if (triggerVals.length > 1) {
                            legInfo = '<span class="text-red-400">SL: ' + sym + (triggerVals[0] || '-') + '</span> / <span class="text-green-400">T: ' + sym + (triggerVals[1] || '-') + '</span>';
                        } else {
                            legInfo = '-';
                        }

                        return '<tr class="border-t border-gray-700/50 hover:bg-[#1f2937]/50">' +
                            '<td class="p-2 font-mono font-bold text-blue-400">' + (g.tradingsymbol || g.symbol || '-') + '</td>' +
                            '<td class="p-2 text-center"><span class="px-1.5 py-0.5 rounded text-xs ' + (isTwoLeg ? 'bg-purple-500/20 text-purple-400' : 'bg-orange-500/20 text-orange-400') + '">' + (g.trigger_type || 'single') + '</span></td>' +
                            '<td class="p-2 text-center"><span class="' + (isBuy ? 'text-green-400' : 'text-red-400') + '">' + (g.transaction_type || '-') + '</span></td>' +
                            '<td class="p-2 text-right font-mono">' + (g.quantity || '-') + '</td>' +
                            '<td class="p-2 text-right font-mono">' + sym + (g.trigger_price || triggerVals[0] || '-') + '</td>' +
                            '<td class="p-2 text-right font-mono">' + (g.limit_price ? sym + g.limit_price : '-') + '</td>' +
                            '<td class="p-2 text-right font-mono">' + legInfo + '</td>' +
                            '<td class="p-2 text-center"><span class="px-2 py-0.5 rounded text-xs bg-orange-500/20 text-orange-400">' + (g.status || 'ACTIVE') + '</span></td>' +
                            '<td class="p-2 text-center"><button onclick="cancelGttOrder(' + (g.trigger_id || 0) + ')" class="px-2 py-1 text-xs bg-red-600/30 text-red-400 rounded hover:bg-red-600/50" title="Cancel GTT">‚úï</button></td>' +
                            '</tr>';
                    }).join('')}
                    </tbody></table>
                </div>` : ''}

                <!-- Other/Cancelled Orders -->
                ${data.other.length > 0 ? `
                <div class="bg-[#111827] rounded-xl border border-gray-700 overflow-hidden">
                    <div class="px-4 py-2 bg-gray-500/10 border-b border-gray-700"><h3 class="font-bold text-gray-400">Other Orders (${data.other.length})</h3></div>
                    <table class="w-full text-xs"><thead class="bg-[#1f2937]"><tr>
                        <th class="p-2 text-left text-gray-400">Date</th><th class="p-2 text-left text-gray-400">Symbol</th>
                        <th class="p-2 text-center text-gray-400">Side</th><th class="p-2 text-left text-gray-400">Type</th>
                        <th class="p-2 text-right text-gray-400">Qty</th><th class="p-2 text-right text-gray-400">Filled</th>
                        <th class="p-2 text-right text-gray-400">Price</th><th class="p-2 text-right text-gray-400">Avg</th>
                        <th class="p-2 text-center text-gray-400">Status</th>
                    </tr></thead><tbody>${data.other.map(orderRow).join('')}</tbody></table>
                </div>` : ''}

                ${(!data.pending.length && !data.executed.length && !data.gtt_orders.length) ? `
                <div class="text-center py-20">
                    <p class="text-gray-500 text-lg">No orders found</p>
                    <p class="text-gray-600 mt-2">Click "Sync from Kite" to fetch your orders</p>
                </div>` : ''}
            </div>
        `;
    }

    async function syncOrders() {
        try {
            toast('Syncing orders from Kite...', 'info');
            const resp = await fetch('/api/v2/sync/all', { method: 'POST', headers: {'Content-Type': 'application/json'} });
            const data = await resp.json();
            if (data.success) {
                toast(`Synced: ${data.orders || 0} orders, ${data.positions || 0} positions, ${data.holdings || 0} holdings`, 'success');
                await render();
            } else {
                toast(data.error || 'Sync failed', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function cancelRegularOrder(orderId) {
        const confirmed = await showOrderConfirmation('Cancel Order', [
            { label: 'Action', value: 'CANCEL ORDER', color: 'text-red-400' },
            { label: 'Order ID', value: orderId }
        ]);
        if (!confirmed) return;
        try {
            const resp = await fetch(`/api/v2/kite/orders/${orderId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (data.success) {
                toast('Order cancelled!', 'success');
                await render();
            } else {
                toast(data.error || 'Cancel failed', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function modifyRegularOrder(orderId, currentOrder) {
        const modal = document.getElementById('modal');
        const sym = '‚Çπ';
        modal.innerHTML = `
            <div class="bg-[#1f2937] rounded-xl border border-gray-600 max-w-md w-full p-6 space-y-4">
                <h3 class="text-lg font-bold text-white">Modify Order: ${currentOrder.tradingsymbol}</h3>
                <div class="space-y-3">
                    <div><label class="text-sm text-gray-400">Quantity</label>
                        <input id="mod-qty" type="number" value="${currentOrder.quantity || ''}" class="w-full mt-1 px-3 py-2 bg-[#111827] border border-gray-600 rounded-lg font-mono"></div>
                    <div><label class="text-sm text-gray-400">Price (${sym})</label>
                        <input id="mod-price" type="number" step="0.05" value="${currentOrder.price || ''}" class="w-full mt-1 px-3 py-2 bg-[#111827] border border-gray-600 rounded-lg font-mono"></div>
                    <div><label class="text-sm text-gray-400">Trigger Price (${sym})</label>
                        <input id="mod-trigger" type="number" step="0.05" value="${currentOrder.trigger_price || ''}" class="w-full mt-1 px-3 py-2 bg-[#111827] border border-gray-600 rounded-lg font-mono"></div>
                </div>
                <div class="border-t border-gray-700 pt-4 flex gap-3">
                    <button id="mod-confirm-btn" class="flex-1 py-2.5 bg-blue-600 rounded-lg font-medium hover:bg-blue-700 text-white">Save Changes</button>
                    <button id="mod-cancel-btn" class="flex-1 py-2.5 bg-gray-600 rounded-lg font-medium hover:bg-gray-700 text-white">Cancel</button>
                </div>
            </div>
        `;
        modal.classList.remove('hidden');

        document.getElementById('mod-confirm-btn').onclick = async () => {
            modal.classList.add('hidden');
            const qty = parseInt(document.getElementById('mod-qty').value) || null;
            const price = parseFloat(document.getElementById('mod-price').value) || null;
            const trigger = parseFloat(document.getElementById('mod-trigger').value) || null;
            try {
                const resp = await fetch(`/api/v2/kite/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ quantity: qty, price: price, trigger_price: trigger })
                });
                const data = await resp.json();
                if (data.success) {
                    toast('Order modified!', 'success');
                    await render();
                } else {
                    toast(data.error || 'Modify failed', 'error');
                }
            } catch(e) { toast('Error: ' + e.message, 'error'); }
        };
        document.getElementById('mod-cancel-btn').onclick = () => modal.classList.add('hidden');
    }

    async function cancelGttOrder(triggerId) {
        if (!triggerId) return;
        const confirmed = await showOrderConfirmation('Cancel GTT Order', [
            { label: 'Action', value: 'CANCEL GTT', color: 'text-red-400' },
            { label: 'Trigger ID', value: String(triggerId) }
        ]);
        if (!confirmed) return;
        try {
            const resp = await fetch(`/api/v2/kite/gtt/${triggerId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (data.success) {
                toast('GTT order cancelled!', 'success');
                await render();
            } else {
                toast(data.error || 'Cancel GTT failed', 'error');
            }
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    // ========== P&L TRACKER ==========
    async function pnlTrackerView() {
        try {
            const response = await api('GET', '/trade-log');
            const trades = response.trades || [];
            const closed = trades.filter(t => t.exit_date);
            const sym = '‚Çπ';  // Always INR for NSE
            
            // Group by date
            const byDate = {};
            closed.forEach(t => {
                const date = t.exit_date?.split('T')[0];
                if (date) {
                    if (!byDate[date]) byDate[date] = {trades: 0, pnl: 0};
                    byDate[date].trades++;
                    byDate[date].pnl += t.net_pnl || 0;
                }
            });
            
            // Group by week
            const byWeek = {};
            closed.forEach(t => {
                if (t.exit_date) {
                    const d = new Date(t.exit_date);
                    const week = `${d.getFullYear()}-W${Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7)}`;
                    if (!byWeek[week]) byWeek[week] = {trades: 0, pnl: 0};
                    byWeek[week].trades++;
                    byWeek[week].pnl += t.net_pnl || 0;
                }
            });
            
            // Group by month
            const byMonth = {};
            closed.forEach(t => {
                if (t.exit_date) {
                    const d = new Date(t.exit_date);
                    const month = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if (!byMonth[month]) byMonth[month] = {trades: 0, pnl: 0};
                    byMonth[month].trades++;
                    byMonth[month].pnl += t.net_pnl || 0;
                }
            });
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">üíµ P&L Tracker</h2>
                    
                    <div class="grid grid-cols-3 gap-6">
                        <!-- Daily P&L -->
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Daily P&L</h3>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                ${Object.entries(byDate).sort((a, b) => b[0].localeCompare(a[0])).map(([date, data]) => `
                                    <div class="flex justify-between items-center p-2 bg-[#1f2937] rounded">
                                        <span class="font-mono text-sm">${date}</span>
                                        <div class="text-right">
                                            <div class="font-mono ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${data.pnl.toFixed(2)}</div>
                                            <div class="text-xs text-gray-500">${data.trades} trades</div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500">No data</p>'}
                            </div>
                        </div>
                        
                        <!-- Weekly P&L -->
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Weekly P&L</h3>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                ${Object.entries(byWeek).sort((a, b) => b[0].localeCompare(a[0])).map(([week, data]) => `
                                    <div class="flex justify-between items-center p-2 bg-[#1f2937] rounded">
                                        <span class="font-mono text-sm">${week}</span>
                                        <div class="text-right">
                                            <div class="font-mono ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${data.pnl.toFixed(2)}</div>
                                            <div class="text-xs text-gray-500">${data.trades} trades</div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500">No data</p>'}
                            </div>
                        </div>
                        
                        <!-- Monthly P&L -->
                        <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold text-lg mb-4">Monthly P&L</h3>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                ${Object.entries(byMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([month, data]) => `
                                    <div class="flex justify-between items-center p-2 bg-[#1f2937] rounded">
                                        <span class="font-mono text-sm">${month}</span>
                                        <div class="text-right">
                                            <div class="font-mono ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${data.pnl.toFixed(2)}</div>
                                            <div class="text-xs text-gray-500">${data.trades} trades</div>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500">No data</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch(e) {
            return `<div class="text-red-400">Error: ${e.message}</div>`;
        }
    }

    // ========== MISTAKES TRACKER ==========
    async function mistakesView() {
        try {
            const response = await api('GET', '/trade-log');
            const trades = response.trades || [];
            const closed = trades.filter(t => t.exit_date);
            const sym = '‚Çπ';  // Always INR for NSE
            
            // Group by mistake
            const byMistake = {};
            closed.filter(t => t.mistake).forEach(t => {
                if (!byMistake[t.mistake]) byMistake[t.mistake] = {trades: 0, pnl: 0};
                byMistake[t.mistake].trades++;
                byMistake[t.mistake].pnl += t.net_pnl || 0;
            });
            
            const totalMistakeTrades = Object.values(byMistake).reduce((s, m) => s + m.trades, 0);
            const totalMistakePnL = Object.values(byMistake).reduce((s, m) => s + m.pnl, 0);
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">‚ö†Ô∏è Mistakes Tracker</h2>
                    
                    <!-- Summary -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-red-400">${totalMistakeTrades}</div>
                            <div class="text-gray-400">Trades with Mistakes</div>
                        </div>
                        <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-red-400">${sym}${totalMistakePnL.toFixed(2)}</div>
                            <div class="text-gray-400">Total Impact</div>
                        </div>
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-yellow-400">${closed.length > 0 ? (totalMistakeTrades / closed.length * 100).toFixed(1) : 0}%</div>
                            <div class="text-gray-400">Mistake Rate</div>
                        </div>
                    </div>
                    
                    <!-- Mistakes Breakdown -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                        <h3 class="font-bold text-lg mb-4">Mistakes Breakdown</h3>
                        <table class="w-full text-sm">
                            <thead class="text-gray-400 border-b border-gray-700">
                                <tr>
                                    <th class="text-left py-2">Mistake</th>
                                    <th class="text-right py-2">No. Trades</th>
                                    <th class="text-right py-2">Total P&L Impact</th>
                                    <th class="text-right py-2">Avg per Trade</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(byMistake).sort((a, b) => a[1].pnl - b[1].pnl).map(([mistake, data]) => `
                                    <tr class="border-b border-gray-700/50">
                                        <td class="py-3 font-medium">${mistake}</td>
                                        <td class="py-3 text-right font-mono">${data.trades}</td>
                                        <td class="py-3 text-right font-mono ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${data.pnl.toFixed(2)}</td>
                                        <td class="py-3 text-right font-mono ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${sym}${(data.pnl / data.trades).toFixed(2)}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" class="py-8 text-center text-gray-500">No mistakes recorded. Great discipline!</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Improvement Tips -->
                    <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                        <h3 class="font-bold text-lg mb-4">üìö Elder's Wisdom on Common Mistakes</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-[#1f2937] rounded-lg">
                                <div class="font-medium text-yellow-400">Tight Stop Loss</div>
                                <p class="text-gray-400 mt-1">"Place stops outside the noise. Use 2√ó ATR below entry for long trades."</p>
                            </div>
                            <div class="p-3 bg-[#1f2937] rounded-lg">
                                <div class="font-medium text-yellow-400">FOMO</div>
                                <p class="text-gray-400 mt-1">"Never chase a runaway market. Wait for pullbacks to the EMA."</p>
                            </div>
                            <div class="p-3 bg-[#1f2937] rounded-lg">
                                <div class="font-medium text-yellow-400">Revenge Trading</div>
                                <p class="text-gray-400 mt-1">"After a loss, step away. The 6% rule protects you from yourself."</p>
                            </div>
                            <div class="p-3 bg-[#1f2937] rounded-lg">
                                <div class="font-medium text-yellow-400">Rule Deviation</div>
                                <p class="text-gray-400 mt-1">"Good records are the single most important contribution to success."</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch(e) {
            return `<div class="text-red-400">Error: ${e.message}</div>`;
        }
    }

    // ========== FAVORITES ==========
    async function favoritesView() {
        const market = document.getElementById('market').value;
        try {
            const response = await api('GET', `/favorites?market=${market}`);
            const favorites = response.favorites || [];
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">‚≠ê Favorite Stocks</h2>
                            <p class="text-gray-500 text-sm">Your watched stocks with price data</p>
                        </div>
                        <div class="flex gap-2">
                            <select id="fav-market" class="bg-[#1f2937] border border-gray-600 rounded px-3 py-2 text-sm" disabled>
                                <option value="IN" selected>üáÆüá≥ NSE (NIFTY 100)</option>
                            </select>
                        </div>
                    </div>

                    ${favorites.length === 0 ? `
                        <div class="text-center py-20 text-gray-500">
                            <div class="text-6xl mb-4">‚≠ê</div>
                            <h3 class="text-xl font-semibold">No Favorite Stocks Yet</h3>
                            <p class="mt-2">Click the star icon on any stock in the screener to add it to your favorites</p>
                            <button onclick="switchTab('screener')" class="mt-6 px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">Go to Screener</button>
                        </div>
                    ` : `
                        <div class="bg-[#111827] rounded-xl overflow-hidden border border-gray-700">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-[#1f2937]">
                                        <tr>
                                            <th class="text-left p-3 font-medium text-gray-400">Symbol</th>
                                            <th class="text-left p-3 font-medium text-gray-400">Price</th>
                                            <th class="text-left p-3 font-medium text-gray-400">Name</th>
                                            <th class="text-left p-3 font-medium text-gray-400">Notes</th>
                                            <th class="text-left p-3 font-medium text-gray-400">Added</th>
                                            <th class="text-center p-3 font-medium text-gray-400">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${favorites.map(fav => `
                                            <tr class="border-t border-gray-700/50 hover:bg-[#1f2937]/50">
                                                <td class="p-3">
                                                    <span class="font-mono font-bold text-blue-400">${fav.symbol}</span>
                                                </td>
                                                <td class="p-3 font-mono">
                                                    $${fav.price ? fav.price.toFixed(2) : 'N/A'}
                                                </td>
                                                <td class="p-3 text-sm text-gray-400">${fav.name || ''}</td>
                                                <td class="p-3 text-sm text-gray-400">${fav.notes ? fav.notes : '-'}</td>
                                                <td class="p-3 text-xs text-gray-500">${new Date(fav.created_at).toLocaleDateString()}</td>
                                                <td class="p-3 text-center">
                                                    <div class="flex gap-1 justify-center">
                                                        <button onclick="editFavoriteNotes('${fav.symbol}')" class="px-2 py-1 text-xs bg-blue-600 rounded hover:bg-blue-700" title="Edit notes">üìù</button>
                                                        <button onclick="removeFavoriteStock('${fav.symbol}')" class="px-2 py-1 text-xs bg-red-600 rounded hover:bg-red-700" title="Remove">‚úï</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-[#111827] rounded-xl p-4 border border-gray-700">
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-gray-400">Total favorites: <span class="font-bold text-blue-400">${favorites.length}</span></p>
                                <div class="flex gap-2">
                                    <button onclick="switchTab('screener')" class="px-3 py-2 text-sm bg-blue-600 rounded hover:bg-blue-700">‚ûï Add More</button>
                                    <button onclick="confirmClearAllFavorites()" class="px-3 py-2 text-sm bg-red-600 rounded hover:bg-red-700">üóëÔ∏è Clear All</button>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            `;
        } catch(e) {
            return `<div class="text-red-400">Error loading favorites: ${e.message}</div>`;
        }
    }

    async function removeFavoriteStock(symbol) {
        if (!confirm(`Remove ${symbol} from favorites?`)) return;
        
        const market = document.getElementById('market').value;
        try {
            await api('DELETE', `/favorites/${symbol}?market=${market}`);
            toast(`${symbol} removed from favorites`, 'success');
            await switchTab('favorites');
        } catch(e) {
            toast(`Error: ${e.message}`, 'error');
        }
    }

    async function editFavoriteNotes(symbol) {
        const market = document.getElementById('market').value;
        const currentNotes = prompt('Enter notes for this stock:', '');
        if (currentNotes === null) return;
        
        try {
            const result = await api('PUT', `/favorites/${symbol}/notes`, {market, notes: currentNotes});
            toast('Notes updated', 'success');
            await switchTab('favorites');
        } catch(e) {
            toast(`Error: ${e.message}`, 'error');
        }
    }

    async function toggleFavorite(symbol) {
        const market = document.getElementById('market').value;
        try {
            const result = await api('POST', `/favorites/${symbol}`, {market});
            if (result.favorited) {
                toast(`${symbol} added to favorites!`, 'success');
            } else {
                toast(`${symbol} removed from favorites`, 'success');
            }
        } catch(e) {
            toast(`Error: ${e.message}`, 'error');
        }
    }

    async function confirmClearAllFavorites() {
        if (!confirm('Are you sure? This will remove ALL favorites. This cannot be undone.')) return;
        await clearAllFavorites();
    }

    async function clearAllFavorites() {
        const market = document.getElementById('market').value;
        try {
            const response = await api('GET', `/favorites?market=${market}`);
            const favorites = response.favorites || [];
            
            if (favorites.length === 0) {
                toast('No favorites to clear', 'info');
                return;
            }
            
            let cleared = 0;
            for (let fav of favorites) {
                try {
                    await api('DELETE', `/favorites/${fav.symbol}?market=${market}`);
                    cleared++;
                } catch(e) {
                    console.error(`Failed to delete ${fav.symbol}:`, e);
                }
            }
            
            toast(`Cleared ${cleared} favorites`, 'success');
            await switchTab('favorites');
        } catch(e) {
            toast(`Error: ${e.message}`, 'error');
        }
    }

    async function favoritesMarketChanged() {
        const newMarket = document.getElementById('fav-market').value;
        document.getElementById('market').value = newMarket;
        await switchTab('favorites');
    }

    // ========== HISTORICAL SCREENER FUNCTIONS ==========
    
    function toggleStock(symbol) {
        if (selectedStocks.has(symbol)) {
            selectedStocks.delete(symbol);
        } else {
            selectedStocks.add(symbol);
        }
        updateSelectedCount();
    }
    
    function selectAllStocks() {
        const checkboxes = document.querySelectorAll('.stock-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = true;
            selectedStocks.add(cb.value);
        });
        updateSelectedCount();
    }
    
    function clearAllStocks() {
        selectedStocks.clear();
        const checkboxes = document.querySelectorAll('.stock-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectedCount();
    }
    
    function selectTopStocks() {
        clearAllStocks();
        const top20 = historicalStocks.slice(0, 20);
        top20.forEach(s => {
            selectedStocks.add(s);
            const cb = document.querySelector(`.stock-checkbox[value="${s}"]`);
            if (cb) cb.checked = true;
        });
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const el = document.getElementById('selected-count');
        if (el) el.textContent = selectedStocks.size;
    }
    
    function filterStockList() {
        const query = document.getElementById('stock-search').value.toLowerCase();
        const items = document.querySelectorAll('.stock-item');
        items.forEach(item => {
            const symbol = item.dataset.symbol.toLowerCase();
            item.style.display = symbol.includes(query) ? '' : 'none';
        });
    }
    
    async function changeMarket() {
        const market = document.getElementById('hs-market').value;
        try {
            const resp = await fetch(`/api/v2/historical-screener/stocks?market=${market}`);
            const data = await resp.json();
            historicalStocks = data.stocks || [];
            
            // Rebuild stock list
            const stockList = document.getElementById('stock-list');
            stockList.innerHTML = historicalStocks.map(s => `
                <label class="flex items-center space-x-1 cursor-pointer hover:bg-gray-700 p-1 rounded stock-item" data-symbol="${s}">
                    <input type="checkbox" class="stock-checkbox rounded" value="${s}" onchange="toggleStock('${s}')">
                    <span class="text-gray-300">${s}</span>
                </label>
            `).join('');
            
            clearAllStocks();
        } catch(e) {
            console.error('Error changing market:', e);
        }
    }
    
    async function runHistoricalScreener() {
        if (selectedStocks.size === 0) {
            toast('Please select at least one stock', 'warning');
            return;
        }
        
        const symbols = Array.from(selectedStocks);
        const lookback = parseInt(document.getElementById('hs-lookback').value) || 180;
        const minScore = parseInt(document.getElementById('hs-min-score').value) || 5;
        const market = document.getElementById('hs-market').value;
        
        const btn = document.getElementById('run-screener-btn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Scanning... (this may take a few minutes)';
        
        try {
            const response = await fetch('/api/v2/historical-screener/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbols, lookback_days: lookback, min_score: minScore, market})
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Scan failed');
            }
            
            allSignals = result.signals || [];
            currentPage = 1;
            
            displaySummary(result.summary, result.symbols_scanned, result.symbols_with_signals, result.diagnostics);
            renderSignalsTable();
            
            document.getElementById('hs-results').style.display = 'block';
            document.getElementById('export-btn').style.display = allSignals.length > 0 ? 'inline-block' : 'none';
            
            // Show warning if no data was fetched
            if (result.diagnostics && result.diagnostics.symbols_with_data === 0) {
                toast('‚ö†Ô∏è No data available! Make sure Kite Connect is authenticated.', 'warning');
            } else {
                toast(`Scan complete! Found ${allSignals.length} signals`, 'success');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'üîç Scan Historical Data';
        }
    }
    
    function displaySummary(summary, scanned, withSignals, diagnostics) {
        const summaryEl = document.getElementById('hs-summary');
        
        // Check if we have data issues
        const hasDataIssue = diagnostics && diagnostics.symbols_with_data === 0;
        
        const stats = [
            {label: 'Total Signals', value: summary.total_signals, icon: 'üìä', color: 'text-blue-400'},
            {label: 'A-Trades', value: summary.a_trades, icon: '‚≠ê', color: 'text-yellow-400'},
            {label: 'B-Trades', value: summary.b_trades, icon: 'üìà', color: 'text-green-400'},
            {label: 'Avg Score', value: summary.avg_score || '-', icon: 'üéØ', color: 'text-purple-400'},
            {label: 'Stocks w/ Data', value: diagnostics ? `${diagnostics.symbols_with_data}/${scanned}` : `${withSignals}/${scanned}`, icon: hasDataIssue ? '‚ö†Ô∏è' : 'üìã', color: hasDataIssue ? 'text-red-400' : 'text-cyan-400'}
        ];
        
        let html = stats.map(s => `
            <div class="bg-[#1f2937] rounded-lg p-4 border border-gray-600 text-center">
                <div class="text-2xl mb-1">${s.icon}</div>
                <div class="text-gray-400 text-xs">${s.label}</div>
                <div class="text-lg font-bold ${s.color}">${s.value}</div>
            </div>
        `).join('');
        
        // Add warning message if no data
        if (hasDataIssue) {
            html += `
                <div class="col-span-full mt-4 p-4 bg-red-900/30 border border-red-700 rounded-lg text-center">
                    <p class="text-red-400 font-semibold">‚ö†Ô∏è No Data Available</p>
                    <p class="text-sm text-gray-400 mt-1">Make sure Kite Connect is authenticated.</p>
                    <p class="text-xs text-gray-500 mt-1">The historical screener needs Kite Connect to fetch stock data.</p>
                </div>
            `;
        }
        
        summaryEl.innerHTML = html;
    }
    
    function getVisibleColumns() {
        return {
            price: document.getElementById('col-price')?.checked,
            score: document.getElementById('col-score')?.checked,
            grade: document.getElementById('col-grade')?.checked,
            screen1: document.getElementById('col-screen1')?.checked,
            screen2: document.getElementById('col-screen2')?.checked,
            macd_h: document.getElementById('col-macd-h')?.checked,
            macd_line: document.getElementById('col-macd-line')?.checked,
            ema: document.getElementById('col-ema')?.checked,
            kc: document.getElementById('col-kc')?.checked,
            fi: document.getElementById('col-fi')?.checked,
            stoch: document.getElementById('col-stoch')?.checked,
            pattern: document.getElementById('col-pattern')?.checked,
            weekly_vals: document.getElementById('col-weekly-vals')?.checked,
            daily_vals: document.getElementById('col-daily-vals')?.checked,
            entry: document.getElementById('col-entry')?.checked
        };
    }
    
    function renderSignalsTable() {
        const cols = getVisibleColumns();
        const filtered = filterSignalsData();
        const totalPages = Math.ceil(filtered.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const pageData = filtered.slice(start, start + pageSize);
        
        // Build header
        let headers = ['Symbol', 'Date'];
        if (cols.price) headers.push('Price');
        if (cols.score) headers.push('Score');
        if (cols.grade) headers.push('Grade');
        if (cols.screen1) headers.push('Scr1');
        if (cols.screen2) headers.push('Scr2');
        if (cols.macd_h) headers.push('MACD-H');
        if (cols.macd_line) headers.push('MACD-L');
        if (cols.ema) headers.push('EMA');
        if (cols.kc) headers.push('KC');
        if (cols.fi) headers.push('FI');
        if (cols.stoch) headers.push('Stoch');
        if (cols.pattern) headers.push('Patt');
        if (cols.weekly_vals) headers.push('W-MACD', 'W-EMA20/50/100');
        if (cols.daily_vals) headers.push('D-FI2', 'D-Stoch', 'D-RSI');
        if (cols.entry) headers.push('Entry', 'Stop', 'Target');
        
        document.getElementById('signals-header').innerHTML = headers.map(h => 
            `<th class="pb-2 px-2 text-xs whitespace-nowrap">${h}</th>`
        ).join('');
        
        // Build rows
        const rowsHtml = pageData.map(s => {
            const gradeColor = s.grade === 'A' ? 'bg-yellow-500/20 text-yellow-400' : 
                              s.grade === 'B' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400';
            const allWeekly = s.all_weekly_filters ? '‚úì' : '';
            
            let cells = [
                `<td class="py-2 px-2 font-mono font-bold text-blue-400">${s.symbol}</td>`,
                `<td class="py-2 px-2 text-gray-300">${s.date}</td>`
            ];
            
            if (cols.price) cells.push(`<td class="py-2 px-2">${s.price}</td>`);
            if (cols.score) cells.push(`<td class="py-2 px-2 font-bold text-lg">${s.score}</td>`);
            if (cols.grade) cells.push(`<td class="py-2 px-2"><span class="px-2 py-1 rounded ${gradeColor}">${s.grade}${allWeekly}</span></td>`);
            if (cols.screen1) cells.push(`<td class="py-2 px-2 text-center">${s.screen1_score}</td>`);
            if (cols.screen2) cells.push(`<td class="py-2 px-2 text-center">${s.screen2_score}</td>`);
            if (cols.macd_h) cells.push(`<td class="py-2 px-2 text-center ${s.macd_h_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.macd_h_score > 0 ? '+'+s.macd_h_score : '0'}</td>`);
            if (cols.macd_line) cells.push(`<td class="py-2 px-2 text-center ${s.macd_line_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.macd_line_score > 0 ? '+'+s.macd_line_score : '0'}</td>`);
            if (cols.ema) cells.push(`<td class="py-2 px-2 text-center ${s.ema_alignment_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.ema_alignment_score > 0 ? '+'+s.ema_alignment_score : '0'}</td>`);
            if (cols.kc) cells.push(`<td class="py-2 px-2 text-center ${s.kc_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.kc_score > 0 ? '+'+s.kc_score : '0'}</td>`);
            if (cols.fi) cells.push(`<td class="py-2 px-2 text-center ${s.fi_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.fi_score > 0 ? '+'+s.fi_score : '0'}</td>`);
            if (cols.stoch) cells.push(`<td class="py-2 px-2 text-center ${s.stoch_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.stoch_score > 0 ? '+'+s.stoch_score : '0'}</td>`);
            if (cols.pattern) cells.push(`<td class="py-2 px-2 text-center ${s.pattern_score > 0 ? 'text-green-400' : 'text-gray-500'}">${s.pattern_score > 0 ? '+'+s.pattern_score : '0'}</td>`);
            if (cols.weekly_vals) {
                cells.push(`<td class="py-2 px-2 text-xs">${s.weekly_macd_h}</td>`);
                cells.push(`<td class="py-2 px-2 text-xs">${s.weekly_ema_20}/${s.weekly_ema_50}/${s.weekly_ema_100}</td>`);
            }
            if (cols.daily_vals) {
                cells.push(`<td class="py-2 px-2 text-xs">${s.daily_force_index_2}</td>`);
                cells.push(`<td class="py-2 px-2 text-xs">${s.daily_stochastic_k}</td>`);
                cells.push(`<td class="py-2 px-2 text-xs">${s.daily_rsi}</td>`);
            }
            if (cols.entry) {
                cells.push(`<td class="py-2 px-2 text-green-400">${s.entry}</td>`);
                cells.push(`<td class="py-2 px-2 text-red-400">${s.stop_loss}</td>`);
                cells.push(`<td class="py-2 px-2 text-blue-400">${s.target}</td>`);
            }
            
            return `<tr class="hover:bg-[#1f2937]/50">${cells.join('')}</tr>`;
        }).join('');
        
        document.getElementById('signals-body').innerHTML = rowsHtml || '<tr><td colspan="20" class="text-center py-8 text-gray-500">No signals found</td></tr>';
        
        // Pagination
        if (totalPages > 1) {
            let paginationHtml = '';
            if (currentPage > 1) {
                paginationHtml += `<button onclick="goToPage(${currentPage-1})" class="px-3 py-1 bg-gray-700 rounded hover:bg-gray-600">‚Üê</button>`;
            }
            paginationHtml += `<span class="px-3 py-1 text-gray-400">Page ${currentPage} of ${totalPages} (${filtered.length} signals)</span>`;
            if (currentPage < totalPages) {
                paginationHtml += `<button onclick="goToPage(${currentPage+1})" class="px-3 py-1 bg-gray-700 rounded hover:bg-gray-600">‚Üí</button>`;
            }
            document.getElementById('pagination').innerHTML = paginationHtml;
        } else {
            document.getElementById('pagination').innerHTML = `<span class="text-gray-500">${filtered.length} signals</span>`;
        }
    }
    
    function filterSignalsData() {
        const symbolFilter = document.getElementById('signal-filter')?.value.toUpperCase() || '';
        const gradeFilter = document.getElementById('grade-filter')?.value || '';
        
        return allSignals.filter(s => {
            if (symbolFilter && !s.symbol.includes(symbolFilter)) return false;
            if (gradeFilter && s.grade !== gradeFilter) return false;
            return true;
        });
    }
    
    function filterSignals() {
        currentPage = 1;
        renderSignalsTable();
    }
    
    function goToPage(page) {
        currentPage = page;
        renderSignalsTable();
    }
    
    function resetHistoricalScreener() {
        clearAllStocks();
        document.getElementById('hs-lookback').value = '180';
        document.getElementById('hs-min-score').value = '5';
        document.getElementById('hs-results').style.display = 'none';
        allSignals = [];
        toast('Scanner reset', 'info');
    }
    
    function exportToCSV() {
        if (allSignals.length === 0) {
            toast('No data to export', 'warning');
            return;
        }
        
        // Build CSV
        const headers = ['Symbol','Date','Price','Score','Grade','Screen1','Screen2',
                        'MACD_H_Score','MACD_Line_Score','EMA_Score','KC_Score','FI_Score','Stoch_Score','Pattern_Score',
                        'All_Weekly','Weekly_MACD_H','Weekly_EMA_20','Weekly_EMA_50','Weekly_EMA_100',
                        'Daily_FI2','Daily_Stoch_K','Daily_RSI','Pattern','Entry','Stop','Target'];
        
        const rows = allSignals.map(s => [
            s.symbol, s.date, s.price, s.score, s.grade, s.screen1_score, s.screen2_score,
            s.macd_h_score, s.macd_line_score, s.ema_alignment_score, s.kc_score, s.fi_score, s.stoch_score, s.pattern_score,
            s.all_weekly_filters ? 'Yes' : 'No', s.weekly_macd_h, s.weekly_ema_20, s.weekly_ema_50, s.weekly_ema_100,
            s.daily_force_index_2, s.daily_stochastic_k, s.daily_rsi, s.pattern, s.entry, s.stop_loss, s.target
        ].join(','));
        
        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `elder_signals_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        toast('CSV exported!', 'success');
    }
    
    // Add event listener for column toggles
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('col-toggle')) {
            if (allSignals.length > 0) {
                renderSignalsTable();
            }
        }
    });

    // ========== CHECKLIST ==========
    function checklistView() {
        const steps = [
            {id:'step1', title:'Check Positions & Orders', time:'5 min'},
            {id:'step2', title:'Weekly Chart Scan', time:'10 min'},
            {id:'step3', title:'Daily Chart Analysis', time:'15 min'},
            {id:'step4', title:'Calculate Entry/Stop/Target', time:'10 min'},
            {id:'step5', title:'Position Size', time:'5 min'},
            {id:'step6', title:'Place Orders', time:'5 min'},
            {id:'step7', title:'Update Trade Log', time:'5 min'}
        ];
        const done = Object.values(checklist).filter(Boolean).length;
        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">‚úÖ Evening Checklist</h2>
                    <span class="text-sm text-gray-500">${done}/7 completed</span>
                </div>
                <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 transition-all" style="width:${done/7*100}%"></div>
                </div>
                <div class="space-y-2">
                    ${steps.map(s => `
                        <div onclick="toggleCheck('${s.id}')" class="p-4 bg-[#111827] rounded-lg border ${checklist[s.id]?'border-green-500/50 opacity-60':'border-gray-700'} cursor-pointer hover:border-blue-500/50 flex items-center gap-4">
                            <div class="w-6 h-6 rounded-full border-2 ${checklist[s.id]?'bg-green-500 border-green-500':'border-gray-500'} flex items-center justify-center">
                                ${checklist[s.id]?'<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>':''}
                            </div>
                            <div class="flex-1">
                                <div class="font-medium">${s.title}</div>
                                <div class="text-xs text-gray-500">${s.time}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    async function toggleCheck(id) {
        checklist[id] = !checklist[id];
        await api('POST', '/checklist', {items:checklist});
        await render();
    }

    // ========== SETTINGS ==========
    function settingsView() {
        const s = settings[0] || {account_name:'Trading Account', trading_capital:500000, risk_per_trade:2, max_monthly_drawdown:6, target_rr:2, currency:'INR'};
        return `
            <div class="space-y-6 max-w-2xl">
                <h2 class="text-xl font-bold">‚öôÔ∏è Account Settings</h2>

                <!-- Kite Connect API Settings -->
                <div class="bg-[#111827] rounded-xl p-6 border border-blue-500/30 space-y-4">
                    <h3 class="font-bold text-blue-400 flex items-center gap-2">
                        <span>üîê</span> Kite Connect API (Zerodha)
                    </h3>
                    <p class="text-sm text-gray-500">Get your API Key and Secret from <a href="https://developers.kite.trade" target="_blank" class="text-blue-400 hover:underline">Kite Connect Developer Console</a></p>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">API Key</label>
                            <input id="s-kite-api-key" type="text" value="${s.kite_api_key||''}" placeholder="Your Kite API Key"
                                class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono text-sm">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">API Secret</label>
                            <input id="s-kite-api-secret" type="password" value="${s.kite_api_secret||''}" placeholder="Your Kite API Secret"
                                class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono text-sm">
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="saveKiteCredentials()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">
                            üíæ Save API Credentials
                        </button>
                        <button onclick="showKiteLoginModal()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">
                            üîó Login to Kite
                        </button>
                    </div>

                    ${s.kite_access_token ? `
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-sm">
                            <span class="text-green-400">‚úì Currently logged in</span>
                            <span class="text-gray-500 ml-2">(Token expires: ${s.kite_token_expiry || 'End of day'})</span>
                        </div>
                    ` : `
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 text-sm">
                            <span class="text-yellow-400">‚ö†Ô∏è Not logged in</span>
                            <span class="text-gray-500 ml-2">- Login required each trading day</span>
                        </div>
                    `}
                </div>

                <!-- Trading Settings -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700 space-y-4">
                    <h3 class="font-bold text-gray-300">üìä Trading Settings</h3>

                    <div><label class="text-sm text-gray-400">Account Name</label><input id="s-name" value="${s.account_name||''}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg"></div>

                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-sm text-gray-400">Trading Capital (‚Çπ)</label><input type="number" id="s-capital" value="${s.trading_capital}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Broker</label><input id="s-broker" value="${s.broker||'Zerodha'}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg"></div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-sm text-gray-400">Risk % per Trade</label><input type="number" id="s-risk" value="${s.risk_per_trade}" step="0.5" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Max Monthly DD %</label><input type="number" id="s-dd" value="${s.max_monthly_drawdown}" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Target R:R</label><input type="number" id="s-rr" value="${s.target_rr}" step="0.5" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                    </div>

                    <!-- Trade Limits -->
                    <h4 class="font-semibold text-gray-400 text-sm mt-4 pt-4 border-t border-gray-700">üõ°Ô∏è Trade Limits (Rule Enforcement)</h4>
                    <p class="text-xs text-gray-500 mb-2">Orders will be hard-blocked if any limit is exceeded.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-sm text-gray-400">Max Risk % per Day</label><input type="number" id="s-risk-per-day" value="${s.risk_per_day || 2}" step="0.5" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Max Trades per Day</label><input type="number" id="s-max-trades-day" value="${s.max_trades_per_day || 3}" step="1" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Max Risk % per Week</label><input type="number" id="s-risk-per-week" value="${s.risk_per_week || 5}" step="0.5" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                        <div><label class="text-sm text-gray-400">Max Open Positions</label><input type="number" id="s-max-positions" value="${s.max_open_positions || 5}" step="1" class="w-full mt-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg font-mono"></div>
                    </div>

                    <button onclick="saveSettings()" class="w-full py-3 bg-blue-600 rounded-lg font-medium hover:bg-blue-700">üíæ Save Trading Settings</button>
                </div>

                <!-- Data Management -->
                <div class="bg-[#111827] rounded-xl p-6 border border-green-500/30 space-y-4">
                    <h3 class="font-bold text-green-400 flex items-center gap-2">
                        <span>üìä</span> Data Management
                    </h3>
                    <p class="text-sm text-gray-500">Load 2-year historical data for NSE 500 stocks and pre-calculate all indicators. Run this once daily after market close (takes ~10-15 mins).</p>

                    <div id="data-status" class="bg-[#1f2937] p-4 rounded-lg space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Last Data Refresh:</span>
                            <span id="last-refresh-date" class="font-mono text-white">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Symbols Cached:</span>
                            <span id="symbols-cached" class="font-mono text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Data Range:</span>
                            <span id="data-range" class="font-mono text-white">-</span>
                        </div>
                        <div id="data-stale-warning" class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded p-2 text-sm text-yellow-400 mt-2">
                            ‚ö†Ô∏è Data is stale. Please load fresh data after market close.
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="load-data-btn" onclick="loadMarketData()" class="flex-1 py-3 bg-green-600 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            üì• Load NSE 500 Data
                        </button>
                        <button onclick="loadMarketData(true)" class="py-3 px-4 bg-yellow-600 rounded-lg font-medium hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            üîÑ Force Refresh
                        </button>
                        <button id="load-instruments-btn" onclick="loadNifty500Instruments()" class="flex-1 py-3 bg-blue-600 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            üìã Load Instruments
                        </button>
                    </div>

                    <div id="load-progress" class="hidden">
                        <div class="flex items-center gap-2 text-sm text-gray-400">
                            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="load-progress-text">Loading data...</span>
                        </div>
                    </div>
                </div>

                <!-- Mistakes Configuration -->
                <div class="bg-[#111827] rounded-xl p-6 border border-yellow-500/30 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-yellow-400 flex items-center gap-2"><span>‚ö†Ô∏è</span> Mistakes Configuration</h3>
                    </div>
                    <p class="text-sm text-gray-500">Configure common trading mistakes for the Trade Log.</p>
                    <div id="mistakes-list" class="space-y-2"></div>
                    <div class="flex gap-2">
                        <input id="new-mistake-name" placeholder="New mistake name..." class="flex-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg text-sm">
                        <button onclick="addMistake()" class="px-4 py-2 bg-yellow-600 rounded-lg hover:bg-yellow-700 text-sm">+ Add</button>
                    </div>
                </div>

                <!-- Strategies Configuration -->
                <div class="bg-[#111827] rounded-xl p-6 border border-purple-500/30 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-purple-400 flex items-center gap-2"><span>üìê</span> Strategies Configuration</h3>
                    </div>
                    <p class="text-sm text-gray-500">Configure global trading strategies for the Trade Log.</p>
                    <div id="strategies-list" class="space-y-2"></div>
                    <div class="flex gap-2">
                        <input id="new-strategy-name" placeholder="New strategy name..." class="flex-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg text-sm">
                        <button onclick="addStrategy()" class="px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700 text-sm">+ Add</button>
                    </div>
                </div>

                <!-- NSE Trading Info -->
                <div class="bg-[#111827] rounded-xl p-6 border border-gray-700">
                    <h3 class="font-bold text-gray-300 mb-3">üìà NSE Trading Info</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-[#1f2937] p-3 rounded-lg">
                            <p class="text-gray-500">Trading Hours</p>
                            <p class="font-mono text-white">9:15 AM - 3:30 PM IST</p>
                        </div>
                        <div class="bg-[#1f2937] p-3 rounded-lg">
                            <p class="text-gray-500">Market</p>
                            <p class="font-mono text-white">NSE 500</p>
                        </div>
                        <div class="bg-[#1f2937] p-3 rounded-lg">
                            <p class="text-gray-500">Currency</p>
                            <p class="font-mono text-white">INR (‚Çπ)</p>
                        </div>
                        <div class="bg-[#1f2937] p-3 rounded-lg">
                            <p class="text-gray-500">Delivery Brokerage</p>
                            <p class="font-mono text-green-400">‚Çπ0 (Free)</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ========== DATA MANAGEMENT ==========
    async function loadDataStatus() {
        try {
            const resp = await fetch('/api/v2/data/status');
            const status = await resp.json();

            const lastRefreshEl = document.getElementById('last-refresh-date');
            const symbolsCachedEl = document.getElementById('symbols-cached');
            const dataRangeEl = document.getElementById('data-range');
            const staleWarningEl = document.getElementById('data-stale-warning');

            if (lastRefreshEl) {
                if (status.last_refresh) {
                    const date = new Date(status.last_refresh);
                    lastRefreshEl.textContent = date.toLocaleString('en-IN', {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    });
                    lastRefreshEl.className = status.is_stale ? 'font-mono text-yellow-400' : 'font-mono text-green-400';
                } else {
                    lastRefreshEl.textContent = 'Never';
                    lastRefreshEl.className = 'font-mono text-red-400';
                }
            }

            if (symbolsCachedEl) {
                symbolsCachedEl.textContent = status.symbols_cached || '0';
            }

            if (dataRangeEl && status.data_from && status.data_to) {
                dataRangeEl.textContent = `${status.data_from} to ${status.data_to}`;
            }

            if (staleWarningEl) {
                staleWarningEl.classList.toggle('hidden', !status.is_stale);
            }
        } catch(e) {
            console.error('Error loading data status:', e);
        }
    }

    async function loadMarketData(forceRefresh = false) {
        const btn = document.getElementById('load-data-btn');
        const progress = document.getElementById('load-progress');
        const progressText = document.getElementById('load-progress-text');

        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';
        progress.classList.remove('hidden');
        progressText.textContent = 'Connecting to Kite...';

        try {
            progressText.textContent = 'Loading NSE 500 historical data (this may take 10-15 minutes)...';
            const resp = await fetch('/api/v2/data/load', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ force: forceRefresh, limit: 500 }),
                signal: AbortSignal.timeout(900000) // 15 min timeout
            });
            const result = await resp.json();

            if (result.success) {
                if (result.skipped) {
                    toast('Data already loaded for today! Use Force Refresh to reload.', 'info');
                } else {
                    toast(`Loaded ${result.symbols_loaded} / 500 NSE symbols!`, 'success');
                    if (result.symbols_failed && result.symbols_failed.length > 0) {
                        console.warn('Failed symbols:', result.symbols_failed.length);
                    }
                }
                await loadDataStatus();
            } else {
                toast(result.error || 'Failed to load data', 'error');
            }
        } catch(e) {
            if (e.name === 'TimeoutError') {
                toast('Load timed out after 15 minutes. Try loading fewer symbols.', 'error');
            } else {
                toast('Error: ' + e.message, 'error');
            }
        } finally {
            btn.disabled = false;
            btn.textContent = 'üì• Load Market Data';
            progress.classList.add('hidden');
        }
    }

    async function loadNifty500Instruments() {
        const btn = document.getElementById('load-instruments-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';
        try {
            const resp = await fetch('/api/v2/instruments/load', { method: 'POST', headers: {'Content-Type': 'application/json'} });
            const result = await resp.json();
            if (result.success) {
                toast(`Loaded ${result.loaded} NSE instruments!`, 'success');
            } else {
                toast(result.error || 'Failed to load instruments', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üìã Load NIFTY 500 Instruments';
        }
    }

    // ========== MISTAKES CRUD ==========
    async function loadMistakesList() {
        try {
            const resp = await fetch('/api/v2/mistakes');
            const mistakes = await resp.json();
            const el = document.getElementById('mistakes-list');
            if (!el) return;
            el.innerHTML = mistakes.map(m => `
                <div class="flex items-center justify-between bg-[#1f2937] px-3 py-2 rounded-lg">
                    <div>
                        <span class="text-sm font-medium">${m.name}</span>
                        ${m.description ? `<span class="text-xs text-gray-500 ml-2">${m.description}</span>` : ''}
                    </div>
                    <button onclick="removeMistake(${m.id})" class="text-red-400 hover:text-red-300 text-sm px-2" title="Remove">‚úï</button>
                </div>
            `).join('');
        } catch(e) { console.error('Error loading mistakes:', e); }
    }

    async function addMistake() {
        const nameEl = document.getElementById('new-mistake-name');
        const name = nameEl.value.trim();
        if (!name) return toast('Enter a mistake name', 'error');
        try {
            const resp = await fetch('/api/v2/mistakes', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name })
            });
            const result = await resp.json();
            if (result.success) { nameEl.value = ''; await loadMistakesList(); toast('Mistake added', 'success'); }
            else toast(result.error || 'Failed', 'error');
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function removeMistake(id) {
        try {
            await fetch(`/api/v2/mistakes/${id}`, { method: 'DELETE' });
            await loadMistakesList();
            toast('Mistake removed', 'success');
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    // ========== STRATEGIES CRUD ==========
    async function loadStrategiesList() {
        try {
            const resp = await fetch('/api/v2/strategies/global');
            const strategies = await resp.json();
            const el = document.getElementById('strategies-list');
            if (!el) return;
            el.innerHTML = strategies.map(s => `
                <div class="flex items-center justify-between bg-[#1f2937] px-3 py-2 rounded-lg">
                    <div>
                        <span class="text-sm font-medium">${s.name}</span>
                        ${s.description ? `<span class="text-xs text-gray-500 ml-2">${s.description}</span>` : ''}
                    </div>
                    <button onclick="removeStrategy(${s.id})" class="text-red-400 hover:text-red-300 text-sm px-2" title="Remove">‚úï</button>
                </div>
            `).join('');
        } catch(e) { console.error('Error loading strategies:', e); }
    }

    async function addStrategy() {
        const nameEl = document.getElementById('new-strategy-name');
        const name = nameEl.value.trim();
        if (!name) return toast('Enter a strategy name', 'error');
        try {
            const resp = await fetch('/api/v2/strategies/global', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name })
            });
            const result = await resp.json();
            if (result.success) { nameEl.value = ''; await loadStrategiesList(); toast('Strategy added', 'success'); }
            else toast(result.error || 'Failed', 'error');
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function removeStrategy(id) {
        try {
            await fetch(`/api/v2/strategies/global/${id}`, { method: 'DELETE' });
            await loadStrategiesList();
            toast('Strategy removed', 'success');
        } catch(e) { toast('Error: ' + e.message, 'error'); }
    }

    async function saveKiteCredentials() {
        const apiKey = document.getElementById('s-kite-api-key').value.trim();
        const apiSecret = document.getElementById('s-kite-api-secret').value.trim();

        if (!apiKey || !apiSecret) {
            toast('Please enter both API Key and Secret', 'error');
            return;
        }

        try {
            await api('PUT', '/account/info', {
                kite_api_key: apiKey,
                kite_api_secret: apiSecret
            });
            toast('API credentials saved!', 'success');
            // Reload settings
            const response = await api('GET', '/account/info');
            settings = [response];
            await render();
        } catch(e) {
            toast('Error saving credentials: ' + e.message, 'error');
        }
    }

    async function saveSettings() {
        const data = {
            account_name: document.getElementById('s-name').value,
            trading_capital: parseFloat(document.getElementById('s-capital').value),
            broker: document.getElementById('s-broker').value,
            risk_per_trade: parseFloat(document.getElementById('s-risk').value),
            max_monthly_drawdown: parseFloat(document.getElementById('s-dd').value),
            target_rr: parseFloat(document.getElementById('s-rr').value),
            currency: 'INR',  // Always INR for NSE
            market: 'IN',  // Always IN for NSE
            // Trade Limits
            risk_per_day: parseFloat(document.getElementById('s-risk-per-day').value),
            max_trades_per_day: parseInt(document.getElementById('s-max-trades-day').value),
            risk_per_week: parseFloat(document.getElementById('s-risk-per-week').value),
            max_open_positions: parseInt(document.getElementById('s-max-positions').value)
        };
        try {
            await api('PUT', '/account/info', data);
            // Reload settings
            const response = await api('GET', '/account/info');
            settings = [response];
            renderHeader();
            toast('Settings saved!', 'success');
        } catch(e) {
            toast('Error saving settings: ' + e.message, 'error');
        }
    }

    // ========== INDICATOR CONFIG ==========
    async function showIndicatorConfig() {
        const catalog = await api('GET', '/indicators/catalog');
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-body').innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">üìä Available Indicators</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <p class="text-gray-500 mb-6">These are all indicators available in each category. The <span class="text-green-400">‚òÖ recommended</span> ones are Elder's original choices.</p>
                
                ${Object.entries(catalog).map(([cat, data]) => `
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-blue-400">${cat}</h3>
                        <p class="text-gray-500 text-sm mb-2">${data.description} ‚Äî ${data.usage}</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${Object.entries(data.indicators).map(([id, ind]) => `
                                <div class="bg-[#1f2937] p-3 rounded-lg ${ind.recommended ? 'border border-green-500/30' : ''}">
                                    <div class="flex items-center gap-2">
                                        ${ind.recommended ? '<span class="text-green-400">‚òÖ</span>' : ''}
                                        <span class="font-medium">${ind.name}</span>
                                        ${ind.elder_original ? '<span class="text-xs bg-blue-500/20 text-blue-400 px-1 rounded">Elder</span>' : ''}
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">${ind.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // ========== KITE CONNECT STATUS ==========
    async function checkKiteStatus() {
        try {
            const status = await api('GET', '/v2/kite/status');
            const el = document.getElementById('kite-status');
            const marketEl = document.getElementById('market-status');

            // Update market status
            if (status.market) {
                if (status.market.is_open) {
                    marketEl.className = 'text-xs px-2 py-1 rounded bg-green-500/20 text-green-400';
                    marketEl.textContent = '‚óè NSE Open';
                } else {
                    marketEl.className = 'text-xs px-2 py-1 rounded bg-gray-700 text-gray-400';
                    marketEl.textContent = '‚óè NSE Closed';
                    marketEl.title = status.market.message;
                }
            }

            // Update Kite connection status
            if (status.connected) {
                el.className = 'text-xs px-2 py-1 rounded bg-green-500/20 text-green-400';
                el.textContent = '‚óè Kite Connected';
                el.onclick = null;
            } else {
                el.className = 'text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 cursor-pointer';
                el.textContent = '‚óè Kite Login Required';
                el.title = status.message + ' (Click to login)';
                el.onclick = () => showKiteLoginModal();
            }
        } catch(e) {
            const el = document.getElementById('kite-status');
            el.className = 'text-xs px-2 py-1 rounded bg-red-500/20 text-red-400';
            el.textContent = '‚óè Connection Error';
        }
    }

    async function showKiteLoginModal() {
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-body').innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">üîê Kite Connect Login</h2>
                        <p class="text-gray-500">Login to Zerodha Kite to enable trading</p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div class="space-y-4">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                        <h3 class="font-bold text-blue-400 mb-2">Step 1: Open Kite Login</h3>
                        <p class="text-sm text-gray-400 mb-3">Click the button below to open Kite login page. After logging in, you'll be redirected with a request token.</p>
                        <button onclick="openKiteLogin()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">
                            üîó Open Kite Login
                        </button>
                    </div>

                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                        <h3 class="font-bold text-green-400 mb-2">Step 2: Paste Request Token</h3>
                        <p class="text-sm text-gray-400 mb-3">After login, copy the request_token from the URL and paste it below.</p>
                        <div class="flex gap-2">
                            <input type="text" id="kite-request-token" placeholder="Paste request_token here..."
                                class="flex-1 px-3 py-2 bg-[#1f2937] border border-gray-600 rounded-lg text-white">
                            <button onclick="authenticateKite()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">
                                ‚úì Authenticate
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-700/50 rounded-lg p-4 text-sm text-gray-400">
                        <p><strong>Note:</strong> Kite login is required each trading day. The session expires at midnight.</p>
                        <p class="mt-2">Make sure you have configured your API Key and Secret in Settings first.</p>
                    </div>
                </div>
            </div>
        `;
    }

    async function openKiteLogin() {
        try {
            const response = await api('GET', '/v2/kite/login-url');
            if (response.success) {
                window.open(response.login_url, '_blank');
                toast('Kite login page opened. Complete login and copy the request_token.', 'info');
            } else {
                toast(response.error || 'Could not get login URL', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    async function authenticateKite() {
        const token = document.getElementById('kite-request-token').value.trim();
        if (!token) {
            toast('Please enter the request token', 'error');
            return;
        }

        try {
            const response = await api('POST', '/v2/kite/authenticate', { request_token: token });
            if (response.success) {
                toast('Successfully logged in to Kite!', 'success');
                closeModal();
                await checkKiteStatus();
            } else {
                toast(response.error || 'Authentication failed', 'error');
            }
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // ========== INIT ==========
    async function init() {
        try {
            const account = await api('GET', '/account/info');
            settings = [account];
        } catch(e) {
            console.log('Could not load account info:', e);
            settings = [{trading_capital:500000, risk_per_trade:2, currency:'INR'}];
        }

        const cl = await api('GET', '/checklist');
        checklist = cl.items || {};
        await checkKiteStatus();
        renderNav();
        renderHeader();
        await render();

        // Check Kite status every 30 seconds
        setInterval(checkKiteStatus, 30000);
    }

    init();
    document.getElementById('modal').onclick = e => { if(e.target.id==='modal') closeModal(); };
    </script>
</body>
</html>
